<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改价格</title>
	<!--预约房间修改价格-->
    <script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
	<style>
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
		}

		input[type="number"] {
			-moz-appearance: textfield;
		}
		.table{
			display: table;
			white-space: nowrap;
			padding: 10px;
		}
		.table-row{
			display: table-row;
			/*overflow: scroll;*/

		}
		.cell{
			display: table-cell;
			border: #cccccc 1px solid;
			/*width: 180px;*/
			height: 40px;
			vertical-align: middle;
			text-align: center;
			/*display: inline-block;*/
		}
		.desc{
			position: relative;
		}
		.desc:before{
			content: "";
			position: absolute;
			width: 109px;
			left: -4px;
			top: 19px;
			transform: rotate(21deg);
			transform-origin: bottom center;
			border-bottom: 1px solid #ccc;
		}
		.desc b:nth-of-type(2){
			position: absolute;
			bottom: -7px;
			left: 1px;
		}
		.desc b:nth-of-type(1){
			position: absolute;
			right: 1px;
			top: -7px;
		}
		.cell input{
			width: 50px;
		}
		.cell .wp{
			width: 100px;height: 40px;line-height:40px;
		}
	</style>
</head>
<body style="width: 960px;">
		<div style="padding: 10px 0 0 20px">
			<span>将每日房价统一修改为:&yen;</span>
			<input type="number" id="unify" style="width: 100px;height: 30px;">
			<button class="layui-btn" onclick="dealRsData(1);">批量修改</button>
			<button class="layui-btn" onclick="dealRsData(2);">恢复标准价</button>
		</div>

    	<form>


			<div>
				<section class="table" id="table">

				</section>

				<section style="padding: 20px;position: absolute;bottom: 0px;right: 0px;">
					<button class="layui-btn layui-btn-normal" lay-submit  lay-filter="formsubmit" >确定</button>
					<button class="layui-btn layui-btn-warm" onclick="no();">取消</button>
				</section>
			</div>
		</form>

<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script>
		var $,element,$b,$remove,selectDom,
            dayNumber=getUrl("dayNumber"),

            rsd;

  	  layui.use(['element', 'jquery', 'table','form'], function () {
          element = layui.element,
              $ = jQuery = layui.$,
              form = layui.form,
              $b = $("#body");

          	  $table = $("#table");


		      getDatas();
			  form.on('submit(formsubmit)', function(data) {

				  submitInfo()
				  return false;
			  });
      })
        function dealDays() {

        	var str = '<div id="rtitle" class="table-row"><div class="cell "><div class="desc wp"><b>日期</b><b>房型</b></div></div>';
			for(var i=0;i<dayNumber;i++){
                str+= ['<div class="cell"><div class="wp">',

                    DateToLStr(i*86400000).split(" ")[0],
                    '</div></div>'].join("")
			}
            $table.append(str+'</div>');

        }
        function DateToLStr(t) {
  	      	var dt = null;
            // new Date(decodeURIComponent(getUrl("startTime"))).getTime();
            // DateToLStr(new Date(Date.now()+i*86400000)).split(" ")[0];
            if(!!getUrl("startTime")){
				dt = new Date(new Date(decodeURIComponent(getUrl("startTime"))).getTime()+t);
            }else{
                dt = new Date(Date.now()+t);
			}
            try {
                var y, m, m1, d, d1, h, h1, mm, mm1, s, s1;
                y = dt.getFullYear();
                m = dt.getMonth() + 1; //1-12
                d = dt.getDate();
                h = dt.getHours();
                mm = dt.getMinutes();
                s = dt.getSeconds();

                m1 = (m < 10 ? "0" + m : m);
                d1 = (d < 10 ? "0" + d : d);
                h1 = (h < 10 ? "0" + h : h);
                mm1 = (mm < 10 ? "0" + mm : mm);
                s1 = (s < 10 ? "0" + s : s);
                return "" + y + "/" + m1 + "/" + d1 + " " + h1 + ":" + mm1 + ":" + s1;
            } catch (e) {
                console.log("error");
                return "";
            }
        }
		function getDatas() {

  	      if(localStorage.modifyPrice){
              rsd = JSON.parse(localStorage.modifyPrice);

              dealRsData();
              return;
          }

        }

        function dealRsData(ff) {

            var sRooms = JSON.parse(localStorage.modifyPrice);
            $table.empty();
            dealDays();
            var str = '';
            sRooms.map(function(c,i){
                var name = '';
                // if(c.name){
                    // name = c.name
				// }else
				    if(c.roomTypeName){
                    name = c.roomTypeName;
				}else if(c.roomType){
                    name = c.roomType
				}
                str+=  ['<div class="table-row">',
                    '<div class="cell">',
                    name,
                    '</div>',
                    _deal(c),
                    '</div>'].join("");
            });

            $table.append(str);
            function _deal(r) {

                var _str = '';
                for(var j in r){

                    if(j.split('/').length>2&&j.indexOf('y')==-1){
                        _str+=['<div class="cell">',
                            '<input type="number" data-price="',
                            r['y'+j] ? r['y'+j] : r[j],
							'" data-name="',
                            r['roomTypeName'],
							'" data-date="',
                            j,
							'" class="rti',
							r['roomTypeId'],
							'" value="',
                       		 ff==1 ? $("#unify").val() : (ff==2&&r['y'+j]) ? r['y'+j] : r[j],
                            '"><span>/',
                            r['y'+j] ? r['y'+j] : r[j],
                            '</span>',
                            '</div>'].join("");
                    }
                }
                return _str;
            }
        }


        function submitInfo() {
  	      var _arr = [];

            rsd.map(function (c,i) {
                var _o={
                    roomTypeId:c['roomTypeId'],
					roomTypeName:c['roomTypeName'],
                    id:c['roomTypeId'],
                    name:c['roomTypeName']
                };

                try{
					$(".rti"+c['roomTypeId']).each(function () {

						_o[this.dataset['date']]=this.value;
						_o['y'+this.dataset['date']] = this.dataset['price'];
					})
                }catch (e){
                    console.log(e)
                }
                _arr.push(_o);
            })
			localStorage.setItem("modifyPrice",JSON.stringify(_arr));
            parent.parModifyPrice();
            no();
        }
</script>
</body>
</html>