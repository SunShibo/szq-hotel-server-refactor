<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <title>预约入住</title>
    <script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
    <style>
        /*.layui-laydate-footer {*/
            /*display: none !important;*/
        /*}*/

        .layui-colla-title {
            background: transparent;
            text-align: left;
            border: 0px;
        }
    </style>
</head>

<body>

<nav class="hotel-nav">

    <ul class="layui-nav " lay-filter="" id="navMenu">


    </ul>
    <ul class="layui-nav layui-layout-right">
        <li class="layui-nav-item">
            <a href="javascript:;" id="hotelusername"></a>
            <dl class="layui-nav-child">
                <dd>
                    <a href="javascript:;" id="updateHotel">更换酒店</a>
                </dd>
                <dd>
                    <a href="javascript:;" id="updatePass">修改密码</a>
                </dd>
                <dd>
                    <a href="javascript:;" class="outLogin">退出登录</a>
                </dd>
            </dl>
        </li>
    </ul>
</nav>
<div style="height: 70px;"></div>
<form class="layui-form" lay-filter="data" id="myform">
    <div class="layui-tab layui-tab-card" lay-filter="rzfs">
        <ul class="layui-tab-title">
            <!--<li class="center-tab-list " lay-id="1">直接入住</li>-->
            <li class="center-tab-list layui-this" lay-id="2">预约入住</li>
        </ul>
        <section class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div class="line-block portrait-wp">
                    <img id="image" src="images/portrait.jpg" width="140" height="160"/>
                    <p class="portrait-lev" id="userLevel"></p>
                </div>
                <div class="line-block right-content">
                    <div class="layui-form-item layui-form">
                        <div class="layui-inline">
                            <label class="layui-form-label require">姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="orderPlacer"  id="orderPlacer" lay-verify="required|orderPlacer" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">证件类型</label>
                            <div class="layui-input-inline">
                                <select name="certificateId" id="certificateId">

                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label ">证件号</label>
                            <div class="layui-input-inline">
                                <input type="text" name="IDNumber" onblur="idFlag(1)" id="IDNumber" onchange="clearRoomInfo();" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label require">电话</label>
                            <div class="layui-input-inline">
                                <input type="tel" name="phone" onblur="idFlag(2)"  id="phone" autocomplete="off"  onchange="clearRoomInfo();"  lay-verify="required" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline fr">
                            <a class="layui-btn layui-btn-primary " id="readCre">读取证件</a>
                            <a class="layui-btn layui-btn-warm" onclick="clearData()">清除资料</a>
                        </div>

                    </div>
                </div>

            </div>

        </section>
        <section class="border-e6 mg10 pd10">
            <p class="border-e6 order-title">订单信息</p>
            <div class="layui-form-item layui-form">
                <div class="layui-inline" style="padding-left: 20px;">
                    <input type="checkbox" name="" title="合作机构" lay-skin="primary" id="hhzzjjgg" lay-filter="hzjg">
                    <span style="background: #ccc;width: 200px;height: 45px;line-height: 45px;"></span>
                </div>
                <div class="layui-inline channelSelect layui-hide" >
                    <select id="channelSelect" lay-filter="floor" lay-search>
                    </select>
                </div>
                <div class="layui-input-inline" style="float: none">
                    <input type="text" name="OTA"id="ota" autocomplete="off" class="layui-input" placeholder="OTA">
                </div>
            </div>
            <div class="pd20  layui-form layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">入住方式</label>
                    <div class="layui-input-inline" style="width:auto;">
                        <input type="radio" name="checkType" value="day" title="全天房" checked="">
                        <input type="radio" name="checkType" value="hour" title="钟点房">
                        <input type="radio" name="checkType" value="free" title="免费房">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">接单员</label>
                    <div class="layui-input-inline">
                        <input type="text" name="clerkOrderingName" id="clerkOrderingName" autocomplete="off" class="layui-input">
                    </div>
                </div><br>
                <div class="layui-inline">
                    <label class="layui-form-label">客源</label>
                    <div class="layui-input-inline">
                        <input type="text" value="散客 " name="channel" id="channel" readonly="" style="background: #eee;" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">渠道</label>
                    <div class="layui-input-inline">
                        <input type="text" name="channel1" id="channel1" value="预约入住" readonly="" style="background: #eee;" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <br>

                <div class="layui-inline ">
                    <label class="layui-form-label">入住时间</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" name="startTime" id="startTime"  readonly>
                    </div>
                </div>
                <div class="layui-inline typea ">
                    <label class="layui-form-label">离店时间</label>
                    <div class="layui-input-inline">
                        <input type="text" class="layui-input" name="leaveDate1" id="leaveDate1"  readonly>
                    </div>
                </div>

                <div class="layui-inline typea">
                    <label class="layui-form-label">共计</label>
                    <div class="layui-input-inline" >
                        <input  style="display: inline-block;width: 50px" readonly type="number" name="dayNumber1" id="days1" autocomplete="off" class="layui-input"><span style="">天</span>
                    </div>
                </div>
                <div class="layui-inline typeb layui-hide">
                    <label class="layui-form-label">共计</label>
                    <div class="layui-input-inline" >
                        <input  style="display: inline-block;width: 50px" readonly type="number" name="dayNumber2" value="4" id="days2" autocomplete="off" class="layui-input"><span style="">小时</span>
                    </div>
                </div>
                <br>
                <div class="layui-inline">
                    <label class="layui-form-label">预约备注</label>
                    <div class="layui-input-inline">
                        <input type="text" name="subscribeRemark" id="subscribeRemark"  style="width: 515px;"  autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
        </section>
        <section class="border-e6 mg10 pd10">
            <p class="border-e6 order-title">房间信息
                <a class="fr" style="overflow: hidden;margin-right: 30px;font-size: 20px;">总房价:<span
                        id="totalPrice">0</span>元</a>
                <a class="fr layui-hide" id="ydzj"
                   style="overflow: hidden;margin-right: 30px;font-size: 20px;">预定总价:<span id="yuyuePrice">0</span>元</a>
            </p>

            <table id="test" lay-filter="fjxx"></table>
            <div>
                <a class="layui-btn" onclick="selectRoom()">选房</a>
                <a class="layui-btn" onclick="modifyPrice()">改价</a>
                <a class="layui-btn" onclick="remarks()">备注</a>
                <!--<a class="layui-btn" onclick="afterComeIn()">批量稍后入住</a>-->
            </div>
        </section>
        <section style="padding: 20px;overflow: hidden;">
            <a class="layui-btn layui-btn-normal fr" style="margin: 0 20px;padding: 0 50px;" onclick="cancel();">取消</a>
            <button class="layui-btn layui-btn-normal fr" id="btnSave" style="margin: 0 20px;padding: 0 50px;"
                    lay-submit="" lay-filter="checksubmit">入住
            </button>
        </section>

    </div>
</form>

</body>

</html>
<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="tonglai">同来</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="yichu">移除</a>
</script>
<script>
    var customer_source_before = "散客";//散客-渠道-会员
    var allChannel =[];
    var yuyueData = {};
    var element, laydate, form, $, layer, index, table, data = [],roomTypeFlag=[];
    var state = {
        channel: 2// 1电话入住  2步入 3网络
        , roomType: 1//1,全天房,2,钟点房，3,免费房
        , source: 1// 1散客,2会员
        , user: ''
        , tl: []
        , curtl: 0
        , selRow: []
        , totalPrice: 0// 房价总金额
        , idFlag: false//标记证件号是否查询到会员信息了
        , orderNumber: 0//订单号码
        , hzjg: false//是否勾选合作机构
        , yuyueChannel: 0
    };
    var userInfo = {};//会员信息
    var sRooms = [];//已选房间信息
    var customs = [];//同来人员信息
    var saleInfo = [];//折扣信息
    var currHZJG = "";

    var currSel = {//当前选房的过滤条件
        inWay:0,//入住方式钟点房？全天? 免费？
        dayNumber:1,//入住天数
        memberRankId:0,//会员级别id
        cnId:0,//合作机构
        roomIds:getUrl("roomId"),
        ok:true
    };
    layui.use(['element', 'form', 'laydate', 'jquery', 'layer', 'table'], function () {
        element = layui.element,
            laydate = layui.laydate,
            form = layui.form,
            $ = layui.jquery,
            layer = layui.layer,
            table = layui.table;

        if (getUrl("random")) {


                $("#phone").val(decodeURIComponent(getUrl('phone')))
                idFlag(2);


        }

        function getCheckinData() {

            var arr = JSON.parse(JSON.stringify(sRooms));
            for(var i=0;i<arr.length;i++){
                var par = JSON.parse(JSON.stringify(arr[i]));
                if(!isNaN(arr[i]['roomType'])){
                    arr[i]['roomTypeId'] = arr[i]['roomType'];
                }
                arr[i]['checkInPersonBOS'] = getPersonData(arr[i]['roomId']);
                // arr[i]['everydayRoomPriceBOS'] = getRoomPriceData(par);
            }
            return arr;

        }

        function aabb() {
            return [];
        }

        //参数是某间房---everydayRoomPriceBOS---得到每间房屋每天的价格
        function getRoomPriceData(v) {
            // debugger;
            var o = JSON.parse(JSON.stringify(yuyueData.orderChildBOS));
            var sr  = sRooms;
            var n = [];
            var flag = true;
            var modifyPrice = [];
            if(localStorage.modifyPrice!=''){
                modifyPrice = JSON.parse(localStorage.modifyPrice);
            }


                if(o[0]['roomId'] == 0 ){
                    //预定的是房型

                    //先判断是否改过价格-改过价格以改的价格为准
                    if(modifyPrice.length==0){

                        //没修改过价格---并且这个页面没有点过修改价格
                        var days = $("#days1").val();
                        var time = $("#startTime").val();
                        var money = 0;
                        if($("input[name='checkType']:checked").val()=="hour"){
                            days = 1;
                            money = v['hourRoomPrice']
                        }else if($("input[name='checkType']:checked").val()=="free"){
                            money = 0;
                        } else if($("input[name='checkType']:checked").val()=="day"){
                            money = v['basicPrice']
                        }
                        var arr = [
                            {
                                money:money,
                                time:time.split(" ")[0]
                            }
                        ];

                        for(var i=1;i<Number(days);i++){
                            arr.push({
                                money:money,
                                time:addDate(new Date(time),i)
                            })
                        }

                        return arr;
                    }else{
                 //修改过价格
                        for(var j=0;j<modifyPrice.length;j++){
                            if(modifyPrice[j]['roomTypeId'] == sr[i]['roomType']){

                                break;
                            }
                        }
                    }


                    if(o[i]['roomTypeId']==v['roomTypeId']){
                        if(localStorage.modifyPrice==""){
                            //没有手动修改过价格
                            for(var j=0;j<sr[i]['everydayRoomPriceBOS'].length;j++){
                                var e = JSON.parse(JSON.stringify(sr[i]['everydayRoomPriceBOS'][j]));
                                e.time = DateToLStr(new Date(e.time.time)).split(" ")[0];
                                n.push(e)
                            }
                            flag = false;
                            // break;
                        }else{
                            //修改过价格。
                        }
                    }

                }
                else{

                    //预定的是房间
                    if(o[i]['roomId']==v['roomId']){
                        for(var j=0;j<o[i]['everydayRoomPriceBOS'].length;j++){
                            var e = JSON.parse(JSON.stringify(o[i]['everydayRoomPriceBOS'][j]));
                            e.time = DateToLStr(new Date(e.time.time)).split(" ")[0];
                            n.push(e)
                        }
                        flag = false;
                    }
                }

            //预定信息中没有对应的数据
            if(flag){
                debugger;
            }
            return n;
        }
        function getPersonData(v) {
            var c = JSON.parse(JSON.stringify(customs));
            var n = [];
            for(var i=0;i<c.length;i++){
               if(c[i]['roomId']==v){
                    c[i]['certificateNumber'] = c[i]['credentialNo'];
                    c[i]['phone'] = c[i]['phoneNumber'];
                    c[i]['certificateType'] = c[i]['certificateId'];
                    n.push(c[i]);
               }

            }
            return n;
        }

        form.on('submit(checksubmit)', function (data) {

            var d = data.field;
            d.id = yuyueData.id;
            d.type = "reservation";
            d.IDNumberType = d.certificateId + "";
            d.checkTime = d.startTime;
            d.checkOutTime = d.leaveDate1;
            d.dayCount = d.dayNumber1 + "";
            d.orderType = "subscribe";
            if(userInfo&&userInfo.id) d.membersId = userInfo.id;
            if (state.hzjg) {
                d.memberIdOrOrganizationId  = $("#channelSelect").val();
            }
            if (sRooms.length == 0 || !sRooms[0]['roomId']) {
                layer.alert("还没有选房")
                return false;
            }


            var typeids = [];
            var checktype = $("input[name='checkType']:checked").val();
            for(var i=0;i<sRooms.length;i++){
                if(sRooms[i]['roomTypeId']){
                    if(typeids.indexOf(sRooms[i]['roomTypeId'])==-1){
                        typeids.push(sRooms[i]['roomTypeId'])
                    }
                }else {
                    if(typeids.indexOf(sRooms[i]['roomType'])==-1){
                        typeids.push(sRooms[i]['roomType'])
                    }
                }

            }
            var index = layer.load(1,{time:10*1000});
            $.ajax({
                data: {
                    phone:document.getElementById("phone").value.trim(),
                    startTime:document.getElementById("startTime").value,//入住时间,
                    dayNum:checktype=='hour'?1:document.getElementById("days1").value,
                    typeIds:typeids.join(","),
                    orderId:yuyueData.id,
                    checkType:checktype,
                },
                type: "POST",
                dataType: "JSON",
                url: 'updatePrice/updatePrice',
                complete: function () {
                    layer.close(index);
                },
                success: function (rs) {
                    layer.close(index);
                    if (!rs.success) {
                        layer.alert(rs.errMsg)
                    }else{
                        // debugger;
                        var checkinData = getCheckinData();
                        for(var i=0;i<checkinData.length;i++){
                            for(var j=0;j<rs.data.length;j++){
                                if(checkinData[i]["roomTypeId"] == rs.data[j]['roomTypeId']){

                                    var c = rs.data[j];
                                    var arr = [];
                                    for(var b in c){
                                        if(b.indexOf("/")>-1&&b.indexOf("y") ==  -1){
                                            arr.push({
                                                time:b,
                                                money:c[b]
                                            })
                                        }
                                    }

                                    checkinData[i]['everydayRoomPriceBOS'] = arr;
                                    break;
                                }
                            }
                        }

                        d.OrderChildJSON = JSON.stringify(checkinData);
                        console.log("以下是预约入住参数")
                        console.info(d)
                        var index = layer.load(1,{time:10*1000});
                        $.ajax({
                            data: d,
                            type: "POST",
                            dataType: "JSON",
                            url: api.checkInYuYue,
                            beforeSend: function () {
                                $("#btnSave").addClass('layui-btn-disabled');
                            },
                            complete: function () {
                                layer.close(index);
                                $("#btnSave").removeClass('layui-btn-disabled');
                            },
                            success: function (rs) {
                                layer.close(index);
                                if (!rs.success) {
                                    layer.alert(rs.errMsg)
                                    return false;
                                }
                                payHtml(rs.data);
                            }
                        });


                    }
                }
            });
            return false;


        });



        $("#readCre").on("click", function () {
            //读取身份证信息 传入添加位置dom
            var CVR_IDCard = IDCardReader();
            if(!!CVR_IDCard){
                clearForm();
                var birthday = formatDate(CVR_IDCard.Born);
                form.val('data', {
                    name: CVR_IDCard.Name,
                    certificateId: 1,
                    credentialNo: CVR_IDCard.CardNo,
                    gender: CVR_IDCard.Sex,
                    birthday: birthday,
                    nation: CVR_IDCard.Nation,
                    address: CVR_IDCard.Address,
                });
                $("#image").prop('src', 'data:image/jpeg;base64,' + CVR_IDCard.Picture);
                // var _i = layer.load();
                var url1 = api.yueCheckIn;//预约
                // 查询
                var credentialNo = document.getElementById("credentialNo").value;
                // querySaleInfo(credentialNo)
                if (credentialNo == '') {
                    layer.msg('证件号码不能为空', {icon: 2, shift: 6});
                    return;
                } else {
                    //网络入住
                    url1 += "&certificateNumber=" + credentialNo
                }
                $.getJSON(url1+"&random="+Date.now(), function (rs) {

                    if(rs.data.memberId){
                        $("#source").val(rs.data.memberName);
                        userInfo.meLeval = rs.data.memberId;
                    }
                    if (!rs.success) {
                        layer.alert('没有查到预定信息', {icon: 2, shift: 6});
                        return;
                    }
                    roomTypeFlag = rs.data.subscribes;
                    renderSchedule(rs.data.subscribes)
                    try{
                        $("#phoneNumber").val(rs.data.phoneNumber);
                        $("#credentialNo").val(rs.data.certificateNumber);
                    }catch (e){}
                })
            }

        })


        //监听表格工具条
        table.on('tool(fjxx)', function (obj) {
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象
            if (layEvent === 'tonglai') {
                if(obj.data.roomId==0){
                    layer.msg("还没有选房")
                    return;
                }
                layer.open({
                    area: ['1000px', '420px'],
                    type: 2,
                    content: "iframe_togetherByAappoint.html?roomid=" + data.roomId + "&a=" + Date.now(),
                    title: "同来宾客"
                })
            } else if (layEvent === 'yichu') { //删除
                if (state.channel == 1) {
                    layer.msg('预约入住不可以删除', {icon: 2, shift: 6});

                }
                layer.confirm('真的删除行么', function (index) {
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    // removeRooms(obj.data.roomId)
                    if(sRooms[0].roomId){
                        removeRooms(obj.data.roomId)
                    }else{
                        removeRooms2(obj.data.id)
                    }
                });
            }
        });

        tableObj = table.render({
            elem: '#test'
            , data: data
            , limit: 10000
            , method: 'POST'
            , cols: [[
                {type: 'checkbox'}
                , {field: 'roomNum', title: '房号',}
                , {field: 'roomTypeName', title: '房型'}
                ,{
                    title: '房价',
                    align: 'center',
                    templet: function (data) {
                        var price = data.basicPrice;
                        if($("input[name='checkType']:checked").val()=="hour")price = data.hourRoomPrice;
                        if($("input[name='checkType']:checked").val()=="free")price = 0;
                        return price;
                    }
                }
                , {field: 'name', title: '姓名',}
                , {field: 'credentialNo', title: '证件号',}
                , {field: 'phoneNumber', title: '手机号',}
                , {field: 'remark', title: '备注',}
                , {field: '', title: '数据id',hide:true}
                , {title: '操作', toolbar: '#barDemo', width: 160}
            ]]
            , page: false
        });

    });


    function selectRoom() {

        var _leaveTime;

        if(document.getElementById("orderPlacer").value==''){
            layer.msg('姓名未填写', {icon: 2,shift:6});
            return;
        }
        if(document.getElementById("phone").value==''){
            layer.msg('手机号未填写', {icon: 2,shift:6});
            return;
        }
        if(document.getElementById("startTime").value==''){
            layer.msg('入住时间未填写', {icon: 2,shift:6});
            return;
        }
        if($("input[name='checkType']:checked").val()!="hour"){
            if(document.getElementById("leaveDate1").value==''){
                layer.msg('离店时间未填写', {icon: 2,shift:6});
                return;
            }
            dayNumber = $("#dayNumber1").val();
        }else{
            _leaveTime = DateToLStr(new Date(new Date(document.getElementById("startTime").value).setHours(new Date(document.getElementById("startTime").value).getHours() + 4)))
        }
        var selectRoomData =  {
            checkTime:	document.getElementById("startTime").value,//入住时间,
            endTime:_leaveTime?_leaveTime:document.getElementById("leaveDate1").value,
            phone:document.getElementById("phone").value.trim(),
            roomAuxiliaryStatus:$("input[name='checkType']:checked").val(),
            orderId:yuyueData.id
        }
        localStorage.yyrzxf = JSON.stringify(selectRoomData);
        console.log('下面是预约入住选房的数据')
        console.log(selectRoomData	)
        layer.open({
            area: ['820px', '520px'],
            type: 2,
            content:  'iframe_pick_room2.html?vv='+Date.now()+"&parameter=yyrzxf",
            title: "预约入住选房"
        })
    }


    //批量稍后入住
    function afterComeIn() {
        if (state.selRow.length == 0) {
            layer.msg("您还没有勾选房间");
            return;
        }
        var arr = state.selRow;
        layer.confirm('确定稍后入住？', function (index) {
            console.info(state.selRow)
            // return;
            for(var j=0;j<arr.length;j++){
                var obj = arr[j];
                removeRooms2(obj.id)
                var _f = true;
                for(var i=0;i<roomTypeFlag.length;i++) {
                    if (obj.roomType) {
                        if (obj.roomType == roomTypeFlag[i].roomType) {
                            _f = false;
                        }
                    } else {
                        if (obj.houseTypeId == roomTypeFlag[i].roomType) {
                            _f = false;
                        }
                    }
                }
                if(_f){
                    layer.alert("没有预定的房型，不能稍后入住")
                    return false;
                }

                $.getJSON(api.waitIn+"&random="+Date.now()+"&id="+obj.id,function (rs) {

                    if(!rs.success){
                        alert(rs.errMsg)
                        return false;
                    }
                    layer.msg("操作成功");

                    layer.close(index);




                })
            }
        });
    }


    function parSelectRoom(v) {
        var checktype = $("input[name='checkType']:checked").val();
        sRooms =  v ;
        // console.info("选房后获取了如下数据↓")
        // console.info(sRooms)

        var typeids = [];
        for(var i=0;i<sRooms.length;i++){
            if(typeids.indexOf(sRooms[i]['roomTypeId'])==-1){
                typeids.push(sRooms[i]['roomTypeId'])
            }
        }
        var index = layer.load(1,{time:10*1000});
        $.ajax({
            data: {
                phone:document.getElementById("phone").value.trim(),
                startTime:document.getElementById("startTime").value,//入住时间,
                dayNum:checktype=='hour'?1:document.getElementById("days1").value,
                typeIds:typeids.join(","),
                orderId:yuyueData.id,
                checkType:checktype,
            },
            type: "POST",
            dataType: "JSON",
            url: 'updatePrice/updatePrice',
            beforeSend: function () {
            },
            complete: function () {
                layer.close(index);
            },
            success: function (rs) {
                layer.close(index);
                if (!rs.success) {
                    layer.alert(rs.errMsg)
                }else{
                    // debugger;
                    for(var i=0;i<sRooms.length;i++){
                        for(var j=0;j<rs.data.length;j++){
                            if(sRooms[i]['roomTypeId']== rs.data[j]['roomTypeId']){

                                sRooms[i]['basicPrice'] = sRooms[i]['hourRoomPrice'] = rs.data[j]['price'];
                            }
                        }
                    }
                    sRooms1 = JSON.parse(JSON.stringify(sRooms));
                    setCustomInfo();
                    calcPrice();
                }
            }
        });

    }



    function setCustomInfo() {

        var tem = [];
        if(customs.length!=0){
            if(customs[0].roomId!=0)return;
            for(var i=0;i<customs.length;i++){
                for(var j=0;j<sRooms.length;j++){
                    if(tem.indexOf(sRooms[j].roomId) > -1) continue;
                    if(customs[i].typid==sRooms[j].roomType){
                        customs[i].roomId = sRooms[j].roomId;
                        tem.push(sRooms[j].roomId);
                        break;
                    }
                }
            }
        }
    }



    function  updataTableByTogether(rid) {

        var d = sRooms, c = customs;
        for (var i = 0; i < d.length; i++) {
            if(d[i].roomId == rid){
                for (var j = 0; j < c.length; j++) {
                    if (rid == c[j].roomId) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
            }
        }
        tableObj.reload({data: JSON.parse(JSON.stringify(d))})
        state.selRow = [];
    }

    function removeRooms(id) {
        var d = sRooms;
        var dd = [];
        for (var i = 0; i < d.length; i++) {
            if (d[i].roomId != id) {
                dd.push(d[i]);
            }
        }
        sRooms = dd;
        calcPrice();
    }
    function removeRooms2(id) {
        var d = sRooms;
        var dd = [];
        for (var i = 0; i < d.length; i++) {
            if (d[i].id != id) {
                dd.push(d[i]);
            }
        }
        sRooms = dd;
        calcPrice();
    }
    function checkPeopleNum() {
        var s = sRooms, c = customs;
        for (var i = 0; i < s.length; i++) {
            var f = true;
            for (var j = 0; j < c.length; j++) {
                if (s[i].roomId == c[j].roomId) {
                    f = false;
                    if (c[j]['name'] == ''
                        || c[j]['certificateId'] == ''
                        || c[j]['phoneNumber'] == ''
                        || c[j]['credentialNo'] == '')
                        return [false, s[i].roomNum]
                }
            }
            if (f) {
                return [false, s[i].roomNum]
            }
        }
        return [true];

    }

    function findPeopleByRoomId(id) {
        var d = [];
        var c = customs;
        for (var i = 0; i < c.length; i++) {
            if (c[i].roomId == id) d.push(c[i])
        }
        return d;
    }

    function eachReamrk(arr,str) {

        var d = customs;
        var arr1 = new Array();
        customs = arr1.concat(customs)
        for(var i=0;i<arr.length;i++){
            var flag = true;
            for(var j=0;j<d.length;j++){
                if(arr[i].roomId==d[j].roomId){
                    d[j].remark = str;
                    customs[j] =d[j];
                    flag = false;
                }
            }
            if(flag){
                customs.push({
                    remark:str,
                    address: "",
                    certificateId: "",
                    credentialNo: "",
                    name: "",
                    phoneNumber: "",
                    roomId: arr[i].roomId
                })
            }
        }
        calcPrice();
    }

    //s=1证件号码，s=2手机号码
    function idFlag(s) {
        var v = $("#IDNumber").val().trim();
        var p = $("#phone").val().trim();
        var _url = api.yueCheckIn;
       if (s == 2 ) {
           if(p.length<1){
               return;
           }
           _url += "&mobile=" + p +"&random="+Date.now();
        } else if (s == 1) {
            //证件号码网络入住
           if(v.length<1){
               return;
           }
           _url += "&idNumber=" + v +"&random="+Date.now();
        }
        $.getJSON(_url, function (rs) {
            if(!rs.data) {
                layer.alert('没有查到预定信息', {icon: 2, shift: 6});
                return;
            }
            yuyueData = rs.data;
            if(rs.data.memberId){
                $("#source").val(rs.data.memberName);
                userInfo.meLeval = rs.data.memberId;
            }

            if (!rs.success) {
                layer.alert('没有查到预定信息', {icon: 2, shift: 6});
                return;
            }
            roomTypeFlag = rs.data;
            renderSchedule(rs.data);

        })

    }


    function renderSchedule(v) {
        if (v.length == 0) {
            layer.msg('没有查询到预定信息', {icon: 2, shift: 6});
            return;
        } else {
            layer.msg('预定信息查询成功', {icon: 1});
        }
        state.channel = v.channel;
        state.yuyueChannel = '预约入住';
        state.orderNumber = v.id;
        var d = v;
        sRooms = [];//已选房间信息
        customs = [];//同来人员信息
        saleInfo = [];//折扣信息
        $("#orderPlacer").val(d.orderPlacer);
        $("#certificateId").val(d.IDNumberType);
        $("#IDNumber").val(d.IDNumber);
        $("#phone").val(d.phone);
        $("#clerkOrderingName").val(d.clerkOrderingName);
        $("#subscribeRemark").val(d.subscribeRemark);
        try{
            $("#startTime").val(DateToLStr(new Date(d.checkTime.time)));
            $("#leaveDate1").val(DateToLStr(new Date(d.checkOutTime.time)));
        }catch (e){}
        $("#days1").val(d.dayCount);
        $("#totalPrice").val(d.totalPrice);
        $("#ota").val(d.OTA);
        $("#channel").val(d.channel);
        if(d.checkType=='hour'){
            $(".typea").addClass("layui-hide")
            $(".typeb").removeClass("layui-hide")
        }else{
            $(".typeb").addClass("layui-hide")
            $(".typea").removeClass("layui-hide")
        }
        $("input[name=checkType][value=" + d.checkType + "]").prop('checked', true);
        if (d.memberIdOrOrganizationId) {
            state.hzjg = true;
            $("#hhzzjjgg").prop("checked", true);
            form.render();
            $(".channelSelect").removeClass("layui-hide")
            setTimeout(function () {
                $("#channelSelect").val(d.memberIdOrOrganizationId);
                form.render();
            }, 2000)
         }
         if(d.membersId){
            //会员预约
             var v = '';
             //查询是否是会员
             $.getJSON(api.queryIdFlag + "&query=" + d.phone + "&random="+Date.now(), function (rs) {

                 if (rs.success&&rs.data.memberBOS.length==1) {
                     userInfo = rs.data.memberBOS[0];
                     $("#userLevel").text(userInfo.memberLevelName);
                     form.render();
                     state.idFlag = true;
                 } else {
                     state.idFlag = false;
                     userInfo = {};
                     $("#userLevel").text("");
                 }
             })
         }
        form.render();
        // return false;
        var orderChildBOS = d.orderChildBOS;
        _yuyuePrice = 0;
        for (var i = 0; i < orderChildBOS.length; i++) {

            var b = orderChildBOS[i];

            for(var j=0;j<b.everydayRoomPriceBOS.length;j++){
                var erp = b.everydayRoomPriceBOS[j];
                _yuyuePrice += erp.money;
            }

            sRooms.push({
                roomType: b.roomTypeId,
                roomId: b.roomId,
                price: b.everydayRoomPriceBOS[0].money,
                basicPrice:b.everydayRoomPriceBOS[0].money,
                hourRoomPrice:b.everydayRoomPriceBOS[0].money,
                roomNum: b.roomName,
                roomTypeName: b.roomTypeName,
                id:b.id,
                remark:b.remark
            })
        }

        sRooms1 = JSON.parse(JSON.stringify(sRooms));

        for(var i=0;i<sRooms1.length;i++){
            var orderId = sRooms1[i]['id']+"";
            sRooms1[i]['orderId'] = orderId;
            sRooms1[i]['id'] = sRooms1[i]['roomId']+"";
            sRooms1[i]['basicPrice'] = sRooms1[i]['price']+"";
            sRooms1[i]['hourRoomPrice'] = sRooms1[i]['price']+"";
            var roomType = sRooms1[i]['roomTypeName']+"";
            var roomTypeId = sRooms1[i]['roomType']+"";
            sRooms1[i]['roomType'] = roomType;
            sRooms1[i]['roomName'] = sRooms1[i]['roomNum']+"";
            sRooms1[i]['roomTypeId'] = roomTypeId;
        }
        state.totalPrice = _yuyuePrice;
        $("#totalPrice").text(_yuyuePrice);
        updateTable();
    }


    function updateTable() {
        var d = sRooms, c = customs;
        for (var i = 0; i < d.length; i++) {
            if(c.length!=0&&!c[0].roomId){
                for (var j = 0; j < c.length; j++) {
                    if (d[i].roomType == c[j].typeid ||d[i].houseTypeId == c[j].typeid ) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
            }else
                for (var j = 0; j < c.length; j++) {
                    if (d[i].roomId == c[j].roomId) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
        }
        // console.info(d);
        tableObj.reload({data: JSON.parse(JSON.stringify(d))})
        state.selRow = [];

        $("#totalPrice").text(state.totalPrice);

        if(state.channel!=2){
            $(".needWaite").removeClass("layui-hide")
        }else{
            $(".needWaite").addClass("layui-hide")
        }
    }

    function calcPrice() {

        var checkType_ = $("input[name='checkType']:checked").val();
        var d = sRooms;
        var c = saleInfo;
        state.totalPrice = 0;
        // if(c.length==0)return;
        var days = 1;
        if(checkType_=="day"){
            days = Number($("#days1").val());
        }
        else if(checkType_=="hour"){
            days = 1;
        }else {
            days = 0;
        }
        for(var i=0;i<d.length;i++){

            if(checkType_=="day"){
                state.totalPrice+=(sRooms[i].basicPrice*days);
            } else {
                state.totalPrice+=(sRooms[i].hourRoomPrice*days);
            }
        }
        state.totalPrice = state.totalPrice.toFixed(0)
        updateTable()
    }

    function payHtml(v) {
        var pp = $("#totalPrice").html();
        if(pp.indexOf("/")>-1){
            pp = pp.split("/")[0];
        }
        layer.open({
            area: ['520px', '400px'],
            type: 2,
            //content: "iframe_pay.html?v=" + amonut + "&or=" + orderNumber + "&payNumber=" + payNumber+"&random="+Date.now()+"&certificateId="+document.getElementById("credentialNo").value,\
            content: "iframe_pay.html?r="+Date.now()+"&orderId="+yuyueData.id + "&totalPrice="+pp,
            title: "支付"
        })
    }

    function makeCard(v) {
        layer.open({
            area: ['520px', '320px'],
            type: 2,
            content: "iframe_makeCard.html",
            title: "制卡",
            end: function () {
                parent.location.href =  HOME;
            }
        })
    }



    function dealFlag(t) {
        if (t) {
            $(".flagType").attr("disabled", "disabled")
        } else {
            $(".flagType").removeAttr("disabled")
        }
        form.render();
    }

    //处理选房条件发生变化的逻辑
    function dealChange() {
        return;
        console.log(currSel.inWay)
        currSel.inWay = state.roomType;
        if(!currSel.cnId)delete currSel.cnId
        if(!currSel.memberRankId)delete currSel.memberRankId
        if(currSel.inWay==2){
            currSel.dayNumber = 1;
        }else{
            currSel.dayNumber = $("#days").val();
        }

        if(state.hzjg){
            currSel.cnId = $("#channelSelect").val();
            delete currSel.memberRankId;
        }else if(userInfo.meLeval){
            currSel.memberRankId = userInfo.meLeval;
            delete currSel.cnId;
        }
        if(sRooms.length!=0&&sRooms[0].roomNum==''){
            layer.alert("请先选房")
            return ;
        }
        var ids = [];
        for(var i=0;i<sRooms.length;i++){
            ids.push(sRooms[i].roomId)
        }
        currSel.roomIds = ids.join(",")
        console.info(currSel)
        // return;
        var index = layer.load(1,{time:10*1000});
        $.ajax({
            data: currSel,
            type: "POST",
            dataType: "JSON",
            url: api.checkRoomInfo,
            beforeSend: function () {
                // $("#btnSave").addClass('layui-btn-disabled');
            },
            complete: function () {
                layer.close(index);
                // $("#btnSave").removeClass('layui-btn-disabled');
            },
            success: function (rs) {
                layer.close(index);
                if (!rs.success) {
                    layer.alert(rs.errMsg)
                    currSel.ok = rs.errMsg;
                }else{
                    sRooms = rs.data.roomInfo;
                    setCustomInfo();
                    calcPrice();
                    $("#totalPrice").text(rs.data.sumPrice);
                    currSel.ok = true;

                }
            }
        });
    }
    function set0customs() {
        customs[0] = {
            name:document.getElementById("name").value,
            certificateId:document.getElementById("certificateId").value,
            credentialNo:document.getElementById("credentialNo").value,
            address:document.getElementById("address").value,
            phoneNumber:document.getElementById("phoneNumber").value,
            remark:"",
            roomId:sRooms[0].roomId
        }
        updateTable();
    }
    function updateMySelect(f) {
        var d = allChannel;
        var v = document.getElementById("channelSelect").value;
        if (f) {
            // renderSelect("channelSelect", 'id', 'name', api.allChannel, form, function (str, rs) { allChannel = rs;
            // });
            $(".channelSelect").removeClass("layui-hide")
            state.hzjg = true;
            state.source = 3;
            for (var i = 0; i < d.length; i++) {
                if (v == d[i].id) {
                    if (d[i].state == 2) {
                        document.getElementById("source").value = '中介';
                    } else {
                        document.getElementById("source").value = '协议单位';
                    }
                    document.getElementById("channel").value = d[i].name;
                    break;
                }
            }
        }else{
            $(".channelSelect").addClass("layui-hide")
            state.hzjg = false;
            if(userInfo.memberRank){
                state.source = 2;
                $("#source").val(userInfo.memberRank)
            }else {$("#source").val("散客");state.source = 1;}
        }
        clearRoomInfo();
    }
    function updateMySelect2(f,cid) {
        var d = allChannel;
        var v = document.getElementById("channelSelect").value;

        if (f) {
            $(".channelSelect").removeClass("layui-hide")
            state.hzjg = true;
            state.source = 3;
            for (var i = 0; i < d.length; i++) {
                if (cid == d[i].id) {
                    if (d[i].state == 2) {
                        document.getElementById("source").value = '中介';
                    } else {
                        document.getElementById("source").value = '协议单位';
                    }
                    console.log(d[i]);
                    document.getElementById("channel").value = d[i].name;
                    break;
                }
            }
        }else{
            $(".channelSelect").addClass("layui-hide")
            state.hzjg = false;
            $.getJSON(api.queryIdFlag + "&phoneNumber=" + $("#phoneNumber").val()+"&random="+Date.now(), function (rs) {
                if (rs.success) {
                    $("#source").val(rs.data.memberRank)
                }else{
                    userInfo = {};
                    $("#source").val("散客")
                }
            })
        }
    }



    function checkRoomNum() {
        //检查是否全部完成选房
        var ff = true;
        sRooms.map(function(val){
            if(val['roomNum']==''){
                ff = false;
            }
        })
        return ff;
    }



    function getTypeIds() {

        var ids = [];
        var _key = 'houseTypeId'
        if(sRooms[0]['roomType']){
            _key = 'roomType'
        }

            sRooms.map(function(current,index){
                if(ids.indexOf(current[_key])==-1){
                    ids.push(current[_key])
                }
            })

        return ids.join(",");
    }
    function parModifyPrice() {
        if(localStorage.modifyPrice){
            var _mp = JSON.parse(localStorage.modifyPrice);
            var _total = 0;
            _mp.map(function (curr,index) {
                for(var i in curr){
                    if(i.split('/').length>2&&i.indexOf('y')==-1){

                        _total+=(getRoomQuantity(curr['roomTypeId'])*Number(curr[i]));
                    }
                }
            })
            var _v = $("#totalPrice").text();

            if(_v.indexOf("/")==-1){
                $("#totalPrice").text(_total.toFixed(2)+"/"+_v);
            }else{
                $("#totalPrice").text(_total.toFixed(2)+"/"+_v.split('/')[1]);
            }
        }
    }
    function getRoomQuantity (v){
        var _num=0;
        var _key = 'houseTypeId'
        if(sRooms[0]['roomType']){
            _key = 'roomType'
        }
        sRooms.map(function (curr) {
            if(curr[_key]==v)_num+=1
        })
        return _num;
    }
    function checkRoomNumberIsNull() {

        var bool = false;
        sRooms.map(function (c) {
            if(c['roomNum']=='')bool = true;
        })
        return bool;
    }



    function getTimePriceByTime(time,roomTypeId) {
        var r = yuyueData.orderChildBOS;
        for(var i=0;i<r.length;i++){
            var rs = r[i]['everydayRoomPriceBOS'];
            if(r[i].roomTypeId == roomTypeId){
                for(var j=0;j<rs.length;j++){
                    if(DateToLStr(new Date(rs[j]['time'].time)).split(" ")[0]==time){
                        return rs[j]['money']
                    }
                }
            }
        }
    }
    function productRoomS(v) {//处理房间数据格式，改成和房型的格式一致/参数是已经选择的房间数据
        var rs = [];
        for(var i=0;i<v.length;i++){
            var td = JSON.parse(JSON.stringify(v[i]));
            v[i]['roomId'] = td.id;
            v[i]['id'] = td.roomTypeId;
            v[i]['name'] = td.roomType;
            v[i]['roomNum'] = td.roomName;
            v[i]['random'] = td.id;;
            rs.push(v[i]);
        }
        return rs;

    }

</script>
<script src="js/checkinCommon.js" type="text/javascript" charset="utf-8"></script>
<script src="js/modifyPriceYYRZ.js" type="text/javascript" charset="utf-8"></script>
