<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <title>预约入住</title>
    <script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
    <style>
        .layui-laydate-footer {
            display: none !important;
        }

        .layui-colla-title {
            background: transparent;
            text-align: left;
            border: 0px;
        }
    </style>
</head>

<body>

<nav class="hotel-nav">

    <ul class="layui-nav " lay-filter="" id="navMenu">


    </ul>
    <ul class="layui-nav layui-layout-right">
        <li class="layui-nav-item">
            <a href="javascript:;" id="hotelusername"></a>
            <dl class="layui-nav-child">
                <dd>
                    <a href="javascript:;" id="updateHotel">更换酒店</a>
                </dd>
                <dd>
                    <a href="javascript:;" id="updatePass">修改密码</a>
                </dd>
                <dd>
                    <a href="javascript:;" class="outLogin">退出登录</a>
                </dd>
            </dl>
        </li>
    </ul>
</nav>
<div style="height: 60px;"></div>
<form class="layui-form" lay-filter="data" id="myform">
    <div class="layui-tab layui-tab-card" lay-filter="rzfs">
        <ul class="layui-tab-title">
            <!--<li class="center-tab-list " lay-id="1">直接入住</li>-->
            <li class="center-tab-list layui-this" lay-id="2">预约入住</li>
        </ul>
        <section class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div class="line-block portrait-wp">
                    <img id="image" src="images/portrait.jpg" width="140" height="160"/>
                    <p class="portrait-lev" id="userLevel"></p>
                </div>
                <div class="line-block right-content">
                    <div class="layui-form-item layui-form">
                        <div class="layui-inline">
                            <label class="layui-form-label require">姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="name" id="name" lay-verify="required|name" autocomplete="off"
                                       class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">证件类型</label>
                            <div class="layui-input-inline">
                                <select name="certificateId" id="certificateId">

                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label require">证件号</label>
                            <div class="layui-input-inline">
                                <input type="text" name="credentialNo" onblur="idFlag(1)" id="credentialNo"
                                       lay-verify="required" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label require">电话</label>
                            <div class="layui-input-inline">
                                <input type="tel" name="phoneNumber" onblur="idFlag(2)" id="phoneNumber"
                                       autocomplete="off" lay-verify="required" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-inline fr">
                            <a class="layui-btn layui-btn-primary " id="readCre">读取证件</a>
                            <a class="layui-btn layui-btn-warm" onclick="clearData()">清除资料</a>
                        </div>

                    </div>
                </div>
                <div class="layui-collapse more layui-hide">
                    <div class="layui-colla-item">
                        <h2 class="layui-colla-title">更多资料</h2>
                        <div class="layui-colla-content">
                            <div class="layui-form-item layui-form">
                                <div class="layui-inline">
                                    <label class="layui-form-label">性别</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="gender" id="gender" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">生日</label>
                                    <div class="layui-input-inline">
                                        <input type="text" class="layui-input" id="birthday" name="birthday"
                                               placeholder="yyyy-MM-dd">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">邮箱</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="email" id="email" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>

                                <div class="layui-inline">
                                    <label class="layui-form-label">微信</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="wechat" id="wechat" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">qq</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="qq" id="qq" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">国籍</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="nationality" id="nationality" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">爱好</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="hobby" id="hobby" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">民族</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="nation" id="nation" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>


                                <div class="layui-inline">
                                    <label class="layui-form-label">地址</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="address" id="address" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">备注</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="remark" id="remark" autocomplete="off"
                                               class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">车牌号</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="licensePlateNumber" id="licensePlateNumber"
                                               autocomplete="off" class="layui-input">
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </section>
        <section class="border-e6 mg10 pd10">
            <p class="border-e6 order-title">订单信息</p>
            <div class="layui-form-item layui-form">
                <div class="layui-inline" style="padding-left: 20px;">
                    <input type="checkbox" disabled name="" id="hhzzjjgg" title="合作机构" lay-skin="primary" lay-filter="hzjg">
                    <span style="background: #ccc;width: 200px;height: 45px;line-height: 45px;"></span>
                </div>
                <div class="layui-inline channelSelect layui-hide">
                    <select id="channelSelect" lay-filter="floor" disabled lay-search>
                    </select>
                </div>
                <div class="layui-input-inline" style="float: none">
                    <input type="text" name="OTA"id="ota" autocomplete="off" class="layui-input" readonly placeholder="OTA">
                </div>
            </div>
            <div class="pd20  layui-form layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">入住方式</label>
                    <div class="layui-input-inline" style="width:auto;">
                        <input type="radio" name="inWay" value="1" title="全天房" checked="" disabled class="flagType">
                        <input type="radio" name="inWay" value="2" title="钟点房" disabled class="flagType">
                        <input type="radio" name="inWay" value="3" title="免费房" disabled class="flagType">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">接单员</label>
                    <div class="layui-input-inline">
                        <input type="text" name="ordering" id="ordering" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <br>
                <div class="layui-inline">
                    <label class="layui-form-label">客源</label>
                    <div class="layui-input-inline">
                        <input type="text" value="散客 " name="source" id="source" readonly="" style="background: #eee;"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">渠道</label>
                    <div class="layui-input-inline">
                        <input type="text" name="channel" id="channel" value="" readonly="" style="background: #eee;"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>

                <br>
                <div class="layui-inline typea">
                    <label class="layui-form-label">天数</label>
                    <div class="layui-input-inline">
                        <input type="number" name="dayNumber" disabled oninput="changeDays(this)" id="days" autocomplete="off"
                               class="layui-input flagType">
                    </div>
                </div>
                <div class="layui-inline typea">
                    <label class="layui-form-label">离店时间</label>
                    <div class="layui-input-inline">
                        <input type="text" disabled class="flagType layui-input" name="leaveDate" id="leaveDate"
                               placeholder="yyyy-MM-dd" readonly>
                    </div>
                </div>
                <div class="layui-inline typeb layui-hide">
                    <label class="layui-form-label">离店时间</label>
                    <div class="layui-input-inline">
                        <input class="flagType layui-input" style="display: inline-block;width: 100px;" disabled
                               type="number" onchange="limitHours(this)" class="layui-input" step="1" value="3"
                               id="leave1" max="6" min="3"><span>小时</span>
                    </div>
                </div>

            </div>
        </section>
        <section class="border-e6 mg10 pd10">
            <p class="border-e6 order-title">房间信息
                <a class="fr" style="overflow: hidden;margin-right: 30px;font-size: 20px;">总房价:<span
                        id="totalPrice">0</span>元</a>
                <a class="fr layui-hide" id="ydzj"
                   style="overflow: hidden;margin-right: 30px;font-size: 20px;">预定总价:<span id="yuyuePrice">0</span>元</a>
            </p>

            <table id="test" lay-filter="fjxx"></table>
            <div>
                <a class="layui-btn" onclick="selectRoom()">选房</a>
                <a class="layui-btn" onclick="modifyPrice()">改价</a>
                <a class="layui-btn" onclick="remarks()">批量备注</a>
                <a class="layui-btn" onclick="afterComeIn()">批量稍后入住</a>
            </div>
        </section>
        <section style="padding: 20px;overflow: hidden;">
            <a class="layui-btn layui-btn-normal fr" style="margin: 0 20px;padding: 0 50px;" onclick="cancel();">取消</a>
            <button class="layui-btn layui-btn-normal fr" id="btnSave" style="margin: 0 20px;padding: 0 50px;"
                    lay-submit="" lay-filter="checksubmit">入住
            </button>
        </section>

    </div>
</form>

</body>

</html>
<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="tonglai">同来</a>
    <!--<a class="layui-btn layui-btn-xs" lay-event="beizhu">备注</a>-->
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="yichu">移除</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs needWaite" lay-event="wait">稍后</a>
</script>
<script>
    var allChannel =[];
    var element, laydate, form, $, layer, index, table, data = [],roomTypeFlag=[];
    var state = {
        channel: 2// 1电话入住  2步入 3网络
        , roomType: 1//1,全天房,2,钟点房，3,免费房
        , source: 1// 1散客,2会员
        , user: ''
        , tl: []
        , curtl: 0
        , selRow: []
        , totalPrice: 0// 房价总金额
        , idFlag: false//标记证件号是否查询到会员信息了
        , orderNumber: 0//订单号码
        , hzjg: false//是否勾选合作机构
        , yuyueChannel: 0
    };
    var userInfo = {};//会员信息
    var sRooms = [];//已选房间信息
    var customs = [];//同来人员信息
    var saleInfo = [];//折扣信息
    var currHZJG = "";

    var currSel = {//当前选房的过滤条件
        inWay:0,//入住方式钟点房？全天? 免费？
        dayNumber:1,//入住天数
        memberRankId:0,//会员级别id
        cnId:0,//合作机构
        roomIds:getUrl("roomId"),
        ok:true
    };
    layui.use(['element', 'form', 'laydate', 'jquery', 'layer', 'table'], function () {
        element = layui.element,
            laydate = layui.laydate,
            form = layui.form,
            $ = layui.jquery,
            layer = layui.layer,
            table = layui.table;
        renderReport($)
        $(function () {
            IDCardReaderInfo($(document.body))
            setInterval(function () {
                getReport($)
            }, 60000)
            $.getJSON("https://easy-mock.com/mock/5c78a798cbbdf13dba27f09c/example/query",function (rs) {
                console.log(rs)
            })
        })

        renderSelect("channelSelect", 'id', 'name', api.allChannel, form, function (str, rs) { allChannel = rs;
        });
        form.on('checkbox(hzjg)', function (data) {
            updateMySelect(data.elem.checked)
            dealChange()//合作机构勾选
        });
        form.on('select(floor)', function (data) {

            if (data.value != currHZJG && state.channel!=2) {
                currHZJG = data.value;
                clearRoomInfo()
            }
            dealChange()
            setTimeout(function () {
                updateMySelect(true)
            },200)
        });
        renderSelect("certificateId", 'id', 'type', api.certificate, form);//证件类型获取
        try {
            $("#ordering").val(JSON.parse(localStorage.hotelUserInfo).name)
        } catch (e) {
            console.info(e)
        }
        form.on('radio', function (data) {
            if (data.value == 2) {
                $(".typea").addClass("layui-hide")
                $(".typeb").removeClass("layui-hide")
            } else {
                $(".typeb").addClass("layui-hide")
                $(".typea").removeClass("layui-hide")
            }
            if (data.value != state.roomType) {
                clearRoomInfo()
            }
            state.roomType = data.value;
        });
        element.on('tab(rzfs)', function (data) {if (data.index == 1)location.reload(); else location.href="checkIn.html"});//直接入住和预约入住切换
        if (getUrl("random")) {
            // element.tabChange("rzfs","2");
            var a = Number(getUrl("random"));
            var b = Date.now();
            if ((b - a) < 10000) {
                var urlll = api.yueCheckIn;

                if (decodeURIComponent(getUrl('phone'))) {
                    urlll += "&phoneNumber=" + decodeURIComponent(getUrl('phone'));
                } else if (getUrl("idNumber")) {
                    urlll += "&certificateNumber=" + getUrl("idNumber");
                }
                $.getJSON(urlll+"&random="+Date.now(), function (rs) {

                    if (!rs.success) {
                        layer.alert('没有查到预定信息', {icon: 2, shift: 6});
                        return;
                    }
                    if(rs.data.memberId){
                        $("#source").val(rs.data.memberName)
                    }
                    roomTypeFlag = rs.data.subscribes;
                    renderSchedule(rs.data.subscribes)
                    try{
                        $("#phoneNumber").val(rs.data.phoneNumber);
                        $("#credentialNo").val(rs.data.certificateNumber);
                    }catch (e){}
                })
            }

        }

        form.on('submit(checksubmit)', function (data) {

            var d = data.field;
            if (d.inWay == 2) {
                d.leaveDate = DateToLStr2(new Date(Date.now() + 3600000 * Number(document.getElementById("leave1").value)));
                d.dayNumber = 1;
                d.hourage = $("#leave1").val();

            } else {
                if (d.leaveDate == '') {
                    layer.alert("离店时间不能为空")
                    return false;
                }
                d.leaveDate = d.leaveDate.replace(/-/, "/").replace(/-/, "/");
                d.birthday = "2018-02-02";
            }
            if (document.getElementById("birthday").value == '') {
                delete d.birthday;
            } else {
                d.birthday = d.birthday.replace(/-/, "/").replace(/-/, "/")
            }
            d.source = state.source;
            d.channel = state.channel;
            d.idType = d.certificateId;
            d.idNumber = d.credentialNo;
            if (state.hzjg) {
                d.cnId = $("#channelSelect").val();
                d.channel = 4;
            }
            if (sRooms.length == 0) {
                layer.alert("还没有选房")
                return false;
            }
            var peo = checkPeopleNum();
            if (!peo[0]) {
                layer.msg(peo[1] + ' 号房间入住人信息不完整', {icon: 2, shift: 6});
                return false;
            }
            if (sRooms.length == 1) {
                if (peo == 1) {
                    d.roomMessage = dealOneRoomOnePeople();
                } else {
                    d.roomMessage = dealOneRoomMulPeople();
                }
            } else {
                d.roomMessage = dealMulRoomMulPeople();
            }



            d.orderNumber = state.orderNumber;
            if (d.orderNumber == 0) {
                layer.msg('订单号获取异常，请重新识别信息', {icon: 2, shift: 6});
                return;
            }
            urll = api.checkInYuYue;
            if(localStorage.modifyPrice){
                d.specialPrice = localStorage.modifyPrice;
            }
            console.log("以下是预约入住参数")
            console.info(d)
            var index = layer.load(1,{time:10*1000});
            $.ajax({
                data: d,
                type: "POST",
                dataType: "JSON",
                url: urll,
                beforeSend: function () {
                    $("#btnSave").addClass('layui-btn-disabled');
                },
                complete: function () {
                    layer.close(index);
                    $("#btnSave").removeClass('layui-btn-disabled');
                },
                success: function (rs) {

                    layer.close(index);
                    if (!rs.success) {
                        layer.alert(rs.errMsg)
                        return false;
                    }
                    sessionStorage.setItem('payBO', JSON.stringify(rs.data.payBO));
                    getIdName();
                    payHtml(rs.data);
                }
            });

            return false;
        });

        //清空表单
        function clearForm() {
            document.getElementById("myform").reset();
            layui.form.render();
        }

        $("#readCre").on("click", function () {
            //读取身份证信息 传入添加位置dom
            var CVR_IDCard = IDCardReader();
            if(!!CVR_IDCard){
                clearForm();
                var birthday = formatDate(CVR_IDCard.Born);
                form.val('data', {
                    name: CVR_IDCard.Name,
                    certificateId: 1,
                    credentialNo: CVR_IDCard.CardNo,
                    gender: CVR_IDCard.Sex,
                    birthday: birthday,
                    nation: CVR_IDCard.Nation,
                    address: CVR_IDCard.Address,
                });
                $("#image").prop('src', 'data:image/jpeg;base64,' + CVR_IDCard.Picture);
                // var _i = layer.load();
                var url1 = api.yueCheckIn;//预约
                // 查询
                var credentialNo = document.getElementById("credentialNo").value;
                // querySaleInfo(credentialNo)
                if (credentialNo == '') {
                    layer.msg('证件号码不能为空', {icon: 2, shift: 6});
                    return;
                } else {


                        //网络入住
                        url1 += "&certificateNumber=" + credentialNo


                }
                $.getJSON(url1+"&random="+Date.now(), function (rs) {

                    if(rs.data.memberId){
                        $("#source").val(rs.data.memberName);
                        userInfo.meLeval = rs.data.memberId;
                    }
                    if (!rs.success) {
                        layer.alert('没有查到预定信息', {icon: 2, shift: 6});
                        return;
                    }
                    roomTypeFlag = rs.data.subscribes;
                    renderSchedule(rs.data.subscribes)
                    try{
                        $("#phoneNumber").val(rs.data.phoneNumber);
                        $("#credentialNo").val(rs.data.certificateNumber);
                    }catch (e){}
                })
            }
            try{
                $("#ordering").val(JSON.parse( localStorage.hotelUserInfo ).name)
            }catch (e){
                console.info(e)
            }
        })
        //监听工具条
        table.on('tool(fjxx)', function (obj) {
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象

            if (layEvent === 'tonglai') {
                if(obj.data.roomId==0){
                    layer.msg("还没有选房")
                    return;
                }
                layer.open({
                    area: ['1000px', '420px'],
                    type: 2,
                    content: "iframe_togetherByAappoint.html?roomid=" + data.roomId + "&a=" + Date.now(),
                    title: "同来宾客"


                })
            } else if (layEvent === 'yichu') { //删除
                if (state.channel == 1) {
                    layer.msg('预约入住不可以删除', {icon: 2, shift: 6});

                }
                layer.confirm('真的删除行么', function (index) {
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    // removeRooms(obj.data.roomId)
                    if(sRooms[0].roomId){
                        removeRooms(obj.data.roomId)
                    }else{
                        removeRooms2(obj.data.id)
                    }

                });
            } else if (layEvent === 'wait') { //备注
                layer.confirm('确定稍后入住？', function (index) {
                    console.info(obj.data)
                    var _f = true;
                    for(var i=0;i<roomTypeFlag.length;i++) {
                        if (obj.data.roomType) {
                            if (obj.data.roomType == roomTypeFlag[i].roomType) {
                                _f = false;
                            }
                        } else {
                            if (obj.data.houseTypeId == roomTypeFlag[i].roomType) {
                                _f = false;
                            }
                        }
                    }
                    if(_f){
                        layer.alert("没有预定的房型，不能稍后入住")
                        return false;
                    }

                    $.getJSON(api.waitIn+"&random="+Date.now()+"&id="+obj.data.id,function (rs) {

                        if(!rs.success){
                            layer.alert(rs.errMsg)
                            return false;
                        }
                        layer.msg("操作成功");
                        obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                        layer.close(index);
                        if(sRooms[0].roomId){
                            removeRooms(obj.data.roomId)
                        }else{
                            removeRooms2(obj.data.id)
                        }

                    })
                });
            }
        });

        tableObj = table.render({
            elem: '#test'
            , data: data
            , limit: 10000
            , method: 'POST'
            , cols: [[
                {type: 'checkbox'}
                , {field: 'roomNum', title: '房号',}
                , {field: 'roomTypeName', title: '房型'}
                , {field: 'price', title: '房价',}
                , {field: 'name', title: '姓名',}
                , {field: 'credentialNo', title: '证件号',}
                , {field: 'phoneNumber', title: '手机号',}
                , {field: 'remark', title: '备注',}
                , {field: '', title: '数据id',hide:true}
                , {title: '操作', toolbar: '#barDemo', width: 160}
            ]]
            , page: false
        });
        table.on('checkbox(fjxx)', function (obj) {
            console.log(table.checkStatus('test').data);
            state.selRow = table.checkStatus('test').data;
        });
        laydate.render({
            elem: '#birthday',
        });
        laydate.render({
            elem: '#leaveDate',
            min: 0,
            format: 'yyyy-MM-dd HH:mm:ss',
            done: function (value, date, endDate) {
                document.getElementById("days").value =
                    GetDateDiff(DateToLStr(new Date()).split(" ")[0], value.split(" ")[0])
                document.getElementById("leaveDate").value = value.split(" ")[0] + LEAVETIME
                clearRoomInfo()
            }
        });
    });

    function par(v, vv) {
        $("#hzjg").val(vv)
        layer.close(index)
    }

    function changeDays(t) {
        document.getElementById("leaveDate").value =
            DateToLStr(new Date(Date.now() + 3600 * 1000 * 24 * Number(t.value))).split(" ")[0] + LEAVETIME
        clearRoomInfo()
    }

    function selectRoom() {

        var roomtypeurl = ''
        roomtypeurl+="&phoneNumber=" + $("#phoneNumber").val();
        roomtypeurl+="&idNumber=" + $("#credentialNo").val();
        roomtypeurl+="&inWay=" + state.roomType;
        roomtypeurl+="&endTime="+document.getElementById("leaveDate").value;
        roomtypeurl+="&startTime="+DateToLStr2(new Date());

        if(state.roomType==2){
            roomtypeurl+="&dayNumber=1";
        }else{
            roomtypeurl+="&dayNumber="+document.getElementById("days").value;
        }
        if(state.hzjg)roomtypeurl+="&cnId="+$("#channelSelect").val();
        roomtypeurl+="&channel="+state.channel;
        roomtypeurl+="&orderNumber="+state.orderNumber;
        if(userInfo.meLeval){
            roomtypeurl+="&memberRankId="+userInfo.meLeval;
        }




        layer.open({
            area: ['820px', '520px'],
            type: 2,
            content:  'iframe_pick_room2.html?vv='+Date.now()+'&'+roomtypeurl,
            title: "选房"
        })
    }

    function remarks() {
        if (state.selRow.length == 0) {
            layer.msg("您还没有勾选房间");
            return;
        }
        layer.prompt({
            formType: 2,
            value: '',
            title: '备注修改',
        }, function (value, index, elem) {
            eachReamrk(state.selRow, value)
            layer.close(index);
        });
    }

    //批量稍后入住
    function afterComeIn() {
        if (state.selRow.length == 0) {
            layer.msg("您还没有勾选房间");
            return;
        }
        var arr = state.selRow;
        layer.confirm('确定稍后入住？', function (index) {
            console.info(state.selRow)
            // return;
            for(var j=0;j<arr.length;j++){
                var obj = arr[j];
                removeRooms2(obj.id)
                var _f = true;
                for(var i=0;i<roomTypeFlag.length;i++) {
                    if (obj.roomType) {
                        if (obj.roomType == roomTypeFlag[i].roomType) {
                            _f = false;
                        }
                    } else {
                        if (obj.houseTypeId == roomTypeFlag[i].roomType) {
                            _f = false;
                        }
                    }
                }
                if(_f){
                    layer.alert("没有预定的房型，不能稍后入住")
                    return false;
                }

                $.getJSON(api.waitIn+"&random="+Date.now()+"&id="+obj.id,function (rs) {

                    if(!rs.success){
                        alert(rs.errMsg)
                        return false;
                    }
                    layer.msg("操作成功");

                    layer.close(index);




                })
            }
        });
    }


    function parSelectRoom(v) {
        sRooms = [].concat.apply([], v)
        console.info("选房后获取了如下数据↓")
        console.info(sRooms)
        setCustomInfo();
        calcPrice();
        // dealChange();
    }

    function cancel() {
        sessionStorage.clear();
        // location.reload();
        location.href = HOME;
    }

    function parToget() {
        calcPrice();
    }

    function clearData() {
        sessionStorage.clear();
        location.reload();
    }

    function dealOneRoomOnePeople() {
        var d = sRooms[0];
        var c = findPeopleByRoomId(d.roomId)[0];
        var str = '';
        str = d.roomId + "@" + d.name + "-" + c.certificateId + "-" + c.credentialNo + "-" + c.phoneNumber + "-" + nospace(c.address) + "-" + nospace(c.remark)  + "-" + (c.gender || 2);
        return str;
    }

    function nospace(v) {
        if (!v) return '无';
        if (v == null) return '无';
        if (v == 'null') return '无';
        return v;
    }

    function dealOneRoomMulPeople() {
        var d = sRooms[0];
        var dd = findPeopleByRoomId(d.roomId);
        var c = dd[0];
        var str = '';
        str = d.roomId + "@" + c.name + "-" + c.certificateId + "-" + c.credentialNo + "-" + c.phoneNumber + "-" + nospace(c.address) + "-" + nospace(c.remark)  + "-" + (c.gender || 2);
        var str1 = '';
        for (var i = 1; i < dd.length; i++) {
            str1 += "&" + dd[i].name + "-" + dd[i].certificateId + "-" + dd[i].credentialNo + "-" + dd[i].phoneNumber + "-" + nospace(dd[i].address) + "-" + nospace(dd[i].remark)  + "-" + (dd[i].gender || 2);
        }
        return str + str1;
    }

    function dealMulRoomMulPeople() {
        var d = sRooms;
        var str = '';
        for (var i = 0; i < d.length; i++) {
            var c = findPeopleByRoomId(d[i].roomId);
            str += d[i].roomId;
            str += "@";
            for (var j = 0; j < c.length; j++) {

                str += c[j].name;
                str += "-";
                str += nospace(c[j].certificateId);
                str += "-";
                str += nospace(c[j].credentialNo);
                str += "-";
                str += nospace(c[j].phoneNumber);
                str += "-";
                str += nospace(c[j].address);
                str += "-";
                str += nospace(c[j].remark);
                str += "-";
                str +=  (c[j].gender || 2);
                if (c.length == 1) {
                    str += ","
                } else if ((c.length - 1) != j) {
                    str += "&"
                } else {
                    str += ","
                }

            }
        }
        return str;
    }

    function setCustomInfo() {
        if (customs.length == 0 && sRooms.length != 0) {
            customs = [{
                name: document.getElementById("name").value,
                certificateId: document.getElementById("certificateId").value,
                credentialNo: document.getElementById("credentialNo").value,
                address: document.getElementById("address").value,
                phoneNumber: document.getElementById("phoneNumber").value,
                remark: "",
                roomId: sRooms[0].roomId,
            }]
        }
        var tem = [];
        if(customs.length!=0){
            if(customs[0].roomId!=0)return;
            for(var i=0;i<customs.length;i++){
                for(var j=0;i<sRooms.length;j++){
                    if(tem.indexOf(sRooms[j].roomId) > -1) continue;
                    if(customs[i].typid==sRooms[j].roomType){
                        customs[i].roomId = sRooms[j].roomId;
                        tem.push(sRooms[j].roomId);
                        break;
                    }
                }
            }
        }
    }

    function updateTable() {
        var d = sRooms, c = customs;
        for (var i = 0; i < d.length; i++) {
            if(!c[0].roomId){
                for (var j = 0; j < c.length; j++) {
                    if (d[i].roomType == c[j].typeid ||d[i].houseTypeId == c[j].typeid ) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
            }else
            for (var j = 0; j < c.length; j++) {
                if (d[i].roomId == c[j].roomId) {
                    d[i].name = c[j].name;
                    d[i].credentialNo = c[j].credentialNo;
                    d[i].phoneNumber = c[j].phoneNumber;
                    d[i].remark = c[j].remark;
                    // d[i].id = c[j].id;
                    break;
                }
            }
        }
        // console.info(d);
        tableObj.reload({data: JSON.parse(JSON.stringify(d))})
        state.selRow = [];
        // calcPrice();
        $("#totalPrice").text(state.totalPrice);

        if(state.channel!=2){
            $(".needWaite").removeClass("layui-hide")
        }else{
            $(".needWaite").addClass("layui-hide")
        }
    }

    function  updataTableByTogether(rid) {
        // debugger;
        var d = sRooms, c = customs;
        for (var i = 0; i < d.length; i++) {
            if(d[i].roomId == rid){
                for (var j = 0; j < c.length; j++) {
                    if (rid == c[j].roomId) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
            }
        }
        tableObj.reload({data: JSON.parse(JSON.stringify(d))})
        state.selRow = [];
    }

    function removeRooms(id) {
        var d = sRooms;
        var dd = [];
        for (var i = 0; i < d.length; i++) {
            if (d[i].roomId != id) {
                dd.push(d[i]);
            }
        }
        sRooms = dd;
        calcPrice();
    }
    function removeRooms2(id) {
        var d = sRooms;
        var dd = [];
        for (var i = 0; i < d.length; i++) {
            if (d[i].id != id) {
                dd.push(d[i]);
            }
        }
        sRooms = dd;
        calcPrice();
    }
    function checkPeopleNum() {
        var s = sRooms, c = customs;
        for (var i = 0; i < s.length; i++) {
            var f = true;
            for (var j = 0; j < c.length; j++) {
                if (s[i].roomId == c[j].roomId) {
                    f = false;
                    if (c[j]['name'] == ''
                        || c[j]['certificateId'] == ''
                        || c[j]['phoneNumber'] == ''
                        || c[j]['credentialNo'] == '')
                        return [false, s[i].roomNum]
                }
            }
            if (f) {
                return [false, s[i].roomNum]
            }
        }
        return [true];

    }

    function findPeopleByRoomId(id) {
        var d = [];
        var c = customs;
        for (var i = 0; i < c.length; i++) {
            if (c[i].roomId == id) d.push(c[i])
        }
        return d;
    }

    function eachReamrk(arr,str) {
        console.info(arr)
        var d = customs;
        var arr1 = new Array();
        customs = arr1.concat(customs)
        for(var i=0;i<arr.length;i++){
            var flag = true;
            for(var j=0;j<d.length;j++){
                if(arr[i].roomId==d[j].roomId){
                    d[j].remark = str;
                    customs[j] =d[j];
                    flag = false;
                }
            }
            if(flag){
                customs.push({
                    remark:str,
                    address: "",
                    certificateId: "",
                    credentialNo: "",
                    name: "",
                    phoneNumber: "",
                    roomId: arr[i].roomId
                })
            }
        }
        calcPrice();
    }

    function querySaleInfo(v) {//查询该会员折扣信息
        $.getJSON(api.querySale + v+"&random="+Date.now(), function (rs) {
            if (rs.success) {
                saleInfo = rs.data;
            }
        })
    }

    function calcPrice() {
        var d = sRooms;
        var c = saleInfo;
        state.totalPrice = 0;
        // if(c.length==0)return;
        var days = 1;
        if ($("#days").val() != '') {
            days = Number($("#days").val());
        }
        if (state.roomType == 2) {
            days = 1;
        }
        // if(state.channel==1)days=1;
        for (var i = 0; i < d.length; i++) {
            state.totalPrice += (sRooms[i].price * 1);
        }
        state.totalPrice = state.totalPrice.toFixed(0)
        updateTable()
    }

    //s=1证件号码，s=2手机号码
    function idFlag(s) {
        var v = $("#credentialNo").val().trim();
        var p = $("#phoneNumber").val().trim();
       if (s == 2 ) {
            //手机号码网络入住
            $.getJSON(api.yueCheckIn + "&phoneNumber=" + p+"&random="+Date.now()+"&certificateNumber="+v, function (rs) {
                if(rs.data.memberId){
                    $("#source").val(rs.data.memberName);
                    userInfo.meLeval = rs.data.memberId;
                }

                if (!rs.success) {
                    layer.alert('没有查到预定信息', {icon: 2, shift: 6});
                    return;
                }
                roomTypeFlag = rs.data.subscribes;
                renderSchedule(rs.data.subscribes)
                try{
                    $("#phoneNumber").val(rs.data.phoneNumber);
                    $("#credentialNo").val(rs.data.certificateNumber);
                }catch (e){}
            })
        } else if (s == 1) {
            //证件号码网络入住

            $.getJSON(api.yueCheckIn + "&certificateNumber=" + v+"&random="+Date.now() + "&phoneNumber=" + p, function (rs) {
                if(rs.data.memberId){
                    $("#source").val(rs.data.memberName);
                    userInfo.meLeval = rs.data.memberId;
                }
                if (!rs.success) {
                    layer.alert('没有查到预定信息', {icon: 2, shift: 6});
                    return;
                }
                roomTypeFlag = rs.data.subscribes;
                renderSchedule(rs.data.subscribes)
                try{
                    $("#phoneNumber").val(rs.data.phoneNumber);
                    $("#credentialNo").val(rs.data.certificateNumber);
                }catch (e){}
            })
        }

    }

    function renderUserInfo(d) {
        var r = d;
        querySaleInfo(r.credentialNo)
        userInfo = r;
        $("#userLevel").text(r.memberRank)
        for (var i in r) {
            try {
                document.getElementById(i).value = r[i];
            } catch (err) {

            }
        }
    }

    function renderSchedule(v) {
        if (v.length == 0) {
            layer.msg('没有查询到预定信息', {icon: 2, shift: 6});
            return;
        } else {
            layer.msg('预定信息查询成功', {icon: 1});
        }
        state.channel = v[0].channel;
        state.yuyueChannel = v[0].channel;
        state.orderNumber = v[0].orderNumberStr;
        var d = v;
        sRooms = [];//已选房间信息
        customs = [];//同来人员信息
        saleInfo = [];//折扣信息
        $("#days").val(d[0].daycount);
        $("#leaveDate").val(DateToLStr(new Date(d[0].leaveTime.time)));
        $("input[name=inWay][value=" + d[0].inway + "]").prop('checked', true);
        $("#name").val(d[0].name);
        // $("#phoneNumber").val(d[0].phoneNumber);
        // $("#credentialNo").val(d[0].certificateNumber);
        $("#certificateId").val(d[0].certificateType);
        $("#ota").val(d[0].OTA);
        state.channel = d[0].channel;
        if(d[0].channel==1){
            $("#channel").val("电话");
        }else{
            $("#channel").val("网络");
        }

        if(d[0].cnId){
            if(d[0].cnId!=0){
                state.hzjg = true;
                setOrg(d[0].cnId);
                function setOrg(v) {
                    state.hzjg = true;
                    $("#hhzzjjgg").prop("checked",true);
                    form.render();
                    $(".channelSelect").removeClass("layui-hide")

                    setTimeout(function () {
                        $("#channelSelect").val(v)
                        form.render();
                    },3000)
                }
            }
        }
        var _yuyuePrice = 0;

        form.render();

        for (var i = 0; i < d.length; i++) {
            customs.push({
                certificateId: d[i].certificateType,
                phoneNumber: d[i].phoneNumber,
                address: '',
                remark: d[i].remark,
                credentialNo: d[i].certificateNumber,
                roomId: d[i].roomId,
                name:  d[i].name,
                id:d[i].id,
                typeid:d[i].roomType
            })
            var b = d[i];
            _yuyuePrice += b.price;
            sRooms.push({
                roomType: b.roomType,
                roomId: b.roomId,
                price: b.price,
                roomNum: b.roomNumber,
                roomTypeName: b.typeName,
                id:b.id
            })
        }
        $("#yuyuePrice").text(_yuyuePrice);
        calcPrice();
        updateMySelect2(d[0].cnId?true:false,d[0].cnId);
    }

    function payHtml(v) {
        var amonut = v.price;
        var orderNumber = v.number;
        var payNumber = v.payNumber;
        layer.open({
            area: ['520px', '400px'],
            type: 2,
            content: "iframe_pay.html?v=" + amonut + "&or=" + orderNumber + "&payNumber=" + payNumber+"&random="+Date.now()+"&certificateId="+document.getElementById("credentialNo").value,
            title: "支付"
        })
    }

    function makeCard(v) {
        layer.open({
            area: ['520px', '320px'],
            type: 2,
            content: "iframe_makeCard.html",
            title: "制卡",
            end: function () {
                parent.location.href =  HOME;
            }
        })
    }

    function getIdName() {
        var a = [];
        var d = sRooms;
        for (var i = 0; i < d.length; i++) {
            var c = findPeopleByRoomId(d[i].roomId);
            for (var j = 0; j < c.length; j++) {
                a.push(c[j])
            }
        }
        sessionStorage.idandname = JSON.stringify(a);
    }

    function clearRoomInfo() {
        //清除房间和人员信息
        sRooms = [];
        customs = [];
        calcPrice();
    }

    function dealFlag(t) {
        if (t) {
            $(".flagType").attr("disabled", "disabled")
        } else {
            $(".flagType").removeAttr("disabled")
        }
        form.render();
    }

    //处理选房条件发生变化的逻辑
    function dealChange() {
        return;
        console.log(currSel.inWay)
        currSel.inWay = state.roomType;
        if(!currSel.cnId)delete currSel.cnId
        if(!currSel.memberRankId)delete currSel.memberRankId
        if(currSel.inWay==2){
            currSel.dayNumber = 1;
        }else{
            currSel.dayNumber = $("#days").val();
        }

        if(state.hzjg){
            currSel.cnId = $("#channelSelect").val();
            delete currSel.memberRankId;
        }else if(userInfo.meLeval){
            currSel.memberRankId = userInfo.meLeval;
            delete currSel.cnId;
        }
        if(sRooms.length!=0&&sRooms[0].roomNum==''){
            layer.alert("请先选房")
            return ;
        }
        var ids = [];
        for(var i=0;i<sRooms.length;i++){
            ids.push(sRooms[i].roomId)
        }
        currSel.roomIds = ids.join(",")
        console.info(currSel)
        // return;
        var index = layer.load(1,{time:10*1000});
        $.ajax({
            data: currSel,
            type: "POST",
            dataType: "JSON",
            url: api.checkRoomInfo,
            beforeSend: function () {
                // $("#btnSave").addClass('layui-btn-disabled');
            },
            complete: function () {
                layer.close(index);
                // $("#btnSave").removeClass('layui-btn-disabled');
            },
            success: function (rs) {
                layer.close(index);
                if (!rs.success) {
                    layer.alert(rs.errMsg)
                    currSel.ok = rs.errMsg;
                }else{
                    sRooms = rs.data.roomInfo;
                    setCustomInfo();
                    calcPrice();
                    $("#totalPrice").text(rs.data.sumPrice);
                    currSel.ok = true;

                }
            }
        });
    }
    function set0customs() {
        customs[0] = {
            name:document.getElementById("name").value,
            certificateId:document.getElementById("certificateId").value,
            credentialNo:document.getElementById("credentialNo").value,
            address:document.getElementById("address").value,
            phoneNumber:document.getElementById("phoneNumber").value,
            remark:"",
            roomId:sRooms[0].roomId
        }
        updateTable();
    }
    function updateMySelect(f) {
        var d = allChannel;
        var v = document.getElementById("channelSelect").value;
        if (f) {
            // renderSelect("channelSelect", 'id', 'name', api.allChannel, form, function (str, rs) { allChannel = rs;
            // });
            $(".channelSelect").removeClass("layui-hide")
            state.hzjg = true;
            state.source = 3;
            for (var i = 0; i < d.length; i++) {
                if (v == d[i].id) {
                    if (d[i].state == 2) {
                        document.getElementById("source").value = '中介';
                    } else {
                        document.getElementById("source").value = '协议单位';
                    }
                    document.getElementById("channel").value = d[i].name;
                    break;
                }
            }
        }else{
            $(".channelSelect").addClass("layui-hide")
            state.hzjg = false;
            if(userInfo.memberRank){
                state.source = 2;
                $("#source").val(userInfo.memberRank)
            }else {$("#source").val("散客");state.source = 1;}
        }
        clearRoomInfo();
    }
    function updateMySelect2(f,cid) {
        var d = allChannel;
        var v = document.getElementById("channelSelect").value;

        if (f) {
            $(".channelSelect").removeClass("layui-hide")
            state.hzjg = true;
            state.source = 3;
            for (var i = 0; i < d.length; i++) {
                if (cid == d[i].id) {
                    if (d[i].state == 2) {
                        document.getElementById("source").value = '中介';
                    } else {
                        document.getElementById("source").value = '协议单位';
                    }
                    console.log(d[i]);
                    document.getElementById("channel").value = d[i].name;
                    break;
                }
            }
        }else{
            $(".channelSelect").addClass("layui-hide")
            state.hzjg = false;
            $.getJSON(api.queryIdFlag + "&phoneNumber=" + $("#phoneNumber").val()+"&random="+Date.now(), function (rs) {
                if (rs.success) {
                    $("#source").val(rs.data.memberRank)
                }else{
                    userInfo = {};
                    $("#source").val("散客")
                }
            })
        }
    }



    function checkRoomNum() {
        //检查是否全部完成选房
        var ff = true;
        sRooms.map(function(val){
            if(val['roomNum']==''){
                ff = false;
            }
        })
        return ff;
    }


    clearModifyPrice();
    function modifyPrice() {
        var orderNumber = state.orderNumber;
        var roomTypeIds = getTypeIds();
        var dayNumber = $("#days").val();
        if(orderNumber==0){
            return;
        }
        if (sRooms.length == 0) {
            layer.alert("还没有选房")
            return false;
        }
        if(checkRoomNumberIsNull()){
            layer.alert("还没有选房")
            return;
        }
        if(state.roomType!=1){
            return ;
        }
        layer.open({
            area: ['1000px', '420px'],
            // area : ['100%', '100%'],
            type: 2,
            content: "iframe_mondifyPrice2.html?v=" + Date.now()
            +"&orderNumber="+orderNumber
            +"&dayNumber="+dayNumber
            +"&roomTypeIds="+roomTypeIds,
            title: "修改价格"
        })
    }
    function getTypeIds() {

        var ids = [];
        var _key = 'houseTypeId'
        if(sRooms[0]['roomType']){
            _key = 'roomType'
        }

            sRooms.map(function(current,index){
                if(ids.indexOf(current[_key])==-1){
                    ids.push(current[_key])
                }
            })

        return ids.join(",");
    }
    function parModifyPrice() {
        if(localStorage.modifyPrice){
            var _mp = JSON.parse(localStorage.modifyPrice);
            var _total = 0;
            _mp.map(function (curr,index) {
                for(var i in curr){
                    if(i.split('-').length>2&&i.indexOf('y')==-1){

                        _total+=(getRoomQuantity(curr['roomTypeId'])*Number(curr[i]));
                    }
                }
            })
            var _v = $("#totalPrice").text();

            if(_v.indexOf("/")==-1){
                $("#totalPrice").text(_total.toFixed(2)+"/"+_v);
            }else{
                $("#totalPrice").text(_total.toFixed(2)+"/"+_v.split('/')[1]);
            }
        }
    }
    function getRoomQuantity (v){
        var _num=0;
        var _key = 'houseTypeId'
        if(sRooms[0]['roomType']){
            _key = 'roomType'
        }
        sRooms.map(function (curr) {
            if(curr[_key]==v)_num+=1
        })
        return _num;
    }
    function checkRoomNumberIsNull() {

        var bool = false;
        sRooms.map(function (c) {
            if(c['roomNum']=='')bool = true;
        })
        return bool;
    }


</script>

