<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>换房中心</title>
	<script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
	<style>
		.layui-laydate-footer{
			display: none!important;
		}
		.layui-colla-title {
			background: transparent;
			 text-align: left;
			border: 0px;
		}
	</style>
</head>

<body>

<nav class="hotel-nav">

	<ul class="layui-nav " lay-filter="" id="navMenu">


	</ul>
	<ul class="layui-nav layui-layout-right">
		<li class="layui-nav-item">
			<a href="javascript:;" id="hotelusername"></a>
			<dl class="layui-nav-child">
				<dd>
					<a href="javascript:;" id="updateHotel">更换酒店</a>
				</dd>
				<dd>
					<a href="javascript:;" id="updatePass">修改密码</a>
				</dd>
				<dd>
					<a href="javascript:;" class="outLogin">退出登录</a>
				</dd>
			</dl>
		</li>
	</ul>
</nav>
<div style="height: 70px;"></div>
<form class="layui-form">
	<div class="layui-tab layui-tab-card" lay-filter="rzfs">
		<ul class="layui-tab-title">
			<li class="center-tab-list layui-this" lay-id="1">换房</li>
			<!--<li class="center-tab-list" lay-id="2">网络入住</li>-->
		</ul>
		<section class="layui-tab-content layui-hide">
			<div class="layui-tab-item layui-show">
				<div class="line-block portrait-wp">
					<img src="images/portrait.jpg" width="140" height="160" />
					<p class="portrait-lev" id="userLevel"></p>
				</div>
				<div class="line-block right-content">
					<div class="layui-form-item layui-form">
						<div class="layui-inline">
							<label class="layui-form-label require">姓名</label>
							<div class="layui-input-inline">
								<input type="text" name="name"  id="name" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">证件类型</label>
							<div class="layui-input-inline">
								<select name="certificateId" id="certificateId">

								</select>
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label require">证件号</label>
							<div class="layui-input-inline">
								<input type="text" name="credentialNo" onblur="idFlag(1)" id="credentialNo"  autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label require">电话</label>
							<div class="layui-input-inline">
								<input type="tel" name="phoneNumber" onblur="idFlag(2)"  id="phoneNumber" autocomplete="off"  class="layui-input">
							</div>
						</div>

						<div class="layui-inline fr">
							<a class="layui-btn layui-btn-primary " id="readCre">读取证件</a>
							<a class="layui-btn layui-btn-warm" onclick="clearData()">清除资料</a>
						</div>

					</div>
				</div>
				<div class="layui-collapse more" >
					<div class="layui-colla-item">
						<h2 class="layui-colla-title">更多资料</h2>
						<div class="layui-colla-content">
							<div class="layui-form-item layui-form">
								<div class="layui-inline">
									<label class="layui-form-label">性别</label>
									<div class="layui-input-inline">
										<input type="text" name="gender" id="gender" autocomplete="off" class="layui-input">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">生日</label>
									<div class="layui-input-inline">
										<input type="text" class="layui-input" id="birthday" name="birthday" placeholder="yyyy-MM-dd">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">邮箱</label>
									<div class="layui-input-inline">
										<input type="text" name="email" id="email" autocomplete="off" class="layui-input">
									</div>
								</div>

								<div class="layui-inline">
									<label class="layui-form-label">微信</label>
									<div class="layui-input-inline">
										<input type="text" name="wechat" id="wechat" autocomplete="off" class="layui-input">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">qq</label>
									<div class="layui-input-inline">
										<input type="text" name="qq" id="qq" autocomplete="off" class="layui-input">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">国籍</label>
									<div class="layui-input-inline">
										<input type="text" name="nationality" id="nationality" autocomplete="off" class="layui-input">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">爱好</label>
									<div class="layui-input-inline">
										<input type="text" name="hobby" id="hobby" autocomplete="off" class="layui-input">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">民族</label>
									<div class="layui-input-inline">
										<input type="text" name="nation" id="nation" autocomplete="off" class="layui-input">
									</div>
								</div>


								<div class="layui-inline">
									<label class="layui-form-label">地址</label>
									<div class="layui-input-inline">
										<input type="text" name="address" id="address" autocomplete="off" class="layui-input">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">备注</label>
									<div class="layui-input-inline">
										<input type="text" name="remark" id="remark" autocomplete="off" class="layui-input">
									</div>
								</div>
								<div class="layui-inline">
									<label class="layui-form-label">车牌号</label>
									<div class="layui-input-inline">
										<input type="text" name="licensePlateNumber" id="licensePlateNumber" autocomplete="off" class="layui-input">
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>

			</div>

		</section>
		<section class="border-e6 mg10 pd10 layui-hide">
			<p class="border-e6 order-title">订单信息</p>
			<div class="layui-form-item layui-form">
				<div class="layui-inline" style="padding-left: 20px;">
					<input type="checkbox" name="" title="合作机构" lay-skin="primary" lay-filter="hzjg">
					<span style="background: #ccc;width: 200px;height: 45px;line-height: 45px;"></span>
				</div>
				<div class="layui-inline channelSelect layui-hide" >
					<select id="channelSelect" lay-filter="floor" lay-search>
					</select>
				</div>
			</div>
			<div class="pd20  layui-form layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label">入住方式</label>
					<div class="layui-input-inline" style="width:auto;">
                        <input type="radio" name="inWay" value="1" title="全天房" checked="" class="flagType">
						<input type="radio" name="inWay" value="2" title="钟点房" class="flagType">
						<input type="radio" name="inWay" value="3" title="免费房" class="flagType">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label">接单员</label>
					<div class="layui-input-inline">
                        <input type="text" name="ordering" id="ordering" autocomplete="off" class="layui-input">
					</div>
				</div><br>
				<div class="layui-inline">
					<label class="layui-form-label">客源</label>
					<div class="layui-input-inline">
						<input type="text" value="散客 " name="source" id="source" readonly="" style="background: #eee;" autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label">渠道</label>
					<div class="layui-input-inline">
						<input type="text" name="channel" id="channel" value="步入 " readonly="" style="background: #eee;" autocomplete="off" class="layui-input">
					</div>
				</div>

				<br>
				<div class="layui-inline typea">
					<label class="layui-form-label">天数</label>
					<div class="layui-input-inline">
						<input type="number" name="dayNumber" oninput="changeDays(this)" id="days" autocomplete="off" class="layui-input flagType">
					</div>
				</div>
				<div class="layui-inline typea">
					<label class="layui-form-label">离店时间</label>
					<div class="layui-input-inline">
						<input type="text" class="flagType layui-input" name="leaveDate" id="leaveDate" placeholder="yyyy-MM-dd" readonly >
					</div>
				</div>
				<div class="layui-inline typeb layui-hide">
					<label class="layui-form-label">离店时间</label>
					<div class="layui-input-inline">
						<input class="flagType" style="display: inline-block;width: 100px;" type="number" onchange="limitHours(this)" class="layui-input" step="1" value="3" id="leave1" max="6"  min="3"><span>小时</span>
					</div>
				</div>

			</div>
		</section>
		<section class="border-e6 mg10 pd10">
			<p class="border-e6 order-title">房间信息
				<a class="fr" style="overflow: hidden;margin-right: 30px;font-size: 20px;">总房价:<span id="totalPrice">0</span>元</a>
				<a class="fr layui-hide" id="ydzj" style="overflow: hidden;margin-right: 30px;font-size: 20px;">预定总价:<span id="yuyuePrice">0</span>元</a>
			</p>

			<table  id="test" lay-filter="fjxx"></table>
			<div>
				<a class="layui-btn" onclick="selectRoom()">选房</a>
				<!--<button class="layui-btn" onclick="modifyPrice()">改价</a>-->
				<a class="layui-btn layui-hide" onclick="remarks()">批量备注</a>
			</div>
		</section>
		<section style="padding: 20px;overflow: hidden;">
			<a class="layui-btn layui-btn-normal fr" style="margin: 0 20px;padding: 0 50px;" onclick="cancel();">取消</a>
			<button class="layui-btn layui-btn-normal fr" id="btnSave" style="margin: 0 20px;padding: 0 50px;"   lay-submit=""  lay-filter="checksubmit">确定</button>
		</section>

	</div>
</form>

</body>

</html>
<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script type="text/html" id="barDemo">
	<!--<a class="layui-btn layui-btn-xs" lay-event="tonglai">同来</a>-->
	<!--<a class="layui-btn layui-btn-xs" lay-event="beizhu">备注</a>-->
	<!--<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="yichu">移除</a>-->
</script>
<script>
    var element, laydate, form, $, layer, index,table,data=[],rrr;
    var state = {
        channel:2// 1电话入住  2步入 3网络
        ,roomType:1//1,全天房,2,钟点房，3,免费房
        ,source:1// 1散客,2会员
        ,user:''
        ,tl:[]
        ,curtl:0
        ,selRow:[]
        ,totalPrice:0// 房价总金额
        ,idFlag:false//标记证件号是否查询到会员信息了
        ,orderNumber:0//订单号码
		,hzjg:false//是否勾选合作机构
        ,yuyueChannel:0
    };
    var userInfo ={};//会员信息
    var sRooms = [];//已选房间信息
    var customs = [];//同来人员信息
    var saleInfo = [];//折扣信息
	var currHZJG = "";
    layui.use(['element', 'form', 'laydate', 'jquery', 'layer','table'], function() {
        element = layui.element,
            laydate = layui.laydate,
            form = layui.form,
            $ = layui.jquery,
            layer = layui.layer,
            table = layui.table;
        // renderReport($)
        var roomId = getUrl("roomId");
        if(!roomId)return;
		$.getJSON(api.getRoomInfoById+roomId+"&random="+Date.now(),function (rs) {
			rrr = rs.data;
        })
        renderReport($)
		$(function () {
            setInterval(function () {
                getReport($)
            }, 60000)
        })

        renderSelect("channelSelect", 'id', 'name', api.allChannel, form,function (str,rs) {});
        form.on('checkbox(hzjg)', function(data) {
            // console.log(data.elem.checked); //是否被选中，true或者false
			if(data.elem.checked){
                console.log("选中了"); //是否被选中，true或者false
                $(".channelSelect").removeClass("layui-hide")
				state.hzjg= true;
                clearRoomInfo();
			}else {
                console.log("取消选中了"); //是否被选中，true或者false
                $(".channelSelect").addClass("layui-hide")
                state.hzjg= false;
                clearRoomInfo();
			}

        });
        form.on('select(floor)', function (data) {

            if(data.value!=currHZJG){
                currHZJG = data.value;
                clearRoomInfo()
			}

        });
        renderSelect("certificateId",'id','type',api.certificate,form);//证件类型获取
        try{
            $("#ordering").val(JSON.parse( localStorage.hotelUserInfo ).name)
        }catch (e){
            console.info(e)
        }
        form.on('radio', function(data){
            if(data.value==2){
                $(".typea").addClass("layui-hide")
                $(".typeb").removeClass("layui-hide")
            }else {
                $(".typeb").addClass("layui-hide")
                $(".typea").removeClass("layui-hide")
            }
            if(data.value!=state.roomType){
                clearRoomInfo()
            }historystate = ""+state.roomType;
            state.roomType=data.value;
        });
        element.on('tab(rzfs)', function(data){
            // console.log(data.index); //得到当前Tab的所在下标
            if(data.index==0){
                state.channel = 2;
                $("#ydzj").addClass("layui-hide")
                dealFlag(false);
            }else{
                dealFlag(true);
                if(state.yuyueChannel!=0){
                    state.channel = state.yuyueChannel;
                }else{
                    state.channel = 1;
                }
                $("#ydzj").removeClass("layui-hide")
            }
            if(state.channel==1){
                document.getElementById("channel").value = "电话";
            }else if(state.channel==2){
                document.getElementById("channel").value = "步入";
            }else if(state.channel==3){
                document.getElementById("channel").value = "网络";
            }
        });
        if(getUrl("random")){
            // element.tabChange("rzfs","2");
            var a = Number(getUrl("random"));
            var b = Date.now();
            if((b-a)<10000){
                element.tabChange("rzfs","2");
                $.getJSON(api.yueCheckIn+"&certificateNumber="+getUrl("idNumber")+"&random="+Date.now(),function(rs){

                    if(!rs.success){
                        layer.alert('没有查到预定信息', {icon: 2,shift:6});
                        return;
                    }
                    renderSchedule(rs.data)
                })
            }

        }

        form.on('submit(checksubmit)', function(data) {

            if(sRooms.length==0){
                layer.alert("还没有选房")
                return false;
            }
			var d ={};
            d.sign = 1;
            d.newRoomId = sRooms[0].roomId;
            d.chilId = rrr.id;


            var urll = api.checkIn;
            console.info(d)
			var index = layer.load(1,{time:10*1000});
            $.ajax({
                data: d,
                type: "POST",
                dataType: "JSON",
                url: urll,
                beforeSend: function () {
                    $("#btnSave").addClass('layui-btn-disabled');
                },
                complete: function () {
                    layer.close(index);
                    $("#btnSave").removeClass('layui-btn-disabled');
                },
                success: function (rs) {

                    layer.close(index);
                    if(!rs.success){
                        layer.alert(rs.errMsg)
                        return false;
					}
					layer.alert("操作成功，请支付",function () {
                        if(getUrl("from")==1){
                            //如果从首页预约入住弹框进来的换房，不需要支付。
                         	location.href = HOME;
                        }
                        getIdName();
                        payHtml(rs.data);
                    })

                }
            });

            return false;
        });
        $("#readCre").on("click",function () {
            return;
            // var _i = layer.load();
            var urll = api.getMemberByCre;//直接入住查询会员信息
            var url1 = api.yueCheckIn;//预约入住信息查询
            var credentialNo = document.getElementById("credentialNo").value;
            // querySaleInfo(credentialNo)
            if(credentialNo==''){
                layer.msg('证件号码不能为空', {icon: 2,shift:6});
                return;
            }else{
                if(state.channel==1){

                    //网络入住
                    url1+="&certificateNumber="+credentialNo
                }else{
                    //步入
                    urll+=credentialNo
                }

            }
            $.getJSON(urll+"&random="+Date.now(),function (rs) {
                if(!rs.success&&state.channel==1){
                    layer.alert("没有查询到预约信息")
                    return ;
                }
                if(state.channel==1){
                    renderSchedule(rs.data)
                }else{
                    if(!rs.success)  return;
                    state.source = 2;
                    $("#source").val("会员");
                    renderUserInfo(rs.data)
                    form.render();
                }

            })
        })
        //监听工具条
        table.on('tool(fjxx)', function(obj){
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象

            if(layEvent === 'tonglai'){

                layer.open({
                    area: ['1000px', '420px'],
                    type: 2,
                    content: "iframe_together.html?roomid="+data.roomId+"&a="+Date.now(),
                    title: "同来宾客"


                })
            } else if(layEvent === 'yichu'){ //删除
				if(state.channel==1){
					layer.msg('预约入住不可以删除', {icon: 2,shift:6});

				}
                layer.confirm('真的删除行么', function(index){
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    removeRooms(obj.data.roomId)

                });
            } else if(layEvent === 'beizhu'){ //备注
                //do something

                //同步更新缓存对应的值
                obj.update({
                    username: '123'
                    ,title: 'xxx'
                });
            }
        });

        tableObj = table.render({
            elem: '#test'
            , method: 'POST'
            , limit: 10000
            ,data:data
            ,cols: [[
                {type:'checkbox'}
                ,{field:'roomNum', title: '房号',}
                ,{field:'roomTypeName',  title: '房型'}
                ,{field:'price',  title: '房价',}
                // ,{field:'name',  title: '姓名',}
                // ,{field:'credentialNo', title: '证件号',}
                // ,{field:'phoneNumber', title: '手机号',}
                // ,{field:'remark',  title: '备注',}
                // ,{title:'操作',toolbar:'#barDemo',width:160 }
            ]]
            ,page: false
        });
        table.on('checkbox(fjxx)', function(obj){
            console.log(table.checkStatus('test').data);
            state.selRow = table.checkStatus('test').data;
        });
        laydate.render({
            elem: '#birthday',
        });
        laydate.render({
            elem: '#leaveDate',
            min:0,
            format:'yyyy-MM-dd HH:mm:ss',
            done: function(value, date, endDate){
                document.getElementById("days").value =
                    GetDateDiff(DateToLStr(new Date()).split(" ")[0],value.split(" ")[0])
                document.getElementById("leaveDate").value = value.split(" ")[0] + LEAVETIME
                clearRoomInfo()
            }
        });
    });

    function par(v, vv) {
        $("#hzjg").val(vv)
        layer.close(index)
    }
    function changeDays(t){
        document.getElementById("leaveDate").value =
            DateToLStr(new Date(Date.now()+3600*1000*24*Number(t.value))).split(" ")[0] + LEAVETIME
        clearRoomInfo()
    }
    function selectRoom(){

        var content = "iframe_pick_room.html?leaveTime=1";
        if(!rrr.checkIn)return;
        if(rrr.checkIn==2){
            content+="&timeRoomResult=1";
            content+="&hourNumber=3";
        }else if(rrr.checkIn==3){
            content+="&freeId=1";
		}
        if(rrr.cooperationId!=0){
            content+="&cnId="+rrr.cooperationId;
		}else if(0!=rrr.meLeval){
            content+="&memberRankId="+rrr.meLeval;
		}
        if(getUrl('state')==2){
            //预约中
            content+="&startTime="+DateToLStr(new Date(rrr.startTime.time));
            content+="&endTime="+DateToLStr(new Date(rrr.endTime.time));
            if(rrr.checkIn!=2){
                content+="&dayNumber="+GetDateDiff(DateToLStr(new Date(rrr.startTime.time)),DateToLStr(new Date(rrr.endTime.time)));
            }
		}else{
            //入住中
            content+="&startTime="+DateToLStr(new Date());
            content+="&endTime="+DateToLStr(new Date(rrr.endTime.time));
            if(rrr.checkIn!=2){
                content+="&dayNumber="+GetDateDiff(DateToLStr(new Date()),DateToLStr(new Date(rrr.endTime.time)));
            }
        }


        if(state.channel!=2){
            content+="&channel="+state.channel;
        }


        layer.open({
            area: ['820px', '520px'],
            type: 2,
            content: content,
            title: "选房"
        })
    }
    function modifyPrice(){
        layer.open({
            area: ['840px', '320px'],
            type: 2,
            content: "iframe_modify_price.html?v="+Date.now(),
            title: "改价格",
            success:function(a,b){
                modifyPriceIndex = b;
            }

        })
    }
    function remarks(){
        if(state.selRow.length==0){
            layer.msg("您还没有勾选房间");
            return;
        }
        layer.prompt({
            formType: 2,
            value: '',
            title: '备注修改',
        }, function(value, index, elem){
            eachReamrk(state.selRow,value)
            layer.close(index);
        });
    }

    function parSelectRoom(v) {
        sRooms = [].concat.apply([],v)
        console.info("选房后获取了如下数据↓")
        console.info(sRooms)
        // setCustomInfo();
        // calcPrice();
		dealChange();
    }
    function cancel(){
        sessionStorage.clear();
        // location.reload();
		location.href =HOME;
    }

    function parToget() {
        calcPrice();
    }
    function clearData() {
        sessionStorage.clear();
        location.reload();
    }
    function dealOneRoomOnePeople() {
        var d = sRooms[0];
        var c = findPeopleByRoomId(d.roomId)[0];
        var str='';
        str = d.roomId+"@"+d.name+"-"+c.certificateId+"-"+c.credentialNo+"-"+c.phoneNumber+"-"+nospace(c.address)+"-"+nospace(c.remark);
        return str;
    }
    function nospace(v) {
        if(!v)return'无';
        if(v==null)return'无';
        if(v=='null')return'无';
        return v;
    }
    function dealOneRoomMulPeople() {
        var d = sRooms[0];
        var dd = findPeopleByRoomId(d.roomId);
        var c = dd[0];

        var str='';
        str = d.roomId+"@"+d.name+"-"+c.certificateId+"-"+c.credentialNo+"-"+c.phoneNumber+"-"+nospace(c.address)+"-"+nospace(c.remark);
        var str1 = '';
        for(var i=1;i<dd.length;i++){
            str1 += "&"+dd[i].name+"-"+dd[i].certificateId+"-"+dd[i].credentialNo+"-"+dd[i].phoneNumber+"-"+nospace(dd[i].address)+"-"+nospace(dd[i].remark);
        }
        return str+str1;
    }
    function dealMulRoomMulPeople() {
        var d = sRooms;


        var str = '';
        for(var i=0;i<d.length;i++){
            var c = findPeopleByRoomId(d[i].roomId);
            str+=d[i].roomId;
            str+="@";
            for(var j=0;j<c.length;j++){

                str+=c[j].name;
                str+="-";
                str+=nospace(c[j].certificateId);
                str+="-";
                str+=nospace(c[j].credentialNo);
                str+="-";
                str+=nospace(c[j].phoneNumber);
                str+="-";
                str+=nospace(c[j].address);
                str+="-";
                str+=nospace(c[j].remark);
                if(c.length==1){
                    str+=","
                }else if((c.length-1)!=j){
                    str+="&"
                }else{
                    str+=","
                }

            }
        }
        return str;
    }
    function setCustomInfo() {

        if(customs.length==0&&sRooms.length!=0){
            customs = [{
                name:rrr.name,
                // certificateId:rrr.idNumber,
                credentialNo:rrr.idNumber,
                address:document.getElementById("address").value,
                phoneNumber:rrr.phoneNumber,
                remark:"",
                roomId:sRooms[0].roomId
            }]
        }
    }
    function  updateTable() {
        var d = sRooms,c = customs;
        for(var i=0;i<d.length;i++){
            for(var j=0;j<c.length;j++){
                if(d[i].roomId==c[j].roomId){
                    d[i].name = c[j].name;
                    d[i].credentialNo = c[j].credentialNo;
                    d[i].phoneNumber = c[j].phoneNumber;
                    d[i].remark = c[j].remark;
                    // break;
                }
            }
        }
        // console.info(d);
        tableObj.reload({data:JSON.parse(JSON.stringify(d))})
        state.selRow=[];
        // calcPrice();
        $("#totalPrice").text(state.totalPrice);

    }
    function removeRooms(id) {
        var d = sRooms;
        var dd = [];
        for(var i=0;i<d.length;i++){
            if(d[i].roomId!=id){
                dd.push(d[i]) ;
            }
        }
        sRooms=dd;
        calcPrice();
    }
    function checkPeopleNum() {
        var s = sRooms,c = customs;
        for(var i=0;i<s.length;i++){
            var f = true;
            for(var j=0;j<c.length;j++){
                if(s[i].roomId==c[j].roomId){
                    f = false;
                    if(c[j]['name']==''
                        ||c[j]['certificateId']==''
                        ||c[j]['phoneNumber']==''
                        ||c[j]['credentialNo']=='')
                        return [false,s[i].roomNum]
                }
            }
            if(f){
                return [false,s[i].roomNum]
            }
        }
        return [true];

    }

    function findPeopleByRoomId(id) {
        var d = [];
        var c = customs;
        for(var i=0;i<c.length;i++){
            if(c[i].roomId==id)d.push(c[i])
        }
        return d;
    }

    function eachReamrk(arr,str) {
        console.info(arr)
        var d = customs;
        var arr1 = new Array();
        customs = arr1.concat(customs)
        for(var i=0;i<arr.length;i++){
            var flag = true;
            for(var j=0;j<d.length;j++){
                if(arr[i].roomId==d[j].roomId){
                    d[j].remark = str;
                    customs[j] =d[j];
                    flag = false;
                }
            }
            if(flag){
                customs.push({
                    remark:str,
                    address: "",
                    certificateId: "",
                    credentialNo: "",
                    name: "",
                    phoneNumber: "",
                    roomId: arr[i].roomId
                })
            }
        }
        calcPrice();
    }
    function querySaleInfo(v) {//查询该会员折扣信息
        $.getJSON(api.querySale+v+"&random="+Date.now(),function (rs) {
            if(rs.success){
                saleInfo = rs.data;
            }
        })
    }
    function calcPrice() {
        var d = sRooms;
        var c = saleInfo;
        state.totalPrice = 0;
        // if(c.length==0)return;
        var days = 1;
        if($("#days").val()!=''){
            days = Number($("#days").val());
        }
        if(state.roomType==2){
            days = Number($("#leave1").val());
		}
		// if(state.channel==1)days=1;
        for(var i=0;i<d.length;i++){
            state.totalPrice+=(sRooms[i].price*days);
        }
        state.totalPrice = state.totalPrice.toFixed(0)
        updateTable()
    }
    //s=1证件号码，s=2手机号码
    function idFlag(s) {
        var v = $("#credentialNo").val().trim();
        var p = $("#phoneNumber").val().trim();
        if(!state.idFlag&&s==2&&state.channel==2){
            //如果根据证件号码没有查询到了会员信息
            if(p!=''){
                $.getJSON(api.queryIdFlag+"&phoneNumber="+p+"&random="+Date.now(),function (rs) {
                    if(rs.success){
                        state.source = 2;
                        $("#source").val("会员");
                        renderUserInfo(rs.data)
                        form.render();
                        layer.msg('成功获取会员信息', {icon: 1});
                    }
                })
            }
        }else if(s==1&&state.channel==2){
            //如果还没有开始查询证件查询，开始查询
            if(v!=''){
                $.getJSON(api.queryIdFlag+"&credentialNumber="+v+"&random="+Date.now(),function (rs) {
                    if(rs.success){
                        state.source = 2;
                        $("#source").val("会员");
                        renderUserInfo(rs.data)
                        form.render();
                        state.idFlag = true;
                        layer.msg('成功获取会员信息', {icon: 1});
                    }else{
                        state.idFlag = false;
                    }
                })
            }
        }else if(s==2&&state.channel==1){
            //手机号码网络入住
            $.getJSON(api.yueCheckIn+"&phoneNumber="+p+"&random="+Date.now(),function(rs){

                if(!rs.success){
                    layer.alert('没有查到预定信息', {icon: 2,shift:6});
                    return;
                }
                renderSchedule(rs.data)
            })
        }else if(s==1&&state.channel==1){
            //证件号码网络入住

            $.getJSON(api.yueCheckIn+"&certificateNumber="+v+"&random="+Date.now(),function(rs){

                if(!rs.success){
                    layer.alert('没有查到预定信息', {icon: 2,shift:6});
                    return;
                }
                renderSchedule(rs.data)
            })
        }

    }
    function renderUserInfo(d) {
        var r = d;
        querySaleInfo(r.credentialNo)
        userInfo = r;
        $("#userLevel").text(r.memberRank)
        for(var i in r){
            try{
                document.getElementById(i).value = r[i];
            }catch (err){

            }
        }
    }

    function renderSchedule(v) {
        if(v.length==0){
            layer.msg('没有查询到预定信息', {icon: 2,shift:6});
            return;
        }else{
            // layer.msg('预定信息查询成功', {icon: 1});
        }
        state.channel = v[0].channel;
        state.yuyueChannel=v[0].channel;
        state.orderNumber = v[0].orderNumberStr;
        var d =  v;
        sRooms = [];//已选房间信息
        customs = [];//同来人员信息
        saleInfo = [];//折扣信息
        $("#days").val(d[0].daycount);
        $("#leaveDate").val(DateToLStr(new Date(d[0].leaveTime.time)));
        $("input[name=inWay][value="+d[0].inway+"]").prop('checked', true);
        $("#name").val(d[0].name);
        $("#phoneNumber").val(d[0].phoneNumber);
        $("#credentialNo").val(d[0].certificateNumber);
        $("#certificateId").val(d[0].certificateType);
        var _yuyuePrice = 0;

        form.render();
        for(var i=0;i<1;i++){
            var b = d[i];

            customs.push({
                certificateId:b.certificateType,
                phoneNumber:b.phoneNumber,
                address:"",
                remark:"",
                credentialNo:b.certificateNumber,
                roomId:b.roomId,
                name:b.name
            })
        }
        // var d = v;
        for(var i=0;i<d.length;i++){
            var b = d[i];
            _yuyuePrice+=b.price;
            if(i==0){
                sRooms.push({
                    roomType:b.roomType,
                    roomId:b.roomId,
                    price:b.price/b.daycount,
                    roomNum:b.roomNumber,
                    roomTypeName:b.typeName
                })
                continue;
            }
                sRooms.push({
                roomType:b.roomType,
                roomId:b.roomId,
                price:b.price/b.daycount,
                roomNum:b.roomNumber,
                roomTypeName:b.typeName
            })
        }
        $("#yuyuePrice").text(_yuyuePrice);
        calcPrice();
    }
    function payHtml(v) {

        sessionStorage.setItem('payBO1', JSON.stringify(v.payBO));
        layer.open({
            area: ['520px', '320px'],
            type: 2,
            content: "iframe_changeRoom_pay.html?v="+v.price+"&or="+v.childOrderId+"&newRoomId="+sRooms[0]['roomId'] + "&payNumber=" + v.payNumber ,
            title: "支付"
        });
    }
    function makeCard(v) {
        layer.open({
            area: ['520px', '320px'],
            type: 2,
            content: "iframe_makeCard.html",
            title: "制卡",
            end: function () {
                parent.location.href =  HOME;
            }
        })
    }

    function getIdName() {
        var a = [];
        var d = sRooms;
        for(var i=0;i<d.length;i++){
            var c = findPeopleByRoomId(d[i].roomId);
            for(var j=0;j<c.length;j++){
                a.push(c[j])
            }
        }
        sessionStorage.idandname = JSON.stringify(a);
    }
    function clearRoomInfo() {
        //清除房间和人员信息
        sRooms = [];
        customs = [];
        calcPrice();
    }

    function dealFlag(t) {
        if(t){
            $(".flagType").attr("disabled","disabled")
        }else{
            $(".flagType").removeAttr("disabled")
        }
        form.render();
    }

    //处理选房条件发生变化的逻辑
    function dealChange() {
        if(sRooms.length!=1){
            layer.alert("房间选择有误，请检查")
            return;
		}
        var index = layer.load(1,{time:10*1000});
        $.ajax({
            data: {
                newRoomId:sRooms[0].roomId,
				roomId:getUrl("roomId")
			},
            type: "POST",
            dataType: "JSON",
            url: '/room/changeRoomPrice',
            beforeSend: function () {
                // $("#btnSave").addClass('layui-btn-disabled');
            },
            complete: function () {
                layer.close(index);
                // $("#btnSave").removeClass('layui-btn-disabled');
            },
            success: function (rs) {
                layer.close(index);
                if (!rs.success) {
                    layer.alert(rs.errMsg)
                    return false;
                }else{
                    sRooms = rs.data;
                    setCustomInfo();
                    calcPrice();

                }
            }
        });
    }
</script>
