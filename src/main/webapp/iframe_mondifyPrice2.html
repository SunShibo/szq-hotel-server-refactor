<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改价格</title>
    <script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
	<style>
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
		}

		input[type="number"] {
			-moz-appearance: textfield;
		}
		.table{
			display: table;
			white-space: nowrap;
			padding: 10px;
		}
		.table-row{
			display: table-row;
			/*预约入住修改价格;*/

		}
		.cell{
			display: table-cell;
			border: #cccccc 1px solid;
			/*width: 180px;*/
			height: 40px;
			vertical-align: middle;
			text-align: center;
			/*display: inline-block;*/
		}
		.desc{
			position: relative;
		}
		.desc:before{
			content: "";
			position: absolute;
			width: 109px;
			left: -4px;
			top: 19px;
			transform: rotate(21deg);
			transform-origin: bottom center;
			border-bottom: 1px solid #ccc;
		}
		.desc b:nth-of-type(2){
			position: absolute;
			bottom: -7px;
			left: 1px;
		}
		.desc b:nth-of-type(1){
			position: absolute;
			right: 1px;
			top: -7px;
		}
		.cell input{
			width: 50px;
		}
		.cell .wp{
			width: 100px;height: 40px;line-height:40px;
		}
	</style>
</head>
<body style="width: 960px;">
		<div style="padding: 10px 0 0 20px">
			<span>将每日房价统一修改为:&yen;</span>
			<input type="number" id="unify" style="width: 100px;height: 30px;">
			<button class="layui-btn" onclick="dealRsData(1);">批量修改</button>
			<button class="layui-btn" onclick="dealRsData(2);">恢复标准价</button>
		</div>

    	<form>


			<div>
				<section class="table" id="table">

				</section>

				<section style="padding: 20px;position: absolute;bottom: 0px;right: 0px;">
					<button class="layui-btn layui-btn-normal" lay-submit  lay-filter="formsubmit" >确定</button>
					<button class="layui-btn layui-btn-warm" onclick="no();">取消</button>
				</section>
			</div>
		</form>

<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script>
		var $,element,$b,$remove,selectDom,
            dayNumber=getUrl("dayNumber"),
			inWay=1,
			phoneNumber=getUrl("phoneNumber"),
			cnId=getUrl("cnId"),
            roomTypeIds=getUrl("roomTypeIds"),
            certificateNumnber = getUrl("certificateNumnber"),
            rsd;

  	  layui.use(['element', 'jquery', 'table','form'], function () {
          element = layui.element,
              $ = jQuery = layui.$,
              form = layui.form,
              $b = $("#body");
		      // $rtitle = $("#rtitle");
          	  $table = $("#table");
		      // dealDays();
		      getDatas();
			  form.on('submit(formsubmit)', function(data) {
				  submitInfo()
				  return false;
			  });
      })
        function dealDays() {

        	var str = '<div id="rtitle" class="table-row"><div class="cell "><div class="desc wp"><b>日期</b><b>房型</b></div></div>';
			for(var i=0;i<dayNumber;i++){
                str+= ['<div class="cell"><div class="wp">',
                    DateToLStr(new Date(Date.now()+i*86400000)).split(" ")[0],
                    '</div></div>'].join("")
			}
            $table.append(str+'</div>');

        }
		function getDatas() {
  	      if(localStorage.modifyPrice){
              rsd = JSON.parse(localStorage.modifyPrice);
              dealRsData();
              return;
          }
            var index = layer.load(1,{time:10*1000});
  	      var pd = urlToObj(window.location.search);

            $.ajax({
                data: pd,
                type: "POST",
                dataType: "JSON",
                url: "/checkin/queryRoomTypePrice",
                success: function (rs) {
                    layer.close(index);
                    // console.log(rs)
                    if (!rs.success) {
                    }else{
                        rsd = rs.data;
                        dealRsData();
                    }
                }
            });

        }
        function urlToObj(str){
            var obj = {};
            var arr1 = str.split("?");
            var arr2 = arr1[1].split("&");
            for(var i=0 ; i < arr2.length; i++){
                var res = arr2[i].split("=");
                obj[res[0]] = res[1];
            }
            return obj;
        }
        function dealRsData(ff) {
            $table.empty();
            dealDays();
            var str = '';
            rsd.map(function(c,i){
                str+=  ['<div class="table-row">',
                    '<div class="cell">',
                    c.roomTypeName,
                    '</div>',
                    _deal(c),
                    '</div>'].join("");
            })
            $table.append(str);
            function _deal(r) {
                var _str = '';
                for(var j in r){
                    if(j.split('-').length>2&&j.indexOf('y')==-1){
                        _str+=['<div class="cell">',
                            '<input type="number" data-price="',
                            r['y'+j] ? r['y'+j] : r[j],
							'" data-name="',
                            r['roomTypeName'],
							'" data-date="',
                            j,
							'" class="rti',
							r['roomTypeId'],
							'" value="',
                       		 ff==1 ? $("#unify").val() : (ff==2&&r['y'+j]) ? r['y'+j] : r[j],
                            '"><span>/',
                            r['y'+j] ? r['y'+j] : r[j],
                            '</span>',
                            '</div>'].join("");
                    }
                }
                return _str;
            }
        }


        function submitInfo() {
  	      var _arr = [];
            rsd.map(function (c,i) {
                var _o={roomTypeId:c['roomTypeId'],roomTypeName:c['roomTypeName']};
				$(".rti"+c['roomTypeId']).each(function () {
					// debugger;
                    _o[this.dataset['date']]=this.value;
                    _o['y'+this.dataset['date']] = this.dataset['price'];
                })
                _arr.push(_o);
            })
			localStorage.setItem("modifyPrice",JSON.stringify(_arr));
            parent.parModifyPrice();
            no();
        }
</script>
</body>
</html>