<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8"/>
	<title>首页跳入住</title>
	<script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
	<style>

		.layui-colla-title {
			background: transparent;
			text-align: left;
			border: 0px;
		}
	</style>
</head>

<body>

<nav class="hotel-nav">

	<ul class="layui-nav " lay-filter="" id="navMenu">


	</ul>
	<ul class="layui-nav layui-layout-right">
		<li class="layui-nav-item">
			<a href="javascript:;" id="hotelusername"></a>
			<dl class="layui-nav-child">
				<dd>
					<a href="javascript:;" id="updateHotel">更换酒店</a>
				</dd>
				<dd>
					<a href="javascript:;" id="updatePass">修改密码</a>
				</dd>
				<dd>
					<a href="javascript:;" class="outLogin">退出登录</a>
				</dd>
			</dl>
		</li>
	</ul>
</nav>
<div style="height: 70px;"></div>
<form class="layui-form" lay-filter="data" id="myform">
	<div class="layui-tab layui-tab-card" lay-filter="rzfs">
		<ul class="layui-tab-title">
			<li class="center-tab-list layui-this" lay-id="1">直接入住</li>
			<!--<li class="center-tab-list" lay-id="2">预约入住</li>-->
		</ul>
		<section class="layui-tab-content">
			<div class="layui-tab-item layui-show">
				<div class="line-block portrait-wp">
					<img id="image" src="images/portrait.jpg" width="140" height="160"/>
					<p class="portrait-lev" id="userLevel"></p>
				</div>
				<div class="line-block right-content">
					<div class="layui-form-item layui-form">
						<div class="layui-inline">
							<label class="layui-form-label require">姓名</label>
							<div class="layui-input-inline">
								<input type="text" name="orderPlacer"  id="orderPlacer" lay-verify="required|orderPlacer" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">证件类型</label>
							<div class="layui-input-inline">
								<select name="certificateId" id="certificateId">

								</select>
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label ">证件号</label>
							<div class="layui-input-inline">
								<input type="text" name="IDNumber" onblur="idFlag(1)" id="IDNumber" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label require">电话</label>
							<div class="layui-input-inline">
								<input type="tel" name="phone" onblur="idFlag(2)"  id="phone" autocomplete="off"  lay-verify="required" class="layui-input">
							</div>
						</div>

						<div class="layui-inline fr">
							<a class="layui-btn layui-btn-primary " id="readCre">读取证件</a>
							<a class="layui-btn layui-btn-warm" onclick="clearData()">清除资料</a>
						</div>

					</div>
				</div>


			</div>

		</section>
		<section class="border-e6 mg10 pd10">
			<p class="border-e6 order-title">订单信息</p>
			<div class="layui-form-item layui-form">
				<div class="layui-inline" style="padding-left: 20px;">
					<input type="checkbox" name="" id="hhzzjjgg" title="合作机构" lay-skin="primary" lay-filter="hzjg">
					<span style="background: #ccc;width: 200px;height: 45px;line-height: 45px;"></span>
				</div>
				<div class="layui-inline channelSelect layui-hide">
					<select id="channelSelect" lay-filter="floor" lay-search>
					</select>
				</div>
				<div class="layui-input-inline" style="float: none">
					<input type="text" name="OTA"id="ota" autocomplete="off" class="layui-input" placeholder="OTA">
				</div>
			</div>
			<div class="pd20  layui-form layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label">入住方式</label>
					<div class="layui-input-inline" style="width:auto;">
						<input type="radio" name="checkType" value="day" title="全天房" checked="">
						<input type="radio" name="checkType" value="hour" title="钟点房">
						<input type="radio" name="checkType" value="free" title="免费房">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label">接单员</label>
					<div class="layui-input-inline">
						<input type="text" name="clerkOrderingName" id="clerkOrderingName" autocomplete="off" class="layui-input">
					</div>
				</div><br>
				<div class="layui-inline">
					<label class="layui-form-label">客源</label>
					<div class="layui-input-inline">
						<input type="text" value="散客 " name="channel" id="channel" readonly="" style="background: #eee;"
							   autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label">渠道</label>
					<div class="layui-input-inline">
						<input type="text" name="channel1" id="channel1" value="步入 " readonly="" style="background: #eee;"
							   autocomplete="off" class="layui-input">
					</div>
				</div>

				<br>
				<div class="layui-inline typea">
					<label class="layui-form-label">天数</label>
					<div class="layui-input-inline">
						<input type="number" name="dayNumber" value="1" oninput="changeDays(this)" id="days" autocomplete="off"
							   class="layui-input flagType">
					</div>
				</div>
				<div class="layui-inline typea">
					<label class="layui-form-label">离店时间</label>
					<div class="layui-input-inline">
						<input type="text" class="flagType layui-input" name="leaveDate" id="leaveDate"
							   placeholder="yyyy-MM-dd" readonly>
					</div>
				</div>
				<div class="layui-inline typeb layui-hide">
					<label class="layui-form-label">离店时间</label>
					<div class="layui-input-inline">
						<input class="flagType layui-input" style="display: inline-block;width: 100px;" disabled
							   type="number" onchange="limitHours(this)" class="layui-input" step="1" value="4"
							   id="leave1" ><span>小时</span>
					</div>
				</div>

			</div>
		</section>
		<section class="border-e6 mg10 pd10">
			<p class="border-e6 order-title">房间信息
				<a class="fr" style="overflow: hidden;margin-right: 30px;font-size: 20px;">总房价:<span
						id="totalPrice">0</span>元</a>
				<a class="fr layui-hide" id="ydzj"
				   style="overflow: hidden;margin-right: 30px;font-size: 20px;">预定总价:<span id="yuyuePrice">0</span>元</a>
			</p>

			<table id="test" lay-filter="fjxx"></table>
			<div>
				<a class="layui-btn" onclick="selectRoom()">选房</a>
				<a class="layui-btn" onclick="modifyPrice()">改价</a>
				<a class="layui-btn" onclick="remarks()">批量备注</a>
			</div>
		</section>
		<section style="padding: 20px;overflow: hidden;">
			<a class="layui-btn layui-btn-normal fr" style="margin: 0 20px;padding: 0 50px;" onclick="cancel();">取消</a>
			<button class="layui-btn layui-btn-normal fr" id="btnSave" style="margin: 0 20px;padding: 0 50px;"
					lay-submit="" lay-filter="checksubmit">入住
			</button>
		</section>

	</div>
</form>

</body>

</html>
<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script type="text/html" id="barDemo">
	<a class="layui-btn layui-btn-xs" lay-event="tonglai">同来</a>
	<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="yichu">移除</a>
</script>
<script>
    var element, laydate, form, $, layer, index, table, data = [];var customer_source_before = '散客';
    var tempRandom = Date.now().toString().substring(5),pickRoomTypeData;
    var state = {
        channel: 2// 1电话入住  2步入 3网络 4机构
        , roomType: 1//1,全天房,2,钟点房，3,免费房
        , source: 1// 1散客,2会员,3渠道
        , user: ''
        , tl: []
        , curtl: 0
        , selRow: []
        , totalPrice: 0// 房价总金额
        , idFlag: false//标记证件号是否查询到会员信息了
        , orderNumber: 0//订单号码
        , hzjg: false//是否勾选合作机构
        , yuyueChannel: 0
    };
    var userInfo = {};//会员信息
    var sRooms = [];//已选房间信息
    var customs = [];//同来人员信息
    var saleInfo = [];//折扣信息
    var currHZJG = "";
    var allChannel =[];
    var currSel = {//当前选房的过滤条件
        inWay:0,//入住方式钟点房？全天? 免费？
        dayNumber:1,//入住天数
        memberRankId:0,//会员级别id
        cnId:0,//合作机构
        roomIds:getUrl("roomId"),
        ok:true
    };
    function getPersonData(v) {
        var c = JSON.parse(JSON.stringify(customs));
        var n = [];
        for(var i=0;i<c.length;i++){
            if(c[i]['roomId']==v){
                c[i]['certificateNumber'] = c[i]['credentialNo'];
                c[i]['phone'] = c[i]['phoneNumber'];
                c[i]['certificateType'] = c[i]['certificateId'];
                n.push(c[i]);
            }

        }
        return n;
    }
    function getCheckinData() {

        var arr = JSON.parse(JSON.stringify(sRooms));
        for(var i=0;i<arr.length;i++){
            var par = JSON.parse(JSON.stringify(arr[i]));
            if(!isNaN(arr[i]['roomType'])){
                arr[i]['roomTypeId'] = arr[i]['roomType'];
            }
            arr[i]['checkInPersonBOS'] = getPersonData(arr[i]['roomId']);
            // arr[i]['everydayRoomPriceBOS'] = getRoomPriceData(par);
        }
        return arr;

    }

    //处理条件发生变化
    function dealCondition() {
        var typeids = [];
        var checktype = $("input[name='checkType']:checked").val();
        for(var i=0;i<sRooms.length;i++){
            if(typeids.indexOf(sRooms[i]['roomTypeId'])==-1){
                typeids.push(sRooms[i]['roomTypeId'])
            }
        }
        var index = layer.load(1,{time:10*1000});
        $.ajax({
            data: {
                phone:document.getElementById("phone").value.trim(),
                startTime:DateToLStr(new Date()),//入住时间,
                dayNum:checktype=='hour'?1:document.getElementById("days").value,
                typeIds:typeids.join(","),
                orderId:tempRandom,
                checkType: $("input[name='checkType']:checked").val(),
            },
            type: "POST",
            dataType: "JSON",
            url: 'updatePrice/updatePrice',
            beforeSend: function () {
            },
            complete: function () {
                layer.close(index);
            },
            success: function (rs) {
                layer.close(index);
                if (!rs.success) {
                    layer.alert(rs.errMsg)
                }else{

                    for(var i=0;i<sRooms.length;i++){
                        for(var j=0;j<rs.data.length;j++){
                            if(sRooms[i]['roomTypeId']== rs.data[j]['roomTypeId']){

                                sRooms[i]['basicPrice'] = sRooms[i]['hourRoomPrice'] = rs.data[j]['price'];
                            }
                        }
                    }
                }
                localStorage.modifyPrice = JSON.stringify(rs.data);
                state.totalPrice = _yuyuePrice;
                $("#totalPrice").text(_yuyuePrice);
                tableObj.reload({data: JSON.parse(JSON.stringify(sRooms))})
                // updateTable();
            }
        });
    }
    
    // clearModifyPrice();
    layui.use(['element', 'form', 'laydate', 'jquery', 'layer', 'table'], function () {
        element = layui.element,
            laydate = layui.laydate,
            form = layui.form,
            $ = layui.jquery,
            layer = layui.layer,
            table = layui.table;
        document.getElementById("leaveDate").value =
            DateToLStr(new Date(Date.now()+3600*1000*24)).split(" ")[0] + LEAVETIME
        localStorage.modifyPrice = '';
        if (getUrl("id")) {

            $.getJSON('room/selectRoom?id=' + getUrl("id") +"&random="+Date.now(), function (rs) {

                sRooms = [rs.data];
                if(sRooms[0]['roomType']){
                    sRooms[0]['roomTypeName'] = sRooms[0]['roomType']+"";
                }
                if(sRooms[0]['roomName']){
                    sRooms[0]['roomNum'] = sRooms[0]['roomName']+"";
                }
                sRooms[0]['roomId'] = sRooms[0]['id']+"";
                tableObj.reload({data: JSON.parse(JSON.stringify(sRooms))})

            })

        }
        form.on('submit(checksubmit)', function (data) {
            var d = data.field;
            d.type = "directly";
            d.IDNumberType = d.certificateId + "";
            d.checkTime = DateToLStr(new Date());
            d.checkOutTime = d.leaveDate;
            d.dayCount = d.dayNumber + "";
            d.orderType = "directly";
            if(userInfo&&userInfo.id) d.membersId = userInfo.id;
            if (state.hzjg)   d.memberIdOrOrganizationId  = $("#channelSelect").val();
            if (sRooms.length == 0 || !sRooms[0]['roomId']) {
                layer.alert("还没有选房")
                return false;
            }



            var checkinData = getCheckinData();

            if(localStorage.modifyPrice=='') {
                //没有修改过价格
                var days = Number($("#days").val());
                var money = 0;
                if($("input[name='checkType']:checked").val()=="hour"){
                    money = 'hourRoomPrice'
                } else if($("input[name='checkType']:checked").val()=="day"){
                    money = 'basicPrice'
                }
                for(var i=0;i<checkinData.length;i++){
                    var arr = [{
                        money:checkinData[i][money],
                        time:DateToLStr(new Date()).split(" ")[0]
                    }];
                    for(var j=1;j<days;j++){
                        arr.push({
                            money:checkinData[i][money],
                            time:addDate(new Date(),j)
                        })
                    }
                    checkinData[i]['everydayRoomPriceBOS'] = arr;
                }

            }else{

                var rs = JSON.parse(localStorage.modifyPrice);
                for(var i=0;i<checkinData.length;i++){
                    for(var j=0;j<rs.length;j++){
                        if(checkinData[i]["roomTypeId"] == rs[j]['roomTypeId']) {
                            var c = rs[j];
                            var arr = [];
                            for (var b in c) {
                                if (b.indexOf("/") > -1 && b.indexOf("y") == -1) {
                                    arr.push({
                                        time: b,
                                        money: c[b]
                                    })
                                }
                            }
                            checkinData[i]['everydayRoomPriceBOS'] = arr;
                            break;
                        }
                    }
                }


            }

            d.OrderChildJSON = JSON.stringify(checkinData);
            console.log("以下是直接入住参数")
            console.info(d)
            var index = layer.load(1,{time:10*1000});
            $.ajax({
                data: d,
                type: "POST",
                dataType: "JSON",
                url: 'order/reservationRoom',
                beforeSend: function () {
                    $("#btnSave").addClass('layui-btn-disabled');
                },
                complete: function () {
                    layer.close(index);
                    $("#btnSave").removeClass('layui-btn-disabled');
                },
                success: function (rs) {
                    layer.close(index);
                    if (!rs.success) {
                        layer.alert(rs.errMsg)
                        return false;
                    }
                    payHtml(rs.data.orderId);
                }
            });

            return false;

        });


        $("#readCre").on("click", function () {
            //读取身份证信息 传入添加位置dom
            var CVR_IDCard = IDCardReader();
            if(!!CVR_IDCard){
                clearForm();
                var birthday = formatDate(CVR_IDCard.Born);
                form.val('data', {
                    name: CVR_IDCard.Name,
                    certificateId: 1,
                    credentialNo: CVR_IDCard.CardNo,
                    gender: CVR_IDCard.Sex,
                    birthday: birthday,
                    nation: CVR_IDCard.Nation,
                    address: CVR_IDCard.Address,
                });
                $("#image").prop('src', 'data:image/jpeg;base64,' + CVR_IDCard.Picture);
                var urll = api.getMemberByCre;//直接入住查询会员信息
                var credentialNo = document.getElementById("credentialNo").value;
                if (credentialNo == '') {
                    layer.msg('证件号码不能为空', {icon: 2, shift: 6});
                    return;
                }
                urll += credentialNo;
                $.getJSON(urll+"&random="+Date.now(), function (rs) {
                    //根据证件号码查询是否是会员
                    if (!rs.success) return;
                    renderUserInfo(rs.data)
                    form.render();
                })
            }
        })

        //监听工具条
        table.on('tool(fjxx)', function (obj) {
            // debugger;
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象
            if (layEvent === 'tonglai') {
                layer.open({
                    area: ['1000px', '420px'],
                    type: 2,
                    content: "iframe_together.html?roomid=" + data.roomId + "&a=" + Date.now(),
                    title: "同来宾客"
                })
            } else if (layEvent === 'yichu') { //删除
                if (state.channel == 1) {
                    layer.msg('预约入住不可以删除', {icon: 2, shift: 6});

                }
                layer.confirm('真的删除行么', function (index) {
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    // removeRooms(obj.data.roomId)
                    if(sRooms[0].roomId){
                        removeRooms(obj.data.roomId)
                    }else{
                        removeRooms2(obj.data.id)
                    }


                });
            } else if (layEvent === 'wait') { //备注
                layer.confirm('确定稍后入住？', function (index) {
                    console.info(obj.data)

                    $.getJSON(api.waitIn+"&random="+Date.now()+"&id="+obj.data.id,function (rs) {
                        if(!rs.success){
                            layer.alert(rs.errMsg)
                            return false;
                        }
                        layer.msg("操作成功");
                        obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                        layer.close(index);
                        if(sRooms[0].roomId){
                            removeRooms(obj.data.roomId)
                        }else{
                            removeRooms2(obj.data.id)
                        }

                    })

                });
            }
        });

        tableObj = table.render({
            elem: '#test'
            , data: data
            , limit: 10000
            , method: 'POST'
            , cols: [[
                {type: 'checkbox'}
                , {field: 'roomNum', title: '房号',}
                , {field: 'roomTypeName', title: '房型'}
                ,{
                    title: '房价',
                    align: 'center',
                    templet: function (data) {
                        var price = data.basicPrice;
                        if($("input[name='checkType']:checked").val()=="hour")price = data.hourRoomPrice;
                        if($("input[name='checkType']:checked").val()=="free")price = 0;
                        return price;
                    }
                }
                , {field: 'name', title: '姓名',}
                , {field: 'credentialNo', title: '证件号',}
                , {field: 'phoneNumber', title: '手机号',}
                , {field: 'remark', title: '备注',}
                , {field: '', title: '数据id',hide:true}
                , {title: '操作', toolbar: '#barDemo', width: 160}
            ]]
            , page: false
        });

        laydate.render({
            elem: '#leaveDate',
            min: 0,
            format: 'yyyy/MM/dd HH:mm:ss',
            done: function (value, date, endDate) {
                document.getElementById("days").value =
                    GetDateDiff(DateToLStr(new Date()), value.split(" ")[0] + LEAVETIME)
                document.getElementById("leaveDate").value = value.split(" ")[0] + LEAVETIME;
                localStorage.modifyPrice = '';
                setTimeout(function () {
                    dealChange()
                },100)
            }
        });
    });
    //渲染用户信息
    function    renderUserInfo(d) {
        var r = d;
        userInfo = r;
        $("#userLevel").text(r.memberRank)
        for (var i in r) try {document.getElementById(i).value = r[i];} catch (err) {}
        if(!state.hzjg){
            state.source = 2;
            $("#source").val(r.memberRank)
        }
        dealChange();
    }
    //处理选房条件发生变化的逻辑
    function dealChange() {
        clearRoomInfo();
    }
    function par(v, vv) {
        $("#hzjg").val(vv)
        layer.close(index)
    }

    function changeDays(t) {

        document.getElementById("leaveDate").value =
            DateToLStr(new Date(Date.now()+3600*1000*24*Number(t.value))).split(" ")[0] + LEAVETIME
        localStorage.modifyPrice = '';
        clearRoomInfo();
    }

    function selectRoom() {
        var _leaveTime;
        if(document.getElementById("orderPlacer").value==''){
            layer.msg('姓名未填写', {icon: 2,shift:6});
            return;
        }
        if(document.getElementById("phone").value==''){
            layer.msg('手机号未填写', {icon: 2,shift:6});
            return;
        }

        if($("input[name='checkType']:checked").val()!="hour"){
            if(document.getElementById("leaveDate").value==''){
                layer.msg('离店时间未填写', {icon: 2,shift:6});
                return;
            }
        }else{
            _leaveTime = DateToLStr(new Date(new Date().setHours(new Date().getHours() + 4)))
        }
        var selectRoomData =  {
            checkTime:	DateToLStr(new Date()),
            endTime:_leaveTime?_leaveTime:document.getElementById("leaveDate").value,
            phone:document.getElementById("phone").value.trim(),
            roomAuxiliaryStatus:$("input[name='checkType']:checked").val(),
            state:'yes'//直接入住
        }
        localStorage.zjrzxf = JSON.stringify(selectRoomData);
        console.log('下面是预约入住选房的数据')
        console.log(selectRoomData	)
        layer.open({
            area: ['820px', '520px'],
            type: 2,
            content:  'iframe_pick_room2.html?vv='+Date.now()+"&parameter=zjrzxf",
            title: "预约入住选房"
        })
    }



    function remarks() {
        if (state.selRow.length == 0) {
            layer.msg("您还没有勾选房间");
            return;
        }
        layer.prompt({
            formType: 2,
            value: '',
            title: '备注修改',
        }, function (value, index, elem) {
            eachReamrk(state.selRow, value)
            layer.close(index);
        });
    }

    function parSelectRoom(v) {
        sRooms =  v;
        sRooms = productRoomS(v);//处理房间数据，改成和房型数据统一
        console.info("直接入住选房后获取了如下数据↓")
        console.info(sRooms)
        setCustomInfo();
        calcPrice();
        // dealChange();
    }

    function cancel() {
        sessionStorage.clear();
        location.href = HOME;
    }

    function parToget() {
        calcPrice();
    }

    function clearData() {
        sessionStorage.clear();
        location.reload();
    }



    function nospace(v) {
        if (!v) return '无';
        if (v == null) return '无';
        if (v == 'null') return '无';
        return v;
    }



    function setCustomInfo() {

        if (customs.length == 0 && sRooms.length != 0) {
            customs = [{
                name: document.getElementById("orderPlacer").value,
                certificateId: document.getElementById("certificateId").value,
                credentialNo: document.getElementById("IDNumber").value,
                address: '',
                phoneNumber: document.getElementById("phone").value,
                remark: "",
                roomId: sRooms[0].roomId,
            }]
        }
    }

    function updateTable() {
        var d = sRooms, c = customs;
        for (var i = 0; i < d.length; i++) {
            if(c.length!=0&&!c[0].roomId){
                for (var j = 0; j < c.length; j++) {

                    if (d[i].roomType == c[j].typeid ||d[i].houseTypeId == c[j].typeid ) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
            }else
                for (var j = 0; j < c.length; j++) {
                    if (d[i].roomId == c[j].roomId) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
        }
        // console.info(d);
        tableObj.reload({data: JSON.parse(JSON.stringify(d))})
        state.selRow = [];

        $("#totalPrice").text(state.totalPrice);

        if(state.channel!=2){
            $(".needWaite").removeClass("layui-hide")
        }else{
            $(".needWaite").addClass("layui-hide")
        }
    }

    function calcPrice() {

        var checkType_ = $("input[name='checkType']:checked").val();
        var d = sRooms;
        var c = saleInfo;
        state.totalPrice = 0;
        // if(c.length==0)return;
        var days = 1;
        if(checkType_=="day"){
            days = Number($("#days").val());
        }
        else if(checkType_=="hour"){
            days = 1;
        }else {
            days = 0;
        }
        for(var i=0;i<d.length;i++){

            if(checkType_=="day"){
                state.totalPrice+=(sRooms[i].basicPrice*days);
            } else {
                state.totalPrice+=(sRooms[i].hourRoomPrice*days);
            }
        }
        state.totalPrice = state.totalPrice.toFixed(0)
        updateTable()
    }

    function removeRooms(id) {
        var d = sRooms;
        var dd = [];
        for (var i = 0; i < d.length; i++) {
            if (d[i].roomId != id) {
                dd.push(d[i]);
            }
        }
        sRooms = dd;
        calcPrice();
    }
    function removeRooms2(id) {
        var d = sRooms;
        var dd = [];
        for (var i = 0; i < d.length; i++) {
            if (d[i].id != id) {
                dd.push(d[i]);
            }
        }
        sRooms = dd;
        calcPrice();
    }
    function checkPeopleNum() {
        var s = sRooms, c = customs;
        for (var i = 0; i < s.length; i++) {
            var f = true;
            for (var j = 0; j < c.length; j++) {
                if (s[i].roomId == c[j].roomId) {
                    f = false;
                    if (c[j]['name'] == ''
                        || c[j]['certificateId'] == ''
                        || c[j]['phoneNumber'] == ''
                        || c[j]['credentialNo'] == '')
                        return [false, s[i].roomNum]
                }
            }
            if (f) {
                return [false, s[i].roomNum]
            }
        }
        return [true];

    }

    function findPeopleByRoomId(id) {
        var d = [];
        var c = customs;
        for (var i = 0; i < c.length; i++) {
            if (c[i].roomId == id) d.push(c[i])
        }
        return d;
    }

    function eachReamrk(arr,str) {
        // console.info(arr)
        var d = customs;
        var arr1 = new Array();
        customs = arr1.concat(customs)
        for(var i=0;i<arr.length;i++){
            var flag = true;
            for(var j=0;j<d.length;j++){
                if(arr[i].roomId==d[j].roomId){
                    d[j].remark = str;
                    customs[j] =d[j];
                    flag = false;
                }
            }
            if(flag){
                customs.push({
                    remark:str,
                    address: "",
                    certificateId: "",
                    credentialNo: "",
                    name: "",
                    phoneNumber: "",
                    roomId: arr[i].roomId
                })
            }
        }
        calcPrice();
    }


    //s=1证件号码，s=2手机号码
    function idFlag(s) {

        var v = '';
        //查询是否是会员
        if ( s == 1 && $("#IDNumber").val().trim().length == '') return;
        if ( s == 2 && $("#phone").val().trim().length == '') return;
        // if(s==1)v = $("#IDNumber").val().trim();
        // if(s==2)v = $("#phone").val().trim();
        if(s == 1){
            v =  "&certificateNumber="+$("#IDNumber").val().trim()
        }
        if(s==2){
            v =  "&phone="+$("#phone").val().trim()
        }


        $.getJSON(api.queryIdFlag + v + "&random="+Date.now(), function (rs) {

            if (rs.success&&rs.data!=null) {
                renderUserInfo(rs.data)
                form.render();
                state.idFlag = true;
                layer.msg('成功获取会员信息', {icon: 1});
            } else {
                state.idFlag = false;
                userInfo = {};
                $("#userLevel").text("");
                document.getElementById("channel").value = customer_source_before;
            }
        })

    }

    function payHtml(v) {
        var pp = $("#totalPrice").html();
        if(pp.indexOf("/")>-1){
            pp = pp.split("/")[0];
        }
        layer.open({
            area: ['520px', '400px'],
            type: 2,
            content: "iframe_pay.html?r="+Date.now()+"&orderId="+ v + "&totalPrice="+pp,
            title: "支付"
        })
    }

    function makeCard(v) {
        layer.open({
            area: ['520px', '320px'],
            type: 2,
            content: "iframe_makeCard.html?v="+Math.random(),
            title: "制卡",
            end: function () {
                parent.location.href =  HOME;
            }
        })
    }

    function getIdName() {
        var a = [];
        var d = sRooms;
        for (var i = 0; i < d.length; i++) {
            var c = findPeopleByRoomId(d[i].roomId);
            for (var j = 0; j < c.length; j++) {
                a.push(c[j])
            }
        }
        sessionStorage.idandname = JSON.stringify(a);
    }


    function checkRoomNum() {
        //检查是否全部完成选房
        sRooms.map(function(val,index){
            if(val['roomNum']==''){
                return false;
            }
        })
        return true;
    }


    function  updataTableByTogether(rid) {

        var d = sRooms, c = customs;
        for (var i = 0; i < d.length; i++) {
            if(d[i].roomId == rid){
                for (var j = 0; j < c.length; j++) {
                    if (rid == c[j].roomId) {
                        d[i].name = c[j].name;
                        d[i].credentialNo = c[j].credentialNo;
                        d[i].phoneNumber = c[j].phoneNumber;
                        d[i].remark = c[j].remark;
                        // d[i].id = c[j].id;
                        break;
                    }
                }
            }
        }
        tableObj.reload({data: JSON.parse(JSON.stringify(d))})
        state.selRow = [];
    }

    function productRoomS(v) {//处理房间数据格式，改成和房型的格式一致/参数是已经选择的房间数据

        var rs = [];
        for(var i=0;i<v.length;i++){
            var td = JSON.parse(JSON.stringify(v[i]));
            v[i]['roomId'] = td.id;
            // v[i]['id'] = td.roomTypeId;
            // v[i]['name'] = td.roomType;
            v[i]['roomNum'] = td.roomName;
            v[i]['random'] = td.id;;
            rs.push(v[i]);
        }
        return rs;

    }

</script>
<script src="js/checkinCommon.js" type="text/javascript" charset="utf-8"></script>
<script src="js/modifyPriceZJRZ.js" type="text/javascript" charset="utf-8"></script>
