<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>客房预订</title>
	<script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
	<style>
		.layui-colla-title {
			background: transparent;
			text-align: left;
			border: 0px;
		}
	</style>
</head>

<body>

<nav class="hotel-nav">

	<ul class="layui-nav " lay-filter="" id="navMenu">


	</ul>
	<ul class="layui-nav layui-layout-right">
		<li class="layui-nav-item">
			<a href="javascript:;" id="hotelusername"></a>
			<dl class="layui-nav-child">
				<dd>
					<a href="javascript:;" id="updateHotel">更换酒店</a>
				</dd>
				<dd>
					<a href="javascript:;" id="updatePass">修改密码</a>
				</dd>
				<dd>
					<a href="javascript:;" class="outLogin">退出登录</a>
				</dd>
			</dl>
		</li>
	</ul>
</nav>
<div style="height: 70px;"></div>
<form class="layui-form">
	<div class="layui-tab layui-tab-card" lay-filter="rzfs">
		<ul class="layui-tab-title">
			<!--<li class="center-tab-list layui-this">直接入住</li>-->
			<li class="center-tab-list">房间预定</li>
		</ul>
		<section class="layui-tab-content">
			<div class="layui-tab-item layui-show">
				<div class="line-block portrait-wp">
					<img src="images/portrait.jpg" width="140" height="160" />
					<p class="portrait-lev" id="userLevel"></p>
				</div>
				<div class="line-block right-content">
					<div class="layui-form-item layui-form">
						<div class="layui-inline">
							<label class="layui-form-label require">姓名</label>
							<div class="layui-input-inline">
								<input type="text" name="orderPlacer"  id="orderPlacer" lay-verify="required|orderPlacer" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">证件类型</label>
							<div class="layui-input-inline">
								<select name="certificateId" id="certificateId">

								</select>
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label ">证件号</label>
							<div class="layui-input-inline">
								<input type="text" name="IDNumber" onblur="idFlag(1)" id="IDNumber" onchange="clearRoomInfo();" autocomplete="off" class="layui-input">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label require">电话</label>
							<div class="layui-input-inline">
								<input type="tel" name="phone" onblur="idFlag(2)"  id="phone" autocomplete="off"  onchange="clearRoomInfo();"  lay-verify="required" class="layui-input">
							</div>
						</div>

						<div class="layui-inline fr">
							<!--<a class="layui-btn layui-btn-primary " id="readCre">读取证件</a>-->
							<a class="layui-btn layui-btn-warm" onclick="clearData()">清除资料</a>
						</div>

					</div>
				</div>

			</div>
		</section>
		<section class="border-e6 mg10 pd10">
			<p class="border-e6 order-title">订单信息</p>
			<div class="layui-form-item layui-form">
				<div class="layui-inline" style="padding-left: 20px;">
					<input type="checkbox" name="" title="合作机构" lay-skin="primary" lay-filter="hzjg">
					<span style="background: #ccc;width: 200px;height: 45px;line-height: 45px;"></span>
				</div>
				<div class="layui-inline channelSelect layui-hide" >
					<select id="channelSelect" lay-filter="floor" lay-search>
					</select>
				</div>
				<div class="layui-input-inline" style="float: none">
					<input type="text" name="OTA"id="ota" autocomplete="off" class="layui-input" placeholder="OTA">
				</div>
			</div>
			<div class="pd20  layui-form layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label">入住方式</label>
					<div class="layui-input-inline" style="width:auto;">
						<input type="radio" name="checkType" value="day" title="全天房" checked="">
						<input type="radio" name="checkType" value="hour" title="钟点房">
						<input type="radio" name="checkType" value="free" title="免费房">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label">接单员</label>
					<div class="layui-input-inline">
						<input type="text" name="clerkOrderingName" id="clerkOrderingName" autocomplete="off" class="layui-input">
					</div>
				</div><br>
				<div class="layui-inline">
					<label class="layui-form-label">客源</label>
					<div class="layui-input-inline">
						<input type="text" value="散客 " name="channel" id="channel" readonly="" style="background: #eee;" autocomplete="off" class="layui-input">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label">渠道</label>
					<div class="layui-input-inline">
						<input type="text" name="channel1" id="channel1" value="预约入住" readonly="" style="background: #eee;" autocomplete="off" class="layui-input">
					</div>
				</div>

				<br>

				<div class="layui-inline ">
					<label class="layui-form-label">入住时间</label>
					<div class="layui-input-inline">
						<input type="text" class="layui-input" name="startTime" id="startTime"  readonly>
					</div>
				</div>
				<div class="layui-inline typea ">
					<label class="layui-form-label">离店时间</label>
					<div class="layui-input-inline">
						<input type="text" class="layui-input" name="leaveDate1" id="leaveDate1"  readonly>
					</div>
				</div>

				<div class="layui-inline typea">
					<label class="layui-form-label">共计</label>
					<div class="layui-input-inline" >
						<input  style="display: inline-block;width: 50px" readonly type="number" name="dayNumber1" id="days1" autocomplete="off" class="layui-input"><span style="">天</span>
					</div>
				</div>
				<div class="layui-inline typeb layui-hide">
					<label class="layui-form-label">共计</label>
					<div class="layui-input-inline" >
						<input  style="display: inline-block;width: 50px" readonly type="number" name="dayNumber2" value="4" id="days2" autocomplete="off" class="layui-input"><span style="">小时</span>
					</div>
				</div>
			</div>
		</section>
		<section class="border-e6 mg10 pd10">
			<p class="border-e6 order-title">房间信息<a class="fr" style="overflow: hidden;margin-right: 30px;font-size: 20px;">总房价:<span id="totalPrice">0</span>元</a></p>

			<table  id="test" lay-filter="fjxx"></table>
			<div>
				<a class="layui-btn" onclick="selectRoom()">选房</a>
				<a class="layui-btn" onclick="modifyPrice()">改价</a>
				<a class="layui-btn" onclick="remarks()">批量备注</a>

			</div>
		</section>
		<section style="padding: 20px;overflow: hidden;">
			<a class="layui-btn layui-btn-normal fr" style="margin: 0 20px;padding: 0 50px;" onclick="cancel();">取消</a>
			<button class="layui-btn layui-btn-normal fr" style="margin: 0 20px;padding: 0 50px;"  id="btnSave"  lay-submit=""  lay-filter="checksubmit">预定</button>
		</section>

	</div>
</form>

</body>

</html>
<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script type="text/html" id="barDemo">
	<!--<a class="layui-btn layui-btn-xs" lay-event="tonglai">同来</a>-->
	<!--<a class="layui-btn layui-btn-xs" lay-event="beizhu">备注</a>-->
	<!--<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="yichu">移除</a>-->
</script>
<script>
    var allChannel =[];
    var customer_source_before = "散客";//散客-渠道-会员
	var _channel = "";//直接入住-预约入住
    var element, laydate, form, $, layer, index,table,data=[],pickRoomTypeData;
    var state = {
        channel:2// 1电话入住  2步入 3网络
        ,roomType:1//1,全天房,2,钟点房，3,免费房
        ,channel:1// 散客-渠道-会员
        ,user:''
        ,tl:[]
        ,curtl:0
        ,selRow:[]
        ,totalPrice:0// 房价总金额
        ,idFlag:false//标记证件号是否查询到会员信息了
        ,orderNumber:0//订单号码
        ,hzjg:false//是否勾选合作机构
		,type:true//选房型和房间状态切换
    };
    var userInfo ={};//会员信息
    var sRooms = [];//已选房间信息
    var sRooms1= [];//已选房间信息//为了兼容房间选择和房型选择
    var customs = [];//同来人员信息
    var saleInfo = [];//折扣信息
    var currHZJG = "";
    var currSel = {//当前选房的过滤条件
        checkType:'day',//入住方式钟点房？全天? 免费？
        dayNumber:1,//入住天数
        memberRankId:0,//会员级别id
        cnId:0,//合作机构
        roomIds:getUrl("roomId"),
        ok:true
    };
    // clearModifyPrice();
    layui.use(['element', 'form', 'laydate', 'jquery', 'layer','table'], function() {
        element = layui.element,
            laydate = layui.laydate,
            form = layui.form,
            $ = layui.jquery,
            layer = layui.layer,
            table = layui.table;
        renderSelect("channelSelect", 'id', 'value', api.allChannel, form,function (str,rs) {allChannel = rs;});
        renderReport($)
        $(function () {
            setInterval(function () {
                getReport($)
            }, 60000)
        })

        form.on('checkbox(hzjg)', function(data) {
            if(data.elem.checked){
                state.hzjg = true;
                customer_source_before = document.getElementById("channel").value;

                document.getElementById("channel").value = $("#channelSelect").find("option:selected").text();

                $(".channelSelect").removeClass("layui-hide")
			}else{
                state.hzjg = false;
                document.getElementById("channel").value = customer_source_before;
                $(".channelSelect").addClass("layui-hide")
			}
        });
        form.on('select(floor)', function (data) {
            document.getElementById("channel").value = $("#channelSelect").find("option:selected").text();
        });
        renderSelect("certificateId",'id','value',api.certificate,form);//证件类型获取000

		try{
            $("#clerkOrderingName").val(JSON.parse( localStorage.User ).name)
        }catch (e){
		    console.info(e)
		}
        form.on('radio', function(data){//小时房全天房免费房
            if(data.value=="hour"){
                $(".typea").addClass("layui-hide")
                $(".typeb").removeClass("layui-hide")
            }else {
                $(".typeb").addClass("layui-hide")
                $(".typea").removeClass("layui-hide")
            }
            if(currSel.checkType==data.value){

			}else{
                currSel.checkType=data.value;
                state.roomType=data.value;
                clearRoomInfo();
			}


        });

        form.on('submit(checksubmit)', function(data) {

            var d = data.field;
            if(d.checkType=="hour"){

            }else{
                if(d.leaveDate1==''){
                    layer.alert("离店时间不能为空")
                    return false;
                }
                d.checkOutTime = d.leaveDate1.replace(/-/, "/").replace(/-/, "/");//离店时间(小时房的话，把入住时间和小时数相加)
                d.dayCount = d.dayNumber1//共住天数

            }
            d.orderType = "subscribe";//渠道
            d.IDNumberType = d.certificateId;//证件类型的id

			d.checkTime = 	d.startTime.replace(/-/, "/").replace(/-/, "/");//入住时间
            delete d.startTime;
            delete d.leaveDate1;
            delete  d.dayNumber1;
            delete  d.dayNumber2;
            delete  d.certificateId;
            d.type = "roomReservation";
            var urll = api.reserveRoom;

			if(state.hzjg)d.memberIdOrOrganizationId = document.getElementById("channelSelect").value;

			for(var i=0;i<sRooms.length;i++ ){
			    if(d.checkType=="hour"){
                    sRooms[i]['everydayRoomPriceBOS'] = getFormTime(sRooms[i].hourRoomPrice,d.dayCount)
				}else if(d.checkType=="free"){
                    sRooms[i]['everydayRoomPriceBOS'] = getFormTime(0,d.dayCount)
				}else{
                    sRooms[i]['everydayRoomPriceBOS'] = getFormTime(sRooms[i].basicPrice,d.dayCount,sRooms[i].id)
				}
                sRooms[i]['roomTypeId'] = sRooms[i]['id']
			}

            // debugger;;
            d.OrderChildJSON =  JSON.stringify(sRooms);
				console.info(d)
            // return false;
            var index = layer.load(1,{time:10*1000});
            $.ajax({
                data: d,
                type: "POST",
                dataType: "JSON",
                url: urll,
                beforeSend: function () {
                    $("#btnSave").addClass('layui-btn-disabled');
                },
                complete: function () {
                    layer.close(index);
                    $("#btnSave").removeClass('layui-btn-disabled');
                },
                success: function (rs) {
                    layer.close(index);
                    if(rs.success){
                        layer.alert("预定成功",function () {
                            location.href = HOME;
                        })
                    }else{
                        layer.alert("预定失败"+rs.errMsg)
                    }
                }
            });

            return false;
        });
        $("#readCre").on("click",function () {
            return;
            // var _i = layer.load();
            var urll = api.getMemberByCre;//直接入住查询会员信息
            var url1 = api.yueCheckIn;//预约入住信息查询
            var IDNumber = document.getElementById("IDNumber").value;
            querySaleInfo(IDNumber)
            if(IDNumber==''){
                layer.msg('证件号码不能为空', {icon: 2,shift:6});
                return;
            }else{
                if(state.channel==1){

                    //网络入住
                    url1+="&certificateNumber="+IDNumber
                }else{
                    //步入
                    urll+=IDNumber
                }

            }
            $.getJSON(urll+"&random="+Date.now(),function (rs) {
                if(!rs.success&&state.channel==1){
                    layer.alert("没有查询到预约信息")
                    return ;
                }
                if(state.channel==1){
                    // renderSchedule(rs.data)
                }else{
                    if(!rs.success)  return;
                    state.channel = 2;
                    if(userInfo.memberRank){
                        $("#channel").val(userInfo.memberRank);
                    }else{
                        setTimeout(function () {
                            $("#channel").val(userInfo.memberRank);
                        },1000)
                    }
                    renderUserInfo(rs.data)
                    form.render();
                }

            })
        })
        //监听工具条
        table.on('tool(fjxx)', function(obj){
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象

            // sessionStorage.selectedRoomList = JSON.stringify(selectedRoomList)
            if(layEvent === 'tonglai'){

                layer.open({
                    area: ['1000px', '420px'],
                    type: 2,
                    content: "iframe_together.html?roomid="+data.roomId+"&a="+Date.now(),
                    title: "同来宾客"


                })
            } else if(layEvent === 'yichu'){ //删除
                layer.confirm('真的删除行么', function(index){
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    removeRooms(obj.data.roomId)

                });
            } else if(layEvent === 'beizhu'){ //备注
                //do something

                //同步更新缓存对应的值
                obj.update({
                    username: '123'
                    ,title: 'xxx'
                });
            }
        });

        tableObj = table.render({
            elem: '#test'
            , method: 'POST'
            , data: data
            , limit: 10000
            ,cols: [[
                {type:'checkbox'}
                ,{field:'roomNum', title: '房号',}
                ,{field:'name',  title: '房型'}

                ,{

                    title: '房价',

                    align: 'center',
                    templet: function (data) {
                        var price = data.basicPrice;

                        if($("input[name='checkType']:checked").val()=="hour")price = data.hourRoomPrice;
                        if($("input[name='checkType']:checked").val()=="free")price = 0;
                        return price;
                    }
                }

                ,{field:'remark',  title: '备注',}
                ,{title:'操作',toolbar:'#barDemo',width:160 }
            ]]
            ,page: false
        });
        table.on('checkbox(fjxx)', function(obj){
            console.log(table.checkStatus('test').data);
            state.selRow = table.checkStatus('test').data;
        });
        laydate.render({
            elem: '#birthday',
        });
        laydate.render({
            elem: '#leaveDate1',//全天房和免费房离店时间
            min:0,
            format:'yyyy-MM-dd HH:mm:ss',
            done: function(value, date, endDate){
                if($("#startTime").val()==''){
                    clearTimeInfo();
                    layer.msg('请先选择入住时间', {icon: 2,shift:6});
                    return;
				}

				if(new Date($("#startTime").val()).getTime()>(new Date(value.split(" ")[0]).getTime()+21600000)){
                    clearTimeInfo();
                    layer.msg('入住和离店时间选择有误', {icon: 2,shift:6});
                    return;
				}

                var vv =  GetDateDiff($("#startTime").val(),value.split(" ")[0] + LEAVETIME);
                if(vv==0){
                    clearTimeInfo();
                    layer.msg('离店时间有误', {icon: 2,shift:6});
                    return;
                }
				updateTimeInfo(value);
            }
        });

        laydate.render({
            elem: '#startTime',
			type:"datetime",
            min:0,
            format:'yyyy-MM-dd HH:mm:ss',
            done: function(value, date, endDate){
                if(value.indexOf("00:00:00")>0){
					var a = value.split(" ")[0] + " 18:00:00";
					setTimeout(function () {
						$('#startTime').val(a);
					},100)
                }
                clearTimeInfo();
            }
        });

    });

    function par(v, vv) {
        $("#hzjg").val(vv)
        layer.close(index)
    }
    function changeDays(t){
        currSel.dayNumber = t.value;
        document.getElementById("leaveDate").value =
            DateToLStr(new Date(Date.now()+3600*1000*24*Number(t.value))).split(" ")[0] + LEAVETIME
        clearRoomInfo();
    }
    function selectRoom(){
       	var _leaveTime;

        if(document.getElementById("orderPlacer").value==''){
            layer.msg('姓名未填写', {icon: 2,shift:6});
            return;
        }
        if(document.getElementById("phone").value==''){
            layer.msg('手机号未填写', {icon: 2,shift:6});
            return;
        }
        if(document.getElementById("startTime").value==''){
            layer.msg('入住时间未填写', {icon: 2,shift:6});
            return;
        }
        if($("input[name='checkType']:checked").val()!="hour"){
            if(document.getElementById("leaveDate1").value==''){
                layer.msg('离店时间未填写', {icon: 2,shift:6});
                return;
			}
		}else{
            // debu
            _leaveTime = DateToLStr(new Date(new Date(document.getElementById("startTime").value).setHours(new Date(document.getElementById("startTime").value).getHours() + 4))).replace(/-/, "/").replace(/-/, "/");
		}
        var content = "leaveTime="+$("#leaveDate").val();


		var selectRoomData =  {
            checkTime:	document.getElementById("startTime").value.replace(/-/, "/").replace(/-/, "/"),//入住时间,
            endTime:_leaveTime?_leaveTime:document.getElementById("leaveDate1").value.replace(/-/, "/").replace(/-/, "/"),
            phone:document.getElementById("phone").value.trim(),
            roomAuxiliaryStatus:$("input[name='checkType']:checked").val()
		}
		localStorage.yyxf = JSON.stringify(selectRoomData);
        console.log(selectRoomData	)
        //询问框

        layer.confirm('选房型还是选房间？', {
            btn: ['房型','房间'] //按钮
        }, function(){
            if(sRooms.length==0||sRooms[0].roomNum==''){
				layer.closeAll('dialog');
				layer.open({
					area: ['820px', '520px'],
					type: 2,
					content: 'iframe_pick_room_type.html?vv='+Date.now(),
					title: "选房型"
				})
            }else{
                layer.confirm('选择房型将清除已选房间，继续选择？', function (index) {
                    sRooms = [];
                    customs = [];
                    calcPrice();
                    layer.closeAll('dialog');
                    layer.open({
                        area: ['820px', '520px'],
                        type: 2,
                        content: 'iframe_pick_room_type.html?vv=1&'+content,
                        title: "选房型"
                    })
                    layer.close(index);
                });
			}
        }, function(){
            if(sRooms.length==0||sRooms[0].roomNum!=''){
                layer.closeAll('dialog');
                layer.open({
                    area: ['820px', '520px'],
                    type: 2,
                    content: 'iframe_pick_room3.html?vv=1&'+content+"&random="+Date.now(),
                    title: "选房间"
                })
            }else{
                layer.confirm('选择房间将清除已选房型，继续选择？', function (index) {
                    sRooms = [];
                    customs = [];
                    calcPrice();
                    layer.closeAll('dialog');
                    layer.open({
                        area: ['820px', '520px'],
                        type: 2,
                        content: 'iframe_pick_room3.html?vv=1&'+content+"&random="+Date.now(),
                        title: "选房间"
                    })
                    layer.close(index);
                });
            }
        });

    }


    function remarks(){

        if(state.selRow.length==0){
            layer.msg("您还没有勾选房间");
            return;
        }
        layer.prompt({
            formType: 2,
            value: '',
            title: '备注修改',
        }, function(value, index, elem){

            eachReamrk(state.selRow,value)
            layer.close(index);
        });
    }
    function parSelectRoomType(v,t) {
        pickRoomTypeData = t;
        sRooms = [].concat.apply([],v)
        console.info("选房型获取了如下数据↓")
        console.info(sRooms)
        //setCustomInfo();
        calcPrice();
        dealChange();
    }
    function parSelectRoom(v,t) {
        pickRoomTypeData = t;
        sRooms1 = JSON.parse(JSON.stringify(v));
        sRooms = productRoomS(v);//处理房间数据，改成和房型数据统一
        console.info("选房间后获取了如下数据↓")
        console.info(sRooms)
        // setCustomInfo();
        calcPrice();
        dealChange();
    }
    function cancel(){
        sessionStorage.clear();
        // location.reload();
        location.href =HOME;
    }
    function parToget() {
        // tableObj.reload({data:JSON.parse(sessionStorage.selectedRoomList)})
        calcPrice();
    }
    function clearData() {
        sessionStorage.clear();
        location.reload();
    }
    function dealOneRoomOnePeople() {
        var d = sRooms[0];
        var c = findPeopleByRoomId(d.roomId)[0];
        var str='';
        str = d.roomId+"@"+d.name+"-"+c.certificateId+"-"+c.IDNumber+"-"+c.phone+"-"+nospace(c.address)+"-"+nospace(c.remark)  + "-" + (c.gender || 2);
        return str;
    }
    function nospace(v) {
        if(!v)return'无';
        if(v==null)return'无';
        if(v=='null')return'无';
        return v;
    }
    function dealOneRoomMulPeople() {
        var d = sRooms[0];
        var dd = findPeopleByRoomId(d.roomId);
        var c = dd[0];

        var str='';
        str = d.roomId+"@"+d.name+"-"+c.certificateId+"-"+c.IDNumber+"-"+c.phone+"-"+nospace(c.address)+"-"+nospace(c.remark)  + "-" + (c.gender || 2);
        var str1 = '';
        for(var i=1;i<dd.length;i++){
            str1 += "&"+dd[i].name+"-"+dd[i].certificateId+"-"+dd[i].IDNumber+"-"+dd[i].phone+"-"+nospace(dd[i].address)+"-"+nospace(dd[i].remark)  + "-" + (dd[i].gender || 2);
        }
        return str+str1;
    }
    function dealMulRoomMulPeople() {
        var d = sRooms;


        var str = '';
        for(var i=0;i<d.length;i++){
            var c = findPeopleByRoomId(d[i].roomId);
            str+=d[i].roomId;
            str+="@";
            for(var j=0;j<c.length;j++){

                str+=c[j].name;
                str+="-";
                str+=nospace(c[j].certificateId);
                str+="-";
                str+=nospace(c[j].IDNumber);
                str+="-";
                str+=nospace(c[j].phone);
                str+="-";
                str+=nospace(c[j].address);
                str+="-";
                str+=nospace(c[j].remark);
                str += "-";
                str +=  (c[j].gender || 2);
                if(c.length==1){
                    str+=","
                }else if((c.length-1)!=j){
                    str+="&"
                }else{
                    str+=","
                }

            }
        }
        return str;
    }
    function setCustomInfo() {

        if(customs.length==0&&sRooms.length!=0){
            customs = [{
                name:'',
                certificateId:'',
                IDNumber:'',
                address:'',
                phone:'',
                remark:"",
                roomId:sRooms[0].roomId
            }]
        }
    }
    function  updateTable() {
        var d = sRooms,c = customs;
        // for(var i=0;i<d.length;i++){
        //     for(var j=0;j<c.length;j++){
        //         if(d[i].roomId==c[j].roomId){
        //             d[i].name = c[j].name;
        //             d[i].IDNumber = c[j].IDNumber;
        //             d[i].phone = c[j].phone;
        //             d[i].remark = c[j].remark;
        //             break;
        //         }
        //     }
        // }
        // console.info(d);
        tableObj.reload({data:JSON.parse(JSON.stringify(d))})
        state.selRow=[];
        // calcPrice();
        $("#totalPrice").text(state.totalPrice);

    }
    function removeRooms(id) {
        var d = sRooms;
        var dd = [];
        for(var i=0;i<d.length;i++){
            if(d[i].roomId!=id){
                dd.push(d[i]) ;
            }
        }
        sRooms=dd;
        calcPrice();
    }
    function checkPeopleNum() {
        var s = sRooms,c = customs;
        for(var i=0;i<s.length;i++){
            var f = true;
            for(var j=0;j<c.length;j++){
                if(s[i].roomId==c[j].roomId){
                    f = false;
                    if(c[j]['name']==''
                        ||c[j]['certificateId']==''
                        ||c[j]['phone']==''
                        ||c[j]['IDNumber']=='')
                        return [false,s[i].room]
                }
            }
            if(f){
                return [false,s[i].roomNum]
            }
        }
        return [true];

    }

    function findPeopleByRoomId(id) {
        var d = [];
        var c = customs;
        for(var i=0;i<c.length;i++){
            if(c[i].roomId==id)d.push(c[i])
        }
        return d;
    }

    function eachReamrk(arr,str) {
		var d = sRooms;
        for(var i=0;i<arr.length;i++){

            for(var j=0;j<d.length;j++){
                if(arr[i].random==d[j].random){
                    d[j].remark = str;
                    break;
                }
            }

        }
        calcPrice();
    }
    function querySaleInfo(v) {//查询该会员折扣信息
        $.getJSON(api.querySale+v+"&random="+Date.now(),function (rs) {
            if(rs.success){
                saleInfo = rs.data;
            }
        })
    }
    function calcPrice() {
        var checkType_ = $("input[name='checkType']:checked").val();

        var d = sRooms;
        var c = saleInfo;
        state.totalPrice = 0;
        // if(c.length==0)return;
        var days = 1;
        if(checkType_=="day"){
            days = Number($("#days1").val());
        }
        else if(checkType_=="hour"){
            days = 1;
        }else {
            days = 0;
		}
        for(var i=0;i<d.length;i++){

			if(checkType_=="day"){
                state.totalPrice+=(sRooms[i].basicPrice*days);
			} else {
                state.totalPrice+=(sRooms[i].hourRoomPrice*days);
			}
        }
        state.totalPrice = state.totalPrice.toFixed(0)
        updateTable()
    }
    //s=1证件号码，s=2手机号码
    function idFlag(s) {
        var v = $("#IDNumber").val().trim();
        var p = $("#phone").val().trim();
        if ( s == 2 ) {
            //如果根据证件号码没有查询到了会员信息
            if(p=='')return;
            $.getJSON(api.queryIdFlag + "&query=" + p+"&random="+Date.now(), function (rs) {

                if (rs.success&&rs.data.length==1) {

                    renderUserInfo(rs.data[0])
                    form.render();
                    layer.msg('成功获取会员信息', {icon: 1});
                }else{
                    userInfo = {};
                    $("#userLevel").text();
                    dealChange();
                }
            })

        } else{
            //如果还没有开始查询证件查询，开始查询
            if (v == '') return;
            $.getJSON(api.queryIdFlag + "&query=" + v+"&random="+Date.now(), function (rs) {
                if (rs.success&&rs.data.length==1) {


                    renderUserInfo(rs.data[0])
                    form.render();
                    state.idFlag = true;
                    layer.msg('成功获取会员信息', {icon: 1});
                } else {
                    state.idFlag = false;
                    userInfo = {};
                    $("#userLevel").text();
                    dealChange();
                }
            })

        }

    }
    function renderUserInfo(d) {
        var r = d;
        // querySaleInfo(r.IDNumber)
        userInfo = r;



            try{
                document.getElementById('orderPlacer').value = r['name'];
                document.getElementById('certificateId').value = r['certificateType'];
                document.getElementById('IDNumber').value = r['certificateNumber'];
                document.getElementById('phone').value = r['phone'];

                document.getElementById("userLevel").innerText=r['memberLevelName'];
                form.render();
                console.log(d);
            }catch (err){

            }

        if(!state.hzjg){
            state.channel = 2;
            customer_source_before = document.getElementById('channel').value;
            document.getElementById('channel').value = '会员';
        }
        dealChange();
    }

    function payHtml(v) {
        layer.open({
            area: ['520px', '320px'],
            type: 2,
            content: "iframe_pay.html?v="+v,
            title: "支付"
        })
    }
    function makeCard(v) {
        layer.open({
            area: ['520px', '320px'],
            type: 2,
            content: "iframe_makeCard.html",
            title: "制卡",
            end: function () {
                parent.location.href =  HOME;
            }
        })
    }

    function getIdName() {
        var a = [];
        var d = sRooms;
        for(var i=0;i<d.length;i++){
            var c = findPeopleByRoomId(d[i].roomId);
            for(var j=0;j<c.length;j++){
                a.push(c[j])
            }
        }
        sessionStorage.idandname = JSON.stringify(a);
    }
    function  clearTimeInfo() {
        document.getElementById("leaveDate1").value = "";
        document.getElementById("days1").value = "";
    }
    function updateTimeInfo(v) {
        if(state.roomType!=2){
            //全天房或者免费房
			$("#leaveDate1").val(v.split(" ")[0] + LEAVETIME);
            v.split(" ")[0] + LEAVETIME;
            document.getElementById("days1").value =
                GetDateDiff($("#startTime").val(),$("#leaveDate1").val());
            $(".typea").removeClass("layui-hide")
            $(".typeb").addClass("layui-hide")
		}else{
            // console.info($("#startTime").val(),v)
			//钟点房

            $(".typea").addClass("layui-hide")
            $(".typeb").removeClass("layui-hide")
		}
        clearRoomInfo();
    }
	function getIdsByRooms() {
		var str = sRooms[0].roomId;var d = sRooms;
		for(var i=1;i<d.length;i++){
		    str+=","+sRooms[i].roomId;
		}
		return str;
    }
    function clearRoomInfo() {
        sRooms = [];
        customs = [];
        calcPrice();
        localStorage.modifyPrice = '';
        dealChange()
        return;

    }

    function madeArr(arr) {
        //处理房间数据，按楼层分成二维数组
        var t = [];
        var l = 0
        for(var i=0;i<arr.length;i++){
            if(i==0){t.push([arr[i]]);continue}
            if(arr[i].houseTypeId==arr[i-1].houseTypeId){
                t[l].push(arr[i])
            }else{
                t.push([arr[i]]);
                l++;
            }
        }
        return t;
    }

    //处理选房条件发生变化的逻辑
    function dealChange() {
        return;
        if(sRooms.length==0)return;
		var ss = $("#startTime").val();
		var ee = $("#endTime").val();
		if(ss==''||ee=='')return;
        currSel.startTime = ss.replace(/-/, "/").replace(/-/, "/");
        currSel.checkType = state.roomType;
        if(state.hzjg){
            currSel.cnId=$("#channelSelect").val();
            delete currSel.memberRankId;
        } else if(userInfo.meLeval){
            currSel.memberRankId = userInfo.meLeval
            delete currSel.cnId;
        }else{
            delete currSel.cnId;
            delete currSel.memberRankId;
        }

        if(currSel.checkType==2){
            currSel.dayNumber = 1;
        }else{
            currSel.dayNumber = $("#days1").val();
        }


        if(sRooms[0].roomNum==''){
            currSel.msg = dealRoomInfo1();
        } else{
			var ids = [];
			for(var i=0;i<sRooms.length;i++){
				ids.push(sRooms[i].roomId)
			}
			currSel.roomIds = ids.join(",")
        }
        console.info(currSel)
        var index = layer.load(1,{time:10*1000});
        $.ajax({
            data: currSel,
            type: "POST",
            dataType: "JSON",
            url: '/room/sumOrderInfoAndOrederRoomType',
            success: function (rs) {
                layer.close(index);
                if (!rs.success) {
                    layer.alert(rs.errMsg)
                    currSel.ok = rs.errMsg;$("input[name=checkType][value=" + historystate + "]").prop('checked', true);
                    form.render();
                    return false;
                }else{
                    if(rs.data.roomInfo){
                        sRooms = rs.data.roomInfo;
					}else{
                        var tt = rs.data.roomTypeInfo;
                        for(var i=0;i<sRooms.length;i++){
                            for(var j=0;j<tt.length;j++){
                                if(sRooms[i].houseTypeId == tt[j].houseTypeId){
                                    sRooms[i].price=tt[j].price;
                                    break;
								}
							}
						}
					}

                    setCustomInfo();
                    calcPrice();
                    $("#totalPrice").text(rs.data.sumPrice);
                    currSel.ok = true;
                }
            }
        });
    }

    function dealRoomInfo() {
        var str = [];
        var r = sRooms;
        var c = customs;
        for(var i=0;i<r.length;i++ ){
            var flag = true;
            for(var j=0;j<c.length;j++){
                if(r[i].roomId==c[j].roomId){
                    str.push(
                        c[j].roomId + ' - ' + c[j].name +' - ' + c[j].IDNumber +' - ' +c[j].phone +" - " +c[j].remark +" - " +(c[j].gender|| 2)+' - '
					)
					flag = false;
					break;
				}

			}
            if(flag){
                str.push(
                    r[i].roomId + ' - - - - - 2 - '
                )
            }

		}

        return str.join(",")
    }

    function dealRoomType() {
        var str = [];
        var r = sRooms;
        var c = customs;
        for(var i=0;i<r.length;i++ ){
            var flag = true;
            for(var j=0;j<c.length;j++){
                if(r[i].roomId==c[j].roomId){
                    str.push(
                        r[i].houseTypeId + ' - ' + c[j].name +' - ' + c[j].IDNumber + " - "+ c[j].credentialNo +' - '+c[j].remark +" - " +(c[j].gender|| 2)+' - '
                    )
                    flag = false;
                    break;
                }
            }
            if(flag){
                str.push(
                    r[i].houseTypeId + ' - - - - - 2 - '
                )
            }

        }

        return str.join(",")
    }
    function dealRoomInfo1() {
        var str = [];
        var d = sRooms.sort(compare("houseTypeId"));
        var dd = madeArr(d);
        for(var i=0;i<dd.length;i++){
            str.push(dd[i][0].houseTypeId+"&"+dd[i].length)
        }
        return str.join(",")
    }



    function getFormTime(money,days,id) {
        var time = $("#startTime").val();
        if(new Date(time).getHours()<6){
            //如果6点之前，时间取前一天
            time = addDate(new Date(time),-1)
        }
		if(localStorage.modifyPrice==''){
            //未改价的情况下
			var arr = [
				{
					money:money,
					time:time
				}
			];

			for(var i=1;i<Number(days);i++){
				arr.push({
					money:money,
					time:addDate(new Date(time),i)
				})
			}
        }else{
			//改过价的情况下
            var _mp = JSON.parse(localStorage.modifyPrice);
            var arr = [];
            for(var i=0;i<_mp.length;i++){
                if(_mp[i]['id']==id){
                    for(var j in _mp[i]){
                        if(j==time.split(" ")[0]){
                            time = addDate(new Date(time),1)
                            arr.push({
                                money:_mp[i][j],
                                time:j
                            })
						}
					}
				}
                // debugger;
			}
		}
		return arr;
    }


    function getModifyPriceData(days) {//生产改价数据
        var time = $("#startTime").val();

        if(new Date(time).getHours()<6){
            //如果6点之前，时间取前一天
            time = addDate(new Date(time),-1)
        }

        var arr = [
            {
                // money:money,
                time:time.split(" ").length>1?time.split(" ")[0]:time
            }
        ];

        for(var i=1;i<Number(days);i++){
            arr.push({
                // money:money,
                time:addDate(new Date(time),i)
            })
        }
        return arr;
    }
	var aaa1 = [];//处理过改价格用的房间数据
    function productRoomType(){
        var temp = [];
        var days = getModifyPriceData($("#days1").val());
        if(aaa1.length==0){

			for(var i=0;i<sRooms.length;i++){
				if(temp.indexOf(sRooms[i].id) == -1 ){
					temp.push(sRooms[i].id);
					var newdata = JSON.parse(JSON.stringify(sRooms[i]));
					for(var j=0;j<days.length;j++){
						newdata[days[j]['time']] = newdata['basicPrice']
						newdata['roomTypeId'] = newdata['id']
						newdata['roomTypeName'] = newdata['name']
					}
					aaa1.push(newdata)
				}
			}

            localStorage.modifyPrice = JSON.stringify(aaa1);
        }
    }

    function productRoomS(v) {//处理房间数据格式，改成和房型的格式一致/参数是已经选择的房间数据
        // basicPrice: 350
        // count: 8
        // hotelId: 1
        // hourRoomPrice: 60
        // id: 2
        // name: "标间"
        // random: 0.166297682505395
        // roomNum: ""
		var rs = [];
		for(var i=0;i<v.length;i++){
		    var td = JSON.parse(JSON.stringify(v[i]));
            v[i]['roomId'] = td.id;
            v[i]['id'] = td.roomTypeId;
            v[i]['name'] = td.roomType;
            v[i]['roomNum'] = td.roomName;
            v[i]['random'] = td.id;;
            rs.push(v[i]);
		}
		return rs;

    }
</script>
<script src="js/modifyPrice.js" type="text/javascript" charset="utf-8"></script>