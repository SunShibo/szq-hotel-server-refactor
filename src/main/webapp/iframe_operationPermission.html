<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>权限</title>
    <script src="js/loadcss.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
<form class="layui-form" lay-filter="permission" style="padding: 10px 0">
    <div class="layui-form-item">
        <label class="layui-form-label">酒店权限</label>
        <div class="layui-input-block" id="building"></div>
    </div>
    <div class="layui-form-item" id="name" style="display:none;">
        <label class="layui-form-label">姓名</label>
        <div class="layui-input-inline">
            <input type="text" name="name" placeholder="请输入姓名" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" id="phone" style="display:none;">
        <label class="layui-form-label">手机号码</label>
        <div class="layui-input-inline">
            <input type="text" name="phone" placeholder="请输入手机号码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" id="password" style="display:none;">
        <label class="layui-form-label">密码</label>
        <div class="layui-input-inline">
            <input type="password" name="password" placeholder="请输入密码" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">首页</label>
        <div class="layui-input-block">
            <input type="checkbox" name="homePermissions" value="1" title="首页权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">预定中心</label>
        <div class="layui-input-block">
            <!--<input type="checkbox" lay-filter="permission1" name="checkInPermissions" value="1" title="预订权限"-->
                   <!--lay-skin="primary">-->
            <input type="checkbox" name="roomOccupancy" value="1" title="预约入住权限" lay-skin="primary">
            <input type="checkbox" name="roomReservation" value="1" title="房间预订权限" lay-skin="primary">
            <input type="checkbox" name="systemDiagram" value="1" title="统计图表权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">直接入住</label>
        <div class="layui-input-block">
            <input type="checkbox" name="directly" value="1" title="直接入住权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">会员管理</label>
        <div class="layui-input-block">
            <!--<input type="checkbox" lay-filter="permission1" name="memberPermissions" value="1" title="会员管理权限"-->
                   <!--lay-skin="primary">-->
            <input type="checkbox" name="memberInformation" value="1" title="会员基本信息权限" lay-skin="primary">
            <input type="checkbox" name="membershipCard" value="1" title="会员卡信息权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">酒店管理</label>
        <div class="layui-input-block">
            <!--<input type="checkbox" lay-filter="permission1" name="hotelPermissions" value="1" title="酒店管理权限"-->
                   <!--lay-skin="primary">-->
            <input type="checkbox" name="roomManagement" value="1" title="房型管理权限" lay-skin="primary">
            <input type="checkbox" name="guestroomManagement" value="1" title="房间管理权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">订单管理</label>
        <div class="layui-input-block">
            <!--<input type="checkbox" lay-filter="permission1" name="orderPermissions" value="1" title="订单权限"-->
                   <!--lay-skin="primary">-->
            <input type="checkbox" name="roomorderManagement" value="1" title="客房订单权限" lay-skin="primary">
            <input type="checkbox" name="cashorderManagement" value="1" title="现金订单权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">报表</label>
        <div class="layui-input-block">
            <!--<input type="checkbox" lay-filter="permission1" name="formsPermissions" value="1" title="报表权限"-->
                   <!--lay-skin="primary">-->
            <input type="checkbox" name="liveReport" value="1" title="在住报表权限" lay-skin="primary">
            <input type="checkbox" name="predepartureStatement" value="1" title="预离店报表权限" lay-skin="primary">
            <input type="checkbox" name="managementDaily" value="1" title="管理层日报表" lay-skin="primary">
            <input type="checkbox" name="detailsbankReceiptentry" value="1" title="收银入账明细报表" lay-skin="primary">
            <input type="checkbox" name="operatingIncome" value="1" title="营业收入报表" lay-skin="primary">
            <input type="checkbox" name="managerDaily" value="1" title="经理日报表" lay-skin="primary">
            <input type="checkbox" name="cashierAlways" value="1" title="收银汇总报表" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">设置</label>
        <div class="layui-input-block">
            <!--<input type="checkbox" lay-filter="permission1" name="setPermissions" value="1" title="设置权限"-->
                   <!--lay-skin="primary">-->
            <input type="checkbox" name="hotelmanger" value="1" title="酒店设置权限" lay-skin="primary">
            <input type="checkbox" name="permissions" value="1" title="权限设置权限" lay-skin="primary">
            <input type="checkbox" name="shiftsSetting" value="1" title="班次设置权限" lay-skin="primary">
            <input type="checkbox" name="changesinReserves" value="1" title="备用金增减权限" lay-skin="primary">
            <input type="checkbox" name="memberdiscountSetting" value="1" title="会员折扣设置权限" lay-skin="primary">
            <input type="checkbox" name="channeldiscountSetting" value="1" title="渠道折扣设置权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">交班</label>
        <div class="layui-input-block">
            <!--<input type="checkbox" lay-filter="permission1" name="handPermissions" value="1" title="交班权限"-->
                   <!--lay-skin="primary">-->
            <input type="checkbox" name="includingtheInvoicing" value="1" title="交班结账权限" lay-skin="primary">
            <input type="checkbox" name="logRecords" value="1" title="交班记录权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品交易</label>
        <div class="layui-input-block">
            <input type="checkbox" name="productPermissions" value="1" title="商品交易权限" lay-skin="primary">
        </div>
    </div>
    <div class="layui-input-block" style="position: fixed; right: 20px; bottom: 20px;">
        <button class="layui-btn" lay-submit="" lay-filter="formData">生效</button>
        <button type="button" class="layui-btn layui-btn-primary" id="back">取消</button>
    </div>
</form>
<script src="js/loadjs.js" type="text/javascript" charset="utf-8"></script>
<script>
    layui.use(['form', 'jquery'], function () {
        var form = layui.form, $ = layui.$, state = '', len = 0, hotelData = {}, id = 0;

        $(function () {
            state = parseInt(getUrl('state'));
            checkBoxData();
        });

        //取消按钮
        $('#back').on('click', function () {
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
        });

        //酒店数据绑定
        function checkBoxData() {
            $.ajax({
                url: api.hotelInfo,
                type: 'POST',
                dataType: 'json',
                success: function (data) {
                    hotelData = data.data;
                    setCheckBoxData(data.data);
                    if (!state) {//编辑
                        id = getUrl('id');
                        permissionInfo(id);
                    } else {
                        $('#name').css('display', 'block');
                        $('#password').css('display', 'block');
                        $('#phone').css('display', 'block');
                    }
                }
            })
        }

        //监听查询按钮提交
        form.on('submit(formData)', function (data) {
            var obj = formatData(data.field);
            if (state) {//新增
                $.ajax({
                    url: api.adminAdd,
                    type: 'POST',
                    dataType: 'json',
                    data: obj,
                    success: function (data) {
                        console.log(data);
                        if (data.success) {
                            showMsg('添加成功', 1, true);
                        } else {
                            showMsg(data.errMsg, 2, false);
                        }
                    }
                })
            } else {//编辑
                $.ajax({
                    url: api.adminUpdate,
                    type: 'POST',
                    dataType: 'json',
                    data: obj,
                    success: function (data) {
                        if (data.success) {
                            showMsg('修改成功', 1, true);
                        } else {
                            showMsg(data.errMsg, 2, false);
                        }
                    }
                })
            }
            return false;
        });

        function formatData(data) {
            var obj = {}, arr = [], checkOption;
            //个人信息
            if (!state) {
                obj.id = id;
            } else {
                if (!data.name || !data.password || !data.phone) {
                    showMsg('输入不能有空', 2, false);
                    return false;
                }
                obj.name = data.name;
                obj.password = data.password;
                obj.phoneNumber = data.phone;
            }
            //酒店权限
            for (var i = 0; i < len; i++) {
                if (data['checkBox' + i]) {
                    arr.push(hotelData[i].id);
                }
            }
            obj.hotelId = arr.join(',');
            //菜单权限
            //首页
            obj.homePermissions = data.homePermissions == '1' ? 1 : 0;
            obj.directly = data.directly == '1' ? 1 : 0;//直接入住

            //入住
            obj.roomOccupancy = data.roomOccupancy == '1' ? 1 : 0;
            obj.roomReservation = data.roomReservation == '1' ? 1 : 0;
            obj.systemDiagram = data.systemDiagram == '1' ? 1 : 0;
            if (obj.roomOccupancy || obj.roomReservation || obj.systemDiagram) {
                checkOption = 1;
            } else {
                checkOption = 0;
            }
            obj.checkInPermissions = checkOption == '1' ? 1 : 0;

            //会员
            obj.memberInformation = data.memberInformation == '1' ? 1 : 0;
            obj.membershipCard = data.membershipCard == '1' ? 1 : 0;
            if (obj.memberInformation || obj.membershipCard) {
                checkOption = 1;
            } else {
                checkOption = 0;
            }
            obj.memberPermissions = checkOption == '1' ? 1 : 0;

            //订单
            obj.roomorderManagement = data.roomorderManagement == '1' ? 1 : 0;
            obj.cashorderManagement = data.cashorderManagement == '1' ? 1 : 0;
            if (obj.roomorderManagement || obj.cashorderManagement) {
                checkOption = 1;
            } else {
                checkOption = 0;
            }
            obj.orderPermissions = checkOption ? 1 : 0;

            //设置
            obj.hotelmanger = data.hotelmanger == '1' ? 1 : 0;
            obj.permissions = data.permissions == '1' ? 1 : 0;
            obj.shiftsSetting = data.shiftsSetting == '1' ? 1 : 0;
            obj.changesinReserves = data.changesinReserves == '1' ? 1 : 0;
            obj.memberdiscountSetting = data.memberdiscountSetting == '1' ? 1 : 0;
            obj.channeldiscountSetting = data.channeldiscountSetting == '1' ? 1 : 0;
            if (obj.hotelmanger || obj.permissions || obj.shiftsSetting || obj.changesinReserves || obj.memberdiscountSetting || obj.channeldiscountSetting) {
                checkOption = 1;
            } else {
                checkOption = 0;
            }
            obj.setPermissions = checkOption ? 1 : 0;

            //酒店
            obj.roomManagement = data.roomManagement == '1' ? 1 : 0;
            obj.guestroomManagement = data.guestroomManagement == '1' ? 1 : 0;
            if (obj.roomManagement || obj.guestroomManagement) {
                checkOption = 1;
            } else {
                checkOption = 0;
            }
            obj.hotelPermissions = checkOption ? 1 : 0;

            //报表
            obj.liveReport = data.liveReport == '1' ? 1 : 0;
            obj.predepartureStatement = data.predepartureStatement == '1' ? 1 : 0;
            obj.managementDaily = data.managementDaily == '1' ? 1 : 0;
            obj.detailsbankReceiptentry = data.detailsbankReceiptentry == '1' ? 1 : 0;
            obj.operatingIncome = data.operatingIncome == '1' ? 1 : 0;
            obj.managerDaily = data.managerDaily == '1' ? 1 : 0;
            obj.cashierAlways = data.cashierAlways == '1' ? 1 : 0;
            if (obj.liveReport || obj.predepartureStatement || obj.managementDaily || obj.detailsbankReceiptentry || obj.operatingIncome || obj.managerDaily || obj.cashierAlways) {
                checkOption = 1;
            } else {
                checkOption = 0;
            }
            obj.formsPermissions = checkOption ? 1 : 0;

            //交班
            obj.includingtheInvoicing = data.includingtheInvoicing == '1' ? 1 : 0;
            obj.logRecords = data.logRecords == '1' ? 1 : 0;
            if (obj.includingtheInvoicing || obj.logRecords) {
                checkOption = 1;
            } else {
                checkOption = 0;
            }
            obj.handPermissions = checkOption ? 1 : 0;

            //商品交易
            obj.productPermissions = data.productPermissions == '1' ? 1 : 0;
            return obj;
        }

        // //checkBox选中事件
        // form.on('checkbox(permission1)', function (data) {
        //     var index = $(data.elem).parent().data('id'), domObj = $(".layui-input-block[data-id=" + index + "] input");
        //     if (!data.elem.checked) {
        //         console.log('取消选中了←←←←');
        //         var len = domObj.length;
        //         domObj.prop('checked', '');
        //         form.render('checkbox');
        //     }
        // });


        //编辑回显信息
        function permissionInfo(id) {
            $.ajax({
                url: api.adminQuery,
                type: 'POST',
                dataType: 'json',
                data: {
                    id: id
                },
                success: function (data) {
                    if(!data.success){
                        showMsg(data.errMsg, 2, false);
                        return;
                    }
                    setValue(data.data);
                }
            })
        }

        //编辑设置回显信息
        function setValue(data) {
            if (data.admin === 1) {//判断是否是超级管理员
                $("input[type='checkbox']").prop('checked', true).attr('disabled', true);
                form.render('checkbox');
            } else {
                var obj = {}, arr = data.hotelId.split(',');
                //循环酒店权限
                for (var i = 0, len = arr.length; i < len; i++) {
                    if (hotelData[i].id === parseInt(arr[i])) {
                        obj['checkBox' + i] = true;
                    }
                }
                //循环菜单权限
                for(var item in data){
                    obj[item] = data[item];
                }
                //表单初始赋值
                form.val('permission', obj)
            }
        }

        //下拉框数据
        function setCheckBoxData(data) {
            len = data.length;
            for (var i = 0; i < len; i++) {
                var div = '<input type="checkbox" name="checkBox' + i + '" value="1" title="' + data[i].name + '" lay-skin="primary">';
                $('#building').append(div);
            }
            form.render('checkbox');
        }
    });
</script>
</body>
</html>