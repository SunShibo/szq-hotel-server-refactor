<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 【用户】 -->
<mapper namespace="com.szq.hotel.dao.OrderDAO">

    <!-- 添加主订单 -->
    <insert id="addOrder" parameterType="com.szq.hotel.entity.bo.OrderBO" useGeneratedKeys="true"
            keyProperty="id">
        insert into hm_order
        (order_placer,order_number,check_type,check_time,
        check_out_time,day_count,phone,ID_number,
        ID_number_type,order_type,clerk_ordering_name,
        clerk_ordering_id,members_id,
        memberId_or_organizationId,total_price,create_time,hotel_id)
        values
        (#{orderPlacer},#{orderNumber},#{checkType},
        #{checkTime},#{checkOutTime},#{dayCount},#{phone},#{IDNumber},
        #{IDNumberType},#{orderType},
        #{clerkOrderingName},#{clerkOrderingId},#{membersId},
        #{memberIdOrOrganizationId},#{totalPrice},now(),#{hotelId})
    </insert>

    <!-- 添加子订单 -->
    <insert id="addOrderChild" parameterType="com.szq.hotel.entity.bo.OrderChildBO" useGeneratedKeys="true"
            keyProperty="id">
        insert into hm_order_child set
        order_id=#{orderId},
        order_state=#{orderState},
        remark=#{remark},
        <if test="roomId!=null and roomId!=''">
            room_id=#{roomId},
        </if>
        room_type_id=#{roomTypeId},
        al_room_code=#{alRoomCode}

    </insert>

    <!-- 修改子订单信息 -->
    <update id="updOrderChild" parameterType="com.szq.hotel.entity.bo.OrderChildBO">
        update hm_order_child
        <set>
            <if test="orderId!=null and orderId!=''">
                order_id=#{orderId},
            </if>
            <if test="startTime!=null and startTime!=''">
                start_time=#{startTime},
            </if>
            <if test="endRime!=null and endRime!=''">
                end_time=#{endRime},
            </if>
            <if test="payCashNum!=null and payCashNum!=''">
                pay_cash_num=#{payCashNum},
            </if>
            <if test="otherPayNum!=null and otherPayNum!=''">
                other_pay_num=#{otherPayNum},
            </if>
            <if test="roomRate!=null and roomRate!=''">
                room_rate=#{roomRate},
            </if>
            <if test="otherRate!=null and otherRate!=''">
                other_rate=#{otherRate},
            </if>
            <if test="timeoutRate!=null and timeoutRate!=''">
                timeout_rate=#{timeoutRate},
            </if>
            <if test="freeRateNum!=null and freeRateNum!=''">
                free_rate_num=#{freeRateNum},
            </if>
            <if test="order_state!=null and order_state!=''">
                order_state=#{orderState},
            </if>
            <if test="practicalDepartureTime!=null and practicalDepartureTime!=''">
                practical_departure_time=#{practicalDepartureTime},
            </if>
            <if test="remark!=null and remark!=''">
                remark=#{remark},
            </if>
            <if test="roomId!=null and roomId!=''">
                room_id=#{roomId},
            </if>
            <if test="roomTypeId!=null and roomTypeId!=''">
                room_type_id=#{roomTypeId},
            </if>
            <if test="alRoomCode!=null and alRoomCode!=''">
                al_room_code=#{alRoomCode},
            </if>
            <if test="hotelId!=null and hotelId!=''">
                hotel_id=#{hotelId},
            </if>
            <if test="nightAuditorState!=null and nightAuditorState!=''">
                night_auditor_state=#{nightAuditorState},
            </if>
            <if test="printState!=null and printState!=''">
                print_state=#{printState}
            </if>
        </set>
        where id=#{id}
    </update>



    <!--订单列表-->
    <select id="queryOrderList"  parameterType="com.szq.hotel.entity.param.OrderParam"    resultType="com.szq.hotel.entity.bo.OrderListBO"  >
        SELECT child.id ,der.check_time ,der.check_out_time ,room.room_name ,type.room_type_name ,
        der.order_placer,der.phone ,der.order_type ,der.OTA ,der.channel,der.check_type,
        child.remark,child.order_state
        FROM hm_order der LEFT JOIN hm_order_child child ON der.id=child.order_id
        INNER JOIN hm_room_type type ON type.id=child.room_type_id  INNER JOIN  hm_room room ON room.id=child.room_id
        <where>
            <if test="hotelId!=null" > der.hotel_id=#{hotelId} </if>
            <if test="orderState!=null and orderState!=''" > and  child.order_state=#{orderState} </if>
            <if test="admissionsStartTime!=null and admissionsEndTime!=null" > and  der.check_time  BETWEEN  #{admissionsStartTime}  and #{admissionsEndTime} </if>
            <if test="departureStartTime!=null and departureEndTime!=null" > and  der.check_out_time  BETWEEN  #{departureStartTime}  and #{departureEndTime} </if>
            <if test="roomName!=null and roomName!=''" > and  room.room_name =#{roomName}</if>
            <if test="checkType!=null and checkType!=''" > and  der.check_type =#{checkType}</if>
            <if test="orderPlacer!=null and orderPlacer!=''" > and  der.order_placer  LIKE  '%${orderPlacer}%'</if>
            <if test="phone!=null and phone!=''" > and  der.phone  LIKE  '%${phone}%'</if>
            <if test="roomTypeId!=null " > and  child.room_type_id  =#{roomType} </if>
            <if test="roomName!=null and roomName!='' " > and  room.room_name   LIKE  '%${roomName}%' </if>
            <if test="channel!=null and channel!=''" > and  der.channel  LIKE  '%${channel}%' </if>
            <if test="OTA!=null and OTA!=''" > and  der.OTA  LIKE  '%${OTA}%' </if>
        </where>

        <include refid="orderLimit" />
    </select>

    <!--找查首日房价-->
    <select id="queryUnitPrice" parameterType="java.lang.Integer"  resultType="java.math.BigDecimal" >
        SELECT  money  FROM `hm_everyday_room_price` where order_child_id =#{id}  limt 0,1
    </select>

    <sql id="orderLimit">
        limit #{pageNo},#{pageSize}
    </sql>
</mapper>